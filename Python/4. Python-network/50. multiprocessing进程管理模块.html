<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>50. multiprocessing进程管理模块 | MSG</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="在追寻技术的同时享受生活">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.d65bef42.js" as="script"><link rel="preload" href="/assets/js/2.2249178e.js" as="script"><link rel="preload" href="/assets/js/116.ea3cfdfb.js" as="script"><link rel="prefetch" href="/assets/js/10.4785e2e5.js"><link rel="prefetch" href="/assets/js/100.33fceff2.js"><link rel="prefetch" href="/assets/js/101.62e1e5d4.js"><link rel="prefetch" href="/assets/js/102.8551fe71.js"><link rel="prefetch" href="/assets/js/103.47754d79.js"><link rel="prefetch" href="/assets/js/104.4adf114f.js"><link rel="prefetch" href="/assets/js/105.6206a08a.js"><link rel="prefetch" href="/assets/js/106.1c4561f3.js"><link rel="prefetch" href="/assets/js/107.e1531a5a.js"><link rel="prefetch" href="/assets/js/108.c637743a.js"><link rel="prefetch" href="/assets/js/109.3f150913.js"><link rel="prefetch" href="/assets/js/11.bd8ec7a6.js"><link rel="prefetch" href="/assets/js/110.088c1ac3.js"><link rel="prefetch" href="/assets/js/111.66d8d491.js"><link rel="prefetch" href="/assets/js/112.231663ee.js"><link rel="prefetch" href="/assets/js/113.a38bc531.js"><link rel="prefetch" href="/assets/js/114.e165daea.js"><link rel="prefetch" href="/assets/js/115.994b087a.js"><link rel="prefetch" href="/assets/js/117.7be5e4f3.js"><link rel="prefetch" href="/assets/js/118.ebb58ddb.js"><link rel="prefetch" href="/assets/js/119.90018646.js"><link rel="prefetch" href="/assets/js/12.0d8f43df.js"><link rel="prefetch" href="/assets/js/120.bb5be863.js"><link rel="prefetch" href="/assets/js/121.3d1db670.js"><link rel="prefetch" href="/assets/js/122.d29ed1b2.js"><link rel="prefetch" href="/assets/js/123.38cc4704.js"><link rel="prefetch" href="/assets/js/124.cc8549d4.js"><link rel="prefetch" href="/assets/js/125.6ee3e9c8.js"><link rel="prefetch" href="/assets/js/126.48710eba.js"><link rel="prefetch" href="/assets/js/127.d7a1fd83.js"><link rel="prefetch" href="/assets/js/128.e5017f6b.js"><link rel="prefetch" href="/assets/js/129.4c33e121.js"><link rel="prefetch" href="/assets/js/13.2dbde7aa.js"><link rel="prefetch" href="/assets/js/130.cda66247.js"><link rel="prefetch" href="/assets/js/131.ad76f669.js"><link rel="prefetch" href="/assets/js/132.aca88758.js"><link rel="prefetch" href="/assets/js/133.a1cf5903.js"><link rel="prefetch" href="/assets/js/134.b1386377.js"><link rel="prefetch" href="/assets/js/135.94edcf53.js"><link rel="prefetch" href="/assets/js/136.24be4170.js"><link rel="prefetch" href="/assets/js/137.db57772e.js"><link rel="prefetch" href="/assets/js/138.dc67bcaa.js"><link rel="prefetch" href="/assets/js/139.5453d1f6.js"><link rel="prefetch" href="/assets/js/14.2187dbf4.js"><link rel="prefetch" href="/assets/js/140.938e5c07.js"><link rel="prefetch" href="/assets/js/141.99c7cf2c.js"><link rel="prefetch" href="/assets/js/142.428e3958.js"><link rel="prefetch" href="/assets/js/143.68b01530.js"><link rel="prefetch" href="/assets/js/144.f67389cc.js"><link rel="prefetch" href="/assets/js/145.d952a130.js"><link rel="prefetch" href="/assets/js/146.b933dcad.js"><link rel="prefetch" href="/assets/js/147.2d8e4c0a.js"><link rel="prefetch" href="/assets/js/148.6d76ac94.js"><link rel="prefetch" href="/assets/js/149.6b4d6378.js"><link rel="prefetch" href="/assets/js/15.a53b356c.js"><link rel="prefetch" href="/assets/js/150.5bf39cb4.js"><link rel="prefetch" href="/assets/js/151.17af677c.js"><link rel="prefetch" href="/assets/js/152.7f1c2792.js"><link rel="prefetch" href="/assets/js/153.98dd0727.js"><link rel="prefetch" href="/assets/js/154.eb44bf23.js"><link rel="prefetch" href="/assets/js/155.5a9840ea.js"><link rel="prefetch" href="/assets/js/156.7ba01fd0.js"><link rel="prefetch" href="/assets/js/157.2296a048.js"><link rel="prefetch" href="/assets/js/158.6bb1f699.js"><link rel="prefetch" href="/assets/js/159.073bb8df.js"><link rel="prefetch" href="/assets/js/16.cef7bf44.js"><link rel="prefetch" href="/assets/js/160.25a837f9.js"><link rel="prefetch" href="/assets/js/161.93d886a1.js"><link rel="prefetch" href="/assets/js/162.5d2714b2.js"><link rel="prefetch" href="/assets/js/17.96f36904.js"><link rel="prefetch" href="/assets/js/18.fd04b310.js"><link rel="prefetch" href="/assets/js/19.3e1377d1.js"><link rel="prefetch" href="/assets/js/20.ac195ac8.js"><link rel="prefetch" href="/assets/js/21.c2d7729c.js"><link rel="prefetch" href="/assets/js/22.dd8c621b.js"><link rel="prefetch" href="/assets/js/23.ad7d0350.js"><link rel="prefetch" href="/assets/js/24.8559c4c3.js"><link rel="prefetch" href="/assets/js/25.783a8116.js"><link rel="prefetch" href="/assets/js/26.25e0e459.js"><link rel="prefetch" href="/assets/js/27.c0616e2a.js"><link rel="prefetch" href="/assets/js/28.30656c2e.js"><link rel="prefetch" href="/assets/js/29.2be5114c.js"><link rel="prefetch" href="/assets/js/3.be8c8f3b.js"><link rel="prefetch" href="/assets/js/30.230a74a7.js"><link rel="prefetch" href="/assets/js/31.760f46ad.js"><link rel="prefetch" href="/assets/js/32.c9533fef.js"><link rel="prefetch" href="/assets/js/33.dcacfb38.js"><link rel="prefetch" href="/assets/js/34.4370a466.js"><link rel="prefetch" href="/assets/js/35.bf299eea.js"><link rel="prefetch" href="/assets/js/36.336e435a.js"><link rel="prefetch" href="/assets/js/37.1d1d2eea.js"><link rel="prefetch" href="/assets/js/38.0d58b7d0.js"><link rel="prefetch" href="/assets/js/39.d43564ba.js"><link rel="prefetch" href="/assets/js/4.4a6cb970.js"><link rel="prefetch" href="/assets/js/40.bc4e4bde.js"><link rel="prefetch" href="/assets/js/41.b71231a5.js"><link rel="prefetch" href="/assets/js/42.9d46f400.js"><link rel="prefetch" href="/assets/js/43.50c5be69.js"><link rel="prefetch" href="/assets/js/44.60406e7f.js"><link rel="prefetch" href="/assets/js/45.ec3569ae.js"><link rel="prefetch" href="/assets/js/46.1bd3ce7b.js"><link rel="prefetch" href="/assets/js/47.1e1b5326.js"><link rel="prefetch" href="/assets/js/48.64c631ea.js"><link rel="prefetch" href="/assets/js/49.b4abacd8.js"><link rel="prefetch" href="/assets/js/5.e6d0b165.js"><link rel="prefetch" href="/assets/js/50.c3e320c0.js"><link rel="prefetch" href="/assets/js/51.5ec7fb8c.js"><link rel="prefetch" href="/assets/js/52.2d234f86.js"><link rel="prefetch" href="/assets/js/53.f3b69623.js"><link rel="prefetch" href="/assets/js/54.c85ff450.js"><link rel="prefetch" href="/assets/js/55.b07597b5.js"><link rel="prefetch" href="/assets/js/56.444129cf.js"><link rel="prefetch" href="/assets/js/57.df1329ba.js"><link rel="prefetch" href="/assets/js/58.5afb51cf.js"><link rel="prefetch" href="/assets/js/59.d98936d9.js"><link rel="prefetch" href="/assets/js/6.809376cd.js"><link rel="prefetch" href="/assets/js/60.02813ecf.js"><link rel="prefetch" href="/assets/js/61.37a4812d.js"><link rel="prefetch" href="/assets/js/62.5da94048.js"><link rel="prefetch" href="/assets/js/63.8e2c2bca.js"><link rel="prefetch" href="/assets/js/64.d290398f.js"><link rel="prefetch" href="/assets/js/65.44e28313.js"><link rel="prefetch" href="/assets/js/66.9acf0206.js"><link rel="prefetch" href="/assets/js/67.85688aa2.js"><link rel="prefetch" href="/assets/js/68.45bda7fc.js"><link rel="prefetch" href="/assets/js/69.9074feb0.js"><link rel="prefetch" href="/assets/js/7.5d7bce6e.js"><link rel="prefetch" href="/assets/js/70.b4cd2ddc.js"><link rel="prefetch" href="/assets/js/71.53219b13.js"><link rel="prefetch" href="/assets/js/72.af2a7290.js"><link rel="prefetch" href="/assets/js/73.c28fc506.js"><link rel="prefetch" href="/assets/js/74.64c81a90.js"><link rel="prefetch" href="/assets/js/75.05191ece.js"><link rel="prefetch" href="/assets/js/76.f516d464.js"><link rel="prefetch" href="/assets/js/77.c345180b.js"><link rel="prefetch" href="/assets/js/78.4a09d0ba.js"><link rel="prefetch" href="/assets/js/79.65f41bcf.js"><link rel="prefetch" href="/assets/js/8.f6cfdc07.js"><link rel="prefetch" href="/assets/js/80.b77151f3.js"><link rel="prefetch" href="/assets/js/81.824fa371.js"><link rel="prefetch" href="/assets/js/82.3f91c09b.js"><link rel="prefetch" href="/assets/js/83.9539f074.js"><link rel="prefetch" href="/assets/js/84.dd89f1de.js"><link rel="prefetch" href="/assets/js/85.15210b99.js"><link rel="prefetch" href="/assets/js/86.e14553e1.js"><link rel="prefetch" href="/assets/js/87.6dc95177.js"><link rel="prefetch" href="/assets/js/88.09c5e890.js"><link rel="prefetch" href="/assets/js/89.0d61f4d0.js"><link rel="prefetch" href="/assets/js/9.759f1986.js"><link rel="prefetch" href="/assets/js/90.a9b14d80.js"><link rel="prefetch" href="/assets/js/91.1a4aabe2.js"><link rel="prefetch" href="/assets/js/92.12070bdb.js"><link rel="prefetch" href="/assets/js/93.b5dc76d0.js"><link rel="prefetch" href="/assets/js/94.690498a6.js"><link rel="prefetch" href="/assets/js/95.b17961e6.js"><link rel="prefetch" href="/assets/js/96.a2f06f3e.js"><link rel="prefetch" href="/assets/js/97.64ef6721.js"><link rel="prefetch" href="/assets/js/98.443eba26.js"><link rel="prefetch" href="/assets/js/99.b6ba7c3a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">MSG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python文档" class="dropdown-title"><span class="title">Python文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python文档" class="mobile-dropdown-title"><span class="title">Python文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/1.Python-Basics/" class="nav-link">
  Python-基础
</a></li><li class="dropdown-item"><!----> <a href="/Python/2. Python-object/" class="nav-link">
  Python-面向对象
</a></li><li class="dropdown-item"><!----> <a href="/Python/3. Python-module/" class="nav-link">
  Python-模块与包
</a></li><li class="dropdown-item"><!----> <a href="/Python/4. Python-network/" class="nav-link">
  Python-网络
</a></li><li class="dropdown-item"><!----> <a href="/Python/5. Python-frontend/" class="nav-link">
  Python-前端
</a></li><li class="dropdown-item"><!----> <a href="/Python/6. Python-MySQL/" class="nav-link">
  Python-数据库
</a></li><li class="dropdown-item"><!----> <a href="/Python/7. Python-Django/" class="nav-link">
  Python-Django
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器文档" class="dropdown-title"><span class="title">容器文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器文档" class="mobile-dropdown-title"><span class="title">容器文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Container/docker/" class="nav-link">
  docker文檔
</a></li><li class="dropdown-item"><!----> <a href="/Container/Kubernetes/" class="nav-link">
  Kubernetes文檔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GO文档" class="dropdown-title"><span class="title">GO文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="GO文档" class="mobile-dropdown-title"><span class="title">GO文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GO/basics/" class="nav-link">
  GO快速入门
</a></li><li class="dropdown-item"><!----> <a href="/GO/module/" class="nav-link">
  GO标准库/GO模块
</a></li></ul></div></div><div class="nav-item"><a href="https://www.linux91.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python文档" class="dropdown-title"><span class="title">Python文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python文档" class="mobile-dropdown-title"><span class="title">Python文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/1.Python-Basics/" class="nav-link">
  Python-基础
</a></li><li class="dropdown-item"><!----> <a href="/Python/2. Python-object/" class="nav-link">
  Python-面向对象
</a></li><li class="dropdown-item"><!----> <a href="/Python/3. Python-module/" class="nav-link">
  Python-模块与包
</a></li><li class="dropdown-item"><!----> <a href="/Python/4. Python-network/" class="nav-link">
  Python-网络
</a></li><li class="dropdown-item"><!----> <a href="/Python/5. Python-frontend/" class="nav-link">
  Python-前端
</a></li><li class="dropdown-item"><!----> <a href="/Python/6. Python-MySQL/" class="nav-link">
  Python-数据库
</a></li><li class="dropdown-item"><!----> <a href="/Python/7. Python-Django/" class="nav-link">
  Python-Django
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器文档" class="dropdown-title"><span class="title">容器文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器文档" class="mobile-dropdown-title"><span class="title">容器文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Container/docker/" class="nav-link">
  docker文檔
</a></li><li class="dropdown-item"><!----> <a href="/Container/Kubernetes/" class="nav-link">
  Kubernetes文檔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GO文档" class="dropdown-title"><span class="title">GO文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="GO文档" class="mobile-dropdown-title"><span class="title">GO文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GO/basics/" class="nav-link">
  GO快速入门
</a></li><li class="dropdown-item"><!----> <a href="/GO/module/" class="nav-link">
  GO标准库/GO模块
</a></li></ul></div></div><div class="nav-item"><a href="https://www.linux91.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Python-网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/4.%20Python-network/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/Python/4. Python-network/46. socket模块 - 网络套接字模块.html" class="sidebar-link">46. socket模块 - 网络套接字模块</a></li><li><a href="/Python/4. Python-network/47. subprocess模块.html" class="sidebar-link">47. subprocess模块</a></li><li><a href="/Python/4. Python-network/48. struct模块、hmac模块、处理TCP的粘包问题.html" class="sidebar-link">48. struct模块、hmac模块、处理TCP的粘包问题</a></li><li><a href="/Python/4. Python-network/49. 进程 - 理论知识.html" class="sidebar-link">49. 进程 - 理论知识</a></li><li><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html" class="active sidebar-link">50. multiprocessing进程管理模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#process模块使用简单介绍" class="sidebar-link">process模块使用简单介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#process模块方法介绍" class="sidebar-link">process模块方法介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#启动进程-start" class="sidebar-link">启动进程 - .start()</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#启动进程-run" class="sidebar-link">启动进程 - .run()</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#强制终止进程-terminate" class="sidebar-link">强制终止进程 - .terminate()</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#检查子进程是否存活-is-alive" class="sidebar-link">检查子进程是否存活 - .is_alive()</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#等待子进程执行完毕-join" class="sidebar-link">等待子进程执行完毕 - .join()</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#主进程作为子进程的守护进程-daemon" class="sidebar-link">主进程作为子进程的守护进程 .daemon()</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#设置并查看子进程的名称-name" class="sidebar-link">设置并查看子进程的名称 - .name</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#查看子进程的pid-pid" class="sidebar-link">查看子进程的PID - .pid()</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#不常用的方法" class="sidebar-link">不常用的方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#在windows使用process模块的注意事项" class="sidebar-link">在windows使用process模块的注意事项</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#process模块的使用" class="sidebar-link">process模块的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#查看主进程跟子进程的pid" class="sidebar-link">查看主进程跟子进程的PID</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#多个子进程的开启" class="sidebar-link">多个子进程的开启</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#使用继承类方式来开启子进程" class="sidebar-link">使用继承类方式来开启子进程</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#守护进程" class="sidebar-link">守护进程</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#socket-tcp协议并发实现聊天" class="sidebar-link">socket tcp协议并发实现聊天</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#多进程中其他方法" class="sidebar-link">多进程中其他方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#共享变量类型" class="sidebar-link">共享变量类型</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#共享变量简单使用" class="sidebar-link">共享变量简单使用</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#lock模块的功能介绍" class="sidebar-link">Lock模块的功能介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#锁的用处" class="sidebar-link">锁的用处</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-模拟银行取钱存钱" class="sidebar-link">实验 - 模拟银行取钱存钱</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-模拟12306抢票" class="sidebar-link">实验 - 模拟12306抢票</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#semaphore模块的功能介绍" class="sidebar-link">Semaphore模块的功能介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#semaphore模块的简单使用" class="sidebar-link">Semaphore模块的简单使用</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-模拟发㾿接客系统" class="sidebar-link">实验 - 模拟发㾿接客系统</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#event模块的功能介绍" class="sidebar-link">Event模块的功能介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#event模块的简单使用" class="sidebar-link">Event模块的简单使用</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-车行信号灯模拟" class="sidebar-link">实验 - 车行信号灯模拟</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#multiprocess-queue模块的功能介绍" class="sidebar-link">multiprocess.Queue模块的功能介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#multiprocess-queue模块的简单使用" class="sidebar-link">multiprocess.Queue模块的简单使用</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-多进程批量获取存入" class="sidebar-link">实验 - 多进程批量获取存入</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-基于队列的生产者消费者模型" class="sidebar-link">实验 - 基于队列的生产者消费者模型</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-基于上面实验-生产者生产结束标识" class="sidebar-link">实验 - 基于上面实验 - 生产者生产结束标识</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-基于上面实验-主进程生产标识" class="sidebar-link">实验 - 基于上面实验 - 主进程生产标识</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#joinablequeue模块的独特方法" class="sidebar-link">JoinableQueue模块的独特方法</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-基于joinablequeue队列的生产者消费者模型" class="sidebar-link">实验 - 基于JoinableQueue队列的生产者消费者模型</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#pipe模块的方法介绍" class="sidebar-link">Pipe模块的方法介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#pipe模块的简单使用" class="sidebar-link">Pipe模块的简单使用</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实例-多进程-无限接收数据异常" class="sidebar-link">实例 - 多进程，无限接收数据异常</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-基于pipe管道的生产者消费者模型" class="sidebar-link">实验 - 基于Pipe管道的生产者消费者模型</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-多消费者竞争数据带来数据不安全问题" class="sidebar-link">实验 - 多消费者竞争数据带来数据不安全问题</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#manager模块的方法介绍" class="sidebar-link">Manager模块的方法介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#manager模块的简单使用" class="sidebar-link">Manager模块的简单使用</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-多进程的变量共享" class="sidebar-link">实验 - 多进程的变量共享</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#pool模块的方法介绍" class="sidebar-link">Pool模块的方法介绍</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-进程池和多进程效率对比" class="sidebar-link">实验 - 进程池和多进程效率对比</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-进程池的同步调用模式" class="sidebar-link">实验 - 进程池的同步调用模式</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-进程池的异步调用模式" class="sidebar-link">实验 - 进程池的异步调用模式</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-同步跟异步模式效率的对比" class="sidebar-link">实验 - 同步跟异步模式效率的对比</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-进程池的异步模式的回调函数" class="sidebar-link">实验 - 进程池的异步模式的回调函数</a></li><li class="sidebar-sub-header"><a href="/Python/4. Python-network/50. multiprocessing进程管理模块.html#实验-进程池实现socket并发聊天" class="sidebar-link">实验 - 进程池实现socket并发聊天</a></li></ul></li><li><a href="/Python/4. Python-network/51. 线程 - 理念知识.html" class="sidebar-link">51. 线程 - 理念知识</a></li><li><a href="/Python/4. Python-network/52. threading线程管理模块、queue队列模块、concurrent线程池模块.html" class="sidebar-link">52. threading线程管理模块、queue队列模块、concurrent线程池模块</a></li><li><a href="/Python/4. Python-network/53. 协程、Greenlet模块、Gevent模块.html" class="sidebar-link">53. 协程、Greenlet模块、Gevent模块</a></li><li><a href="/Python/4. Python-network/54. IO多路复用.html" class="sidebar-link">54. IO多路复用</a></li><li><a href="/Python/4. Python-network/55. 网络编程大作业 - 类网盘项目.html" class="sidebar-link">55. 网络编程大作业 - 类网盘项目</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_50-multiprocessing进程管理模块"><a href="#_50-multiprocessing进程管理模块" class="header-anchor">#</a> 50. multiprocessing进程管理模块</h1> <p>仔细说来，multiprocessing不是一个模块而是python中一个操作、管理进程的包。 之所以叫multi是取自multiple的多功能的意思,在这个包中几乎包含了和进程有关的所有子模块。</p> <h1 id="multiprocessing-process进程模块-重点"><a href="#multiprocessing-process进程模块-重点" class="header-anchor">#</a> <strong>multiprocessing.process进程模块 - 重点</strong></h1> <p>process模块是一个创建进程的模块，借助这个模块，就可以完成进程的创建。</p> <h2 id="process模块使用简单介绍"><a href="#process模块使用简单介绍" class="header-anchor">#</a> process模块使用简单介绍</h2> <div class="language-python extra-class"><pre class="language-python"><code>Process<span class="token punctuation">(</span>group<span class="token punctuation">,</span>target<span class="token punctuation">,</span>name<span class="token punctuation">,</span>args<span class="token punctuation">,</span>kwargs<span class="token punctuation">)</span>，由该类实例化得到的对象，表示一个子进程中的任务（尚未启动）

<span class="token comment">#常用</span>
target<span class="token operator">=</span>  <span class="token comment">##指定某一个方法或类开启子进程线程并运行，表示调用对象，即子进程要执行的任务</span>
args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token comment">##指定传输给target函数位置的数据，元组形式，需要有逗号，表示调用对象的位置参数元组，args=(1,2,'egon',)</span>

<span class="token comment"># 其他参数</span>
group <span class="token comment">#参数未使用，值始终为None</span>
kwargs <span class="token comment">#表示调用对象的字典,kwargs={'name':'egon','age':18}</span>
name <span class="token comment">#为子进程的名称</span>
</code></pre></div><h2 id="process模块方法介绍"><a href="#process模块方法介绍" class="header-anchor">#</a> process模块方法介绍</h2> <h3 id="启动进程-start"><a href="#启动进程-start" class="header-anchor">#</a> 启动进程 - .start()</h3> <p>启动进程，并调用该子进程中的p.run()</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process

<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
执行结果：
<span class="token number">1</span>
</code></pre></div><p>**注意：**启动进程的时候要加上if <strong>name</strong> == '<strong>main</strong>':，为什么要加呢，因为开启进程，Python解释器需要你要当前执行文件开启，如果判断你是否在当前文件执行开启，还是用自定义模块开启，所以就需要加上if <strong>name</strong> == '<strong>main</strong>':</p> <h3 id="启动进程-run"><a href="#启动进程-run" class="header-anchor">#</a> 启动进程 - .run()</h3> <p>进程启动时运行的方法，正是它去调用target指定的函数，我们自定义类的类中一定要实现该方法</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process

<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
执行结果：
<span class="token number">1</span>
</code></pre></div><h3 id="强制终止进程-terminate"><a href="#强制终止进程-terminate" class="header-anchor">#</a> 强制终止进程 - .terminate()</h3> <p>强制终止进程，不会进行任何清理操作，如果创建了子进程，该子进程就成了僵尸进程，使用该方法需要特别小心这种情况。如果还保存了一个锁那么也将不会被释放，进而导致死锁</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pc<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>使用了time模块的停止方法，让子进程暂时保留，让terminate()去结束这个子进程</p> <h3 id="检查子进程是否存活-is-alive"><a href="#检查子进程是否存活-is-alive" class="header-anchor">#</a> 检查子进程是否存活 - .is_alive()</h3> <p>如果子进程仍然运行，返回True</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
执行结果：
<span class="token boolean">True</span>
<span class="token number">1</span>
</code></pre></div><h3 id="等待子进程执行完毕-join"><a href="#等待子进程执行完毕-join" class="header-anchor">#</a> 等待子进程执行完毕 - .join()</h3> <p>主进程等待终止（强调：是主进程处于等的状态，而子进程是处于运行的状态）。timeout是可选的超时时间，需要强调的是，<strong>.join只能join住start开启的进程，而不能join住run开启的进程</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pc<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    
执行结果：
<span class="token number">1</span>
<span class="token number">2</span>
</code></pre></div><h3 id="主进程作为子进程的守护进程-daemon"><a href="#主进程作为子进程的守护进程-daemon" class="header-anchor">#</a> 主进程作为子进程的守护进程 .daemon()</h3> <p>默认值为False，如果设为True，代表子进程为后台运行的守护进程，当子进程的父进程终止时，子进程也随之终止，并且设定为True后，子进程不能创建自己的新进程，必须在.start()之前设置</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="设置并查看子进程的名称-name"><a href="#设置并查看子进程的名称-name" class="header-anchor">#</a> 设置并查看子进程的名称 - .name</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pc<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span>   <span class="token comment">## 设置子进程名称</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment">## 查看子进程名称</span>
    
执行结果：
name
<span class="token number">1</span>
</code></pre></div><h3 id="查看子进程的pid-pid"><a href="#查看子进程的pid-pid" class="header-anchor">#</a> 查看子进程的PID - .pid()</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>
    
执行结果：
<span class="token number">17332</span>
<span class="token number">1</span>
</code></pre></div><h3 id="不常用的方法"><a href="#不常用的方法" class="header-anchor">#</a> 不常用的方法</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">.</span>exitcode   
<span class="token comment">## 进程在运行时为None、如果为–N，表示被信号N结束(了解即可)</span>

<span class="token punctuation">.</span>authkey  
<span class="token comment">##进程的身份验证键,默认是由os.urandom()随机生成的32字符的字符串。这个键的用途是为涉及网络连接的底层进程间通信提供安全性，这类连接只有在具有相同的身份验证键时才能成功（了解即可）</span>
</code></pre></div><h2 id="在windows使用process模块的注意事项"><a href="#在windows使用process模块的注意事项" class="header-anchor">#</a> 在windows使用process模块的注意事项</h2> <p>在Windows操作系统中由于没有fork(linux操作系统中创建进程的机制)，在创建子进程的时候会自动 import 启动它的这个文件，而在 import 的时候又执行了整个文件。因此如果将process()直接写在文件中就会无限递归创建子进程报错。所以必须把创建子进程的部分使用if <strong>name</strong> ==‘<strong>main</strong>’ 判断保护起来，import 的时候  ，就不会递归运行了。
使用process模块创建进程</p> <h2 id="process模块的使用"><a href="#process模块的使用" class="header-anchor">#</a> process模块的使用</h2> <p>在上面的方法介绍中，也知道了process模块的大概使用方法，其他process模块也可以用类继承方式来开启子进程，下面会讲，现在主要讲的是，process模块的一些使用</p> <h3 id="查看主进程跟子进程的pid"><a href="#查看主进程跟子进程的pid" class="header-anchor">#</a> 查看主进程跟子进程的PID</h3> <p>因为process模块没有提供查看主进程的方法，所以这里要使用os模块来查看</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> os
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;os模块的子进程PID:&quot;</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;os模块的子进程的父进程PID:&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getppid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;process模块的子进程PID:&quot;</span><span class="token punctuation">,</span>pc<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;os模块的主进程PID:&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
执行结果：
process模块的子进程PID<span class="token punctuation">:</span> <span class="token number">2344</span>
os模块的主进程PID<span class="token punctuation">:</span> <span class="token number">17196</span>
os模块的子进程PID<span class="token punctuation">:</span> <span class="token number">2344</span>
os模块的子进程的父进程PID<span class="token punctuation">:</span> <span class="token number">17196</span>
</code></pre></div><h3 id="多个子进程的开启"><a href="#多个子进程的开启" class="header-anchor">#</a> 多个子进程的开启</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> random
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;这是第%s个子进程&quot;</span><span class="token operator">%</span>n<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;我想随机获取子进程的数：%s&quot;</span><span class="token operator">%</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
执行结果：
这是第<span class="token number">0</span>个子进程
这是第<span class="token number">1</span>个子进程
这是第<span class="token number">3</span>个子进程
这是第<span class="token number">2</span>个子进程
这是第<span class="token number">4</span>个子进程
我想随机获取子进程的数：<span class="token number">2</span>
这是第<span class="token number">5</span>个子进程
这是第<span class="token number">7</span>个子进程
这是第<span class="token number">6</span>个子进程
这是第<span class="token number">9</span>个子进程
这是第<span class="token number">8</span>个子进程
这是第<span class="token number">10</span>个子进程
</code></pre></div><p>这样子，我想随机获取子进程的数，显示就在其他进程显示的前面，那要等所有进程执行完毕，才能接着执行</p> <p><strong>使用列表表达式</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> random
<span class="token keyword">def</span> <span class="token function">so</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;这是第%s个子进程&quot;</span><span class="token operator">%</span>n<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    li <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>so<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        li<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pc<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>pc<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> li<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;我想随机获取子进程的数：%s&quot;</span><span class="token operator">%</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
执行结果：
这是第<span class="token number">0</span>个子进程
这是第<span class="token number">1</span>个子进程
这是第<span class="token number">3</span>个子进程
这是第<span class="token number">2</span>个子进程
这是第<span class="token number">4</span>个子进程
这是第<span class="token number">7</span>个子进程
这是第<span class="token number">5</span>个子进程
这是第<span class="token number">6</span>个子进程
这是第<span class="token number">8</span>个子进程
这是第<span class="token number">9</span>个子进程
这是第<span class="token number">10</span>个子进程
我想随机获取子进程的数：<span class="token number">3</span>
</code></pre></div><h3 id="使用继承类方式来开启子进程"><a href="#使用继承类方式来开启子进程" class="header-anchor">#</a> 使用继承类方式来开启子进程</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process

<span class="token keyword">class</span> <span class="token class-name">so</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;我是%s&quot;</span><span class="token operator">%</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    pc <span class="token operator">=</span> so<span class="token punctuation">(</span><span class="token string">&quot;子进程&quot;</span><span class="token punctuation">)</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
执行结果：
我是子进程

<span class="token comment">## 继承类方式来使用，默认执行__init__方法后，执行run方法</span>
</code></pre></div><h3 id="守护进程"><a href="#守护进程" class="header-anchor">#</a> 守护进程</h3> <p>会随着父进程的结束而结束。</p> <p>父进程创建守护进程</p> <ol><li>其一：守护进程会在父进程代码执行结束后就终止</li> <li>其二：守护进程内无法再开启子进程,否则抛出异常：AssertionError: daemonic processes are not allowed to have children</li></ol> <p>注意：进程之间是互相独立的，父进程代码运行结束，守护进程随即终止</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子进程开始执行'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子进程结束执行'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'主进程开始执行'</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span><span class="token comment"># 将p 设置为守护进程，此代码一定要在start之前设置。</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'主进程结束执行'</span><span class="token punctuation">)</span>
    
执行结果：
主进程开始执行
子进程开始执行
主进程结束执行
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子进程2开始执行'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子进程2结束执行'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子进程1开始执行'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子进程1结束执行'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'主进程开始执行'</span><span class="token punctuation">)</span>
    p1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func1<span class="token punctuation">,</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func2<span class="token punctuation">)</span>
    p1<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span><span class="token comment"># 将p1 设置为守护进程，此代码一定要在start之前设置。</span>
    p1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># 此时p1 p2 和main 都已经开始执行</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'主进程结束执行'</span><span class="token punctuation">)</span><span class="token comment"># 当主进程打印完这句话，代表主进程结束，守护进程p1肯定随之结束</span>
    <span class="token comment"># 但是p2 不是守护进程，不会结束，所以此时程序（也就是主进程）会等待p2结束之后才结束。</span>
    
执行结果：
主进程开始执行
子进程<span class="token number">1</span>开始执行
子进程<span class="token number">2</span>开始执行
主进程结束执行
子进程<span class="token number">2</span>结束执行
</code></pre></div><h3 id="socket-tcp协议并发实现聊天"><a href="#socket-tcp协议并发实现聊天" class="header-anchor">#</a> socket tcp协议并发实现聊天</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">## 服务端文件</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> socket
<span class="token keyword">from</span> socket <span class="token keyword">import</span> SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR
<span class="token keyword">import</span> time
SERVER_ADDR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span>
sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>SERVER_ADDR<span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            msg_r <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>msg_r<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> msg_r<span class="token punctuation">:</span><span class="token keyword">break</span>
            conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg_r<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span>addr <span class="token operator">=</span> sk<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    
<span class="token comment">## 客户端文件</span>
<span class="token keyword">import</span> socket
sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    msg_s <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt;'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> msg_s<span class="token punctuation">:</span><span class="token keyword">continue</span>
    sk<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg_s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sk<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="多进程中其他方法"><a href="#多进程中其他方法" class="header-anchor">#</a> 多进程中其他方法</h3> <h4 id="进程的terminate和is-alive方法"><a href="#进程的terminate和is-alive方法" class="header-anchor">#</a> 进程的terminate和is_alive方法</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time

<span class="token keyword">class</span> <span class="token class-name">MyProcess</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyProcess<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token comment"># name是父类Process中的属性，这里相当于给子进程命名</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 正在撩小姐姐'</span><span class="token operator">%</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 还在撩小姐姐'</span><span class="token operator">%</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> MyProcess<span class="token punctuation">(</span><span class="token string">'江凡'</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 将p进程杀死的命令。 将任务提交给操作系统，操作系统什么时候执行不受用户决定</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 判断p进程是否还存在</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">## 如果不加sleep来控制，那么可能的结果都是True，因为系统可能还没有强制结束子进程</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 判断p进程是否还存在</span>
    
执行结果：
<span class="token boolean">True</span>
<span class="token boolean">False</span>
</code></pre></div><h4 id="进程的name和pid属性"><a href="#进程的name和pid属性" class="header-anchor">#</a> 进程的name和pid属性</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time

<span class="token keyword">class</span> <span class="token class-name">MyProcess</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyProcess<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token comment"># name是父类Process中的属性，这里相当于给子进程命名</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 正在撩小姐姐'</span><span class="token operator">%</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 还在撩小姐姐'</span><span class="token operator">%</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> MyProcess<span class="token punctuation">(</span><span class="token string">'江凡'</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span>p<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token comment"># 打印进程名字，进程id号</span>
    
执行结果：
江凡 <span class="token number">5808</span>
江凡 正在撩小姐姐
江凡 还在撩小姐姐
</code></pre></div><h1 id="multiprocessing-value共享变量模块-了解"><a href="#multiprocessing-value共享变量模块-了解" class="header-anchor">#</a> multiprocessing.Value共享变量模块 - 了解</h1> <p>这个模块有很多的限制，比如转入的类型限制，目前没有深入研究</p> <h2 id="共享变量类型"><a href="#共享变量类型" class="header-anchor">#</a> 共享变量类型</h2> <p><strong>对于共享整数或者单个字符，初始化比较简单，参照下图映射关系即可</strong></p> <table><thead><tr><th style="text-align:center;">Type Code</th> <th style="text-align:center;">C Type</th> <th style="text-align:center;">Python Type</th></tr></thead> <tbody><tr><td style="text-align:center;">'c'</td> <td style="text-align:center;">char</td> <td style="text-align:center;">character</td></tr> <tr><td style="text-align:center;">'b'</td> <td style="text-align:center;">signed char</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'B'</td> <td style="text-align:center;">unsigned char</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'u'</td> <td style="text-align:center;">Py_UNICODE</td> <td style="text-align:center;">unicode character</td></tr> <tr><td style="text-align:center;">'h'</td> <td style="text-align:center;">signed short</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'H'</td> <td style="text-align:center;">unsigned short</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'i'</td> <td style="text-align:center;">signed int</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'I'</td> <td style="text-align:center;">unsigned int</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'l'</td> <td style="text-align:center;">signed long</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'L'</td> <td style="text-align:center;">unsigned long</td> <td style="text-align:center;">int</td></tr> <tr><td style="text-align:center;">'f'</td> <td style="text-align:center;">float</td> <td style="text-align:center;">float</td></tr> <tr><td style="text-align:center;">'d'</td> <td style="text-align:center;">double</td> <td style="text-align:center;">float</td></tr></tbody></table> <p><strong>如果共享的是字符串，则在上表是找不到映射关系的，就是没有code可用。所以我们需要使用原始的ctype类型</strong></p> <p><strong>比如</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Value
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> c_char_p
ss <span class="token operator">=</span> Value<span class="token punctuation">(</span>c_char_p<span class="token punctuation">,</span> <span class="token string">'ss'</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>ctype类型可从下表查阅</strong></p> <table><thead><tr><th style="text-align:center;"><strong>ctypes type</strong></th> <th style="text-align:center;"><strong>C type</strong></th> <th style="text-align:center;"><strong>Python type</strong></th></tr></thead> <tbody><tr><td style="text-align:center;">c_bool</td> <td style="text-align:center;">_Bool</td> <td style="text-align:center;">bool (1)</td></tr> <tr><td style="text-align:center;">char</td> <td style="text-align:center;">char</td> <td style="text-align:center;">1-character string</td></tr> <tr><td style="text-align:center;">c_wchar</td> <td style="text-align:center;">wchar_t</td> <td style="text-align:center;">1-character unicode string</td></tr> <tr><td style="text-align:center;">c_byte</td> <td style="text-align:center;">char</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_ubyte</td> <td style="text-align:center;">unsigned char</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_short</td> <td style="text-align:center;">short</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_ushort</td> <td style="text-align:center;">unsigned short</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_int</td> <td style="text-align:center;">int</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_uint</td> <td style="text-align:center;">unsigned in</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_long</td> <td style="text-align:center;">long</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_ulong</td> <td style="text-align:center;">unsigned long</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_longlong</td> <td style="text-align:center;">__int64 or long long</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_ulonglong</td> <td style="text-align:center;">unsigned __int64 or unsigned long long</td> <td style="text-align:center;">int/long</td></tr> <tr><td style="text-align:center;">c_float</td> <td style="text-align:center;">float</td> <td style="text-align:center;">float</td></tr> <tr><td style="text-align:center;">c_double</td> <td style="text-align:center;">double</td> <td style="text-align:center;">float</td></tr> <tr><td style="text-align:center;">c_longdouble</td> <td style="text-align:center;">long double</td> <td style="text-align:center;">float</td></tr> <tr><td style="text-align:center;">c_char_p</td> <td style="text-align:center;">char * (NUL terminated)</td> <td style="text-align:center;">string or None</td></tr> <tr><td style="text-align:center;">c_wchar_p</td> <td style="text-align:center;">wchar_t * (NUL terminated)</td> <td style="text-align:center;">unicode or None</td></tr> <tr><td style="text-align:center;">c_void_p</td> <td style="text-align:center;">void *</td> <td style="text-align:center;">int/long or None</td></tr></tbody></table> <p><strong>上面这些表都是从网上的拷贝的，对于字符串类型的数据共享，目前还暂时没研究</strong></p> <h2 id="共享变量简单使用"><a href="#共享变量简单使用" class="header-anchor">#</a> 共享变量简单使用</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span>so<span class="token punctuation">)</span><span class="token punctuation">:</span>
    so<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>so<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    so <span class="token operator">=</span> Value<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
    pr <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>val<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>so<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pr<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pr<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>so<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    
执行结果：
<span class="token number">102</span>
<span class="token number">102</span>

<span class="token comment">## 共享变量，需要把变量转进子进程里</span>
<span class="token comment">## 子进程修改了共享变量，在主进程的共享变量也会跟着修改</span>
</code></pre></div><h1 id="multiprocessing-lock锁模块-重点"><a href="#multiprocessing-lock锁模块-重点" class="header-anchor">#</a> <strong>multiprocessing.Lock锁模块 - 重点</strong></h1> <p>刚刚的文章，千方百计实现了程序的异步，让多个任务可以同时在几个进程中并发处理，他们之间的运行没有顺序（或者说由操作系统调度决定他们的顺序），一旦开启也不受我们控制。尽管并发编程让我们能更加充分的利用IO资源，但是也给带来了新的问题。</p> <h2 id="lock模块的功能介绍"><a href="#lock模块的功能介绍" class="header-anchor">#</a> Lock模块的功能介绍</h2> <p>Lock模块的功能就只有二个，一个是解锁，一个是锁上</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Lock
lc <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 实例化Lock类，不用加参数</span>
lc<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 锁上，把以下的资源全部锁上，不让其他进程操作，除非解锁了</span>
lc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 解锁，把以上的资源释放了，可以让其他进程进行操作</span>
</code></pre></div><h2 id="锁的用处"><a href="#锁的用处" class="header-anchor">#</a> 锁的用处</h2> <p>当多个进程使用同一份数据资源的时候，就会引发数据安全或顺序混乱问题，</p> <p>可以使用加锁的形式确保了程序的顺序执行，但是执行又变成了串行，降低了效率，但是不得不说，它确保了数据的安全性。</p> <p>让一份数据资源，保证只有一个进程进行操作，这样才不会出现数据混乱的现象</p> <h2 id="实验-模拟银行取钱存钱"><a href="#实验-模拟银行取钱存钱" class="header-anchor">#</a> 实验 - 模拟银行取钱存钱</h2> <p>银行无论是取钱跟存钱，都是要存入数据库中的，如果没有锁的存在，那么同时存钱跟取钱的操作，有可能会让账户的余额数据混乱</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">## 钱文件</span>
<span class="token number">1000</span>

<span class="token comment">## 程序文件</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Lock<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">draw</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>lc<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 取钱</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        lc<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            conn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>  <span class="token comment">## 如果不加暂时，可能系统还没读出，就开始下面的if判断了</span>
            <span class="token keyword">if</span> conn <span class="token operator">&gt;</span> i <span class="token punctuation">:</span>
                conn <span class="token operator">=</span> conn <span class="token operator">-</span> i
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;成功取出%s元，目前账户还剩下%s元&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;账户余额不足%s元，剩下%s元，无法取出&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>
        lc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>lc<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 存钱</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        lc<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            conn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
        conn <span class="token operator">=</span> conn <span class="token operator">+</span> i
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;成功存入%s元，目前账户还共有%s元&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> conn<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>
        lc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    lc <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pr <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>draw<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>lc<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 取钱</span>
    pr<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pr1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>save<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>lc<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 存钱</span>
    pr1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    
执行结果：
成功取出<span class="token number">5</span>元，目前账户还剩下<span class="token number">995</span>元
成功存入<span class="token number">5</span>元，目前账户还共有<span class="token number">1000</span>元
成功取出<span class="token number">5</span>元，目前账户还剩下<span class="token number">995</span>元
成功存入<span class="token number">5</span>元，目前账户还共有<span class="token number">1000</span>元
</code></pre></div><h2 id="实验-模拟12306抢票"><a href="#实验-模拟12306抢票" class="header-anchor">#</a> 实验 - 模拟12306抢票</h2> <p>抢票，如果不用锁的吧，那么同时有多人抢票，那是不是都抢到票了，但是票只有一个，所以要使用锁</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">## 钱文件</span>
<span class="token number">2</span>

<span class="token comment">## 程序文件</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Lock<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">Shakedown</span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 抢票</span>
    lc<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            coon <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> coon <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            coon <span class="token operator">=</span> coon <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s位用户成功购买了前往北京的车票，剩余的车票数为%s张&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>coon<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>coon<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s位用户抢购失败，当前前往北京的车票数为%s&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>coon<span class="token punctuation">)</span><span class="token punctuation">)</span>
    lc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">ticket</span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 查票</span>
    lc<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            coon <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s位用户查看了前往北京的车票数为%s张&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>coon<span class="token punctuation">)</span><span class="token punctuation">)</span>
    lc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    lc <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pc <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>ticket<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>lc<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    pc1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>Shakedown<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>lc<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pc1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
执行结果：
第<span class="token number">1</span>位用户查看了前往北京的车票数为<span class="token number">2</span>张
第<span class="token number">2</span>位用户查看了前往北京的车票数为<span class="token number">2</span>张
第<span class="token number">3</span>位用户查看了前往北京的车票数为<span class="token number">2</span>张
第<span class="token number">1</span>位用户成功购买了前往北京的车票，剩余的车票数为<span class="token number">1</span>张
第<span class="token number">2</span>位用户成功购买了前往北京的车票，剩余的车票数为<span class="token number">0</span>张
第<span class="token number">3</span>位用户抢购失败，当前前往北京的车票数为<span class="token number">0</span>
</code></pre></div><h1 id="multiprocessing-semaphore信号量模块-了解"><a href="#multiprocessing-semaphore信号量模块-了解" class="header-anchor">#</a> multiprocessing.Semaphore信号量模块-了解</h1> <p>上述讲的Lock，属于互斥锁，也就是一把钥匙配备一把锁，同时只允许锁住某一个数据。而信号量则是多把钥匙配备多把锁，也就是说同时允许锁住多个数据。</p> <p>信号量同步基于内部计数器，用户初始化一个计数器初值，每调用一次acquire()，计数器减1；每调用一次release()，计数器加1。当计数器为0时，acquire()调用被阻塞。这是迪科斯彻（Dijkstra）信号量概念P()和V()的Python实现。信号量同步机制适用于访问像服务器这样的有限资源。信号量与进程池的概念很像，但是要区分开，信号量涉及到加锁的概念</p> <h2 id="semaphore模块的功能介绍"><a href="#semaphore模块的功能介绍" class="header-anchor">#</a> Semaphore模块的功能介绍</h2> <p>Semaphore模块的功能就只有二个，一个是解锁，一个是锁上，能解锁的数量是由实例化的时候控制的</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Semaphore
s <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化一个对象，参数为 n ，能有几个可以解锁的，4为有4个钥匙可以解锁</span>
s<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 锁上，拿走一把钥匙</span>
s<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 解锁，释放一把钥匙</span>
</code></pre></div><h2 id="semaphore模块的简单使用"><a href="#semaphore模块的简单使用" class="header-anchor">#</a> Semaphore模块的简单使用</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Semaphore
s <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">456</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">789</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>

执行结果：
<span class="token number">123</span>
<span class="token number">456</span>
<span class="token number">789</span>

<span class="token comment">## 程序执行到789之后的s.acquire()，就会进入阻塞，等待程序释放钥匙</span>
</code></pre></div><h2 id="实验-模拟发㾿接客系统"><a href="#实验-模拟发㾿接客系统" class="header-anchor">#</a> 实验 - 模拟发㾿接客系统</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span>Semaphore
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>sem<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sem<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'第%s个人进入小黑屋,拿了钥匙锁上门'</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'第%s个人出去小黑屋,还了钥匙打开门'</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>
    sem<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    sem <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment"># 初始化了一把锁5把钥匙，也就是说允许5个人同时进入小黑屋</span>
    <span class="token comment"># 之后其他人必须等待，等有人从小黑屋出来，还了钥匙，才能允许后边的人进入</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>sem<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
执行结果：
第<span class="token number">1</span>个人进入小黑屋<span class="token punctuation">,</span>拿了钥匙锁上门
第<span class="token number">0</span>个人进入小黑屋<span class="token punctuation">,</span>拿了钥匙锁上门
第<span class="token number">1</span>个人出去小黑屋<span class="token punctuation">,</span>还了钥匙打开门
第<span class="token number">2</span>个人进入小黑屋<span class="token punctuation">,</span>拿了钥匙锁上门
第<span class="token number">0</span>个人出去小黑屋<span class="token punctuation">,</span>还了钥匙打开门
第<span class="token number">2</span>个人出去小黑屋<span class="token punctuation">,</span>还了钥匙打开门
</code></pre></div><h1 id="multiprocessing-event事件模块-了解"><a href="#multiprocessing-event事件模块-了解" class="header-anchor">#</a> multiprocessing.Event事件模块 - 了解</h1> <p>python中的事件机制，主要用于主进程控制其他进程的执行</p> <h2 id="event模块的功能介绍"><a href="#event模块的功能介绍" class="header-anchor">#</a> Event模块的功能介绍</h2> <p>事件主要提供了三个方法 set、wait、clear</p> <p>事件处理的机制：全局定义了一个“Flag”（event.is_set()），如果“Flag”值为 False，那么当程序执行 event.wait 方法时就会阻塞，如果“Flag”值为True，那么event.wait 方法时便不再阻塞。</p> <div class="language-python extra-class"><pre class="language-python"><code>e <span class="token operator">=</span> Event<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#实例化一个对象</span>
e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#将is_set()设为True</span>
e<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 将is_set()设为False</span>
e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#判断is_set的bool值，如果bool为True，则非阻塞，bool值为False，则阻塞</span>
e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 标识，查看bool值</span>

<span class="token comment"># 事件是通过is_set()的bool值，去标识e.wait() 的阻塞状态</span>
<span class="token comment"># 当is_set()的bool值为False时，e.wait()是阻塞状态</span>
<span class="token comment"># 当is_set()的bool值为True时，e.wait()是非阻塞状态</span>
<span class="token comment"># 当使用set()时，是把is_set的bool变为True</span>
<span class="token comment"># 当使用clear()时，是把is_set的bool变为False</span>
</code></pre></div><h2 id="event模块的简单使用"><a href="#event模块的简单使用" class="header-anchor">#</a> Event模块的简单使用</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Event
<span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># False wait应该是阻塞住</span>
e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 将is_set 的bool值变为True，将wait变为非阻塞</span>
e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

执行结果：
<span class="token boolean">False</span>
<span class="token boolean">True</span>

<span class="token comment">#################################################################################</span>

<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Event
<span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># False wait应该是阻塞住</span>
e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 将is_set 的bool值变为True，将wait变为非阻塞</span>
e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
e<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>

执行结果：
<span class="token boolean">False</span>
<span class="token boolean">True</span>
<span class="token number">123</span>
<span class="token boolean">False</span>

<span class="token comment">## 程序进行阻塞等待</span>
</code></pre></div><h2 id="实验-车行信号灯模拟"><a href="#实验-车行信号灯模拟" class="header-anchor">#</a> 实验 - 车行信号灯模拟</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Event<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random

<span class="token keyword">def</span> <span class="token function">tl</span><span class="token punctuation">(</span>tlso<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment">## 红绿灯控制</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment">## 如is_set()为False 则执行下面的码</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;绿灯亮&quot;</span><span class="token punctuation">)</span>
            e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment">## 把is_set()更改为True，为非阻塞状态</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>    <span class="token comment">## 暂停4秒</span>
            
        <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token comment">#### 如is_set()为True 则执行下面的代码</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;红灯亮&quot;</span><span class="token punctuation">)</span>
            e<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">## 把is_set()更改为False，为阻塞状态</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>    <span class="token comment">## 暂停4秒</span>

<span class="token keyword">def</span> <span class="token function">car</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">## 车辆控制</span>
    e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 判断当前是否是阻塞，如果是阻塞就等待，如果不是就执行以下代码</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s辆车开过路口&quot;</span><span class="token operator">%</span>i<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    e <span class="token operator">=</span> Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pr1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>tl<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>tlso<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pr1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 如果is_set为True，就结束循环，执行以下代码，如果is_set为False，就无限循环，直is_set为True，才执行以下代码</span>
                <span class="token keyword">break</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pr <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>car<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pr<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="multiprocess-queue队列模块-重点"><a href="#multiprocess-queue队列模块-重点" class="header-anchor">#</a> <strong>multiprocess.Queue队列模块 - 重点</strong></h1> <p>队列：创建共享的进程队列，Queue是多进程安全的队列，可以使用Queue实现多进程之间的数据传递</p> <p>队列是安全的，他自带限制，不能出现多进程同时取同一个数据，不能产生数据混乱的现象</p> <h2 id="multiprocess-queue模块的功能介绍"><a href="#multiprocess-queue模块的功能介绍" class="header-anchor">#</a> multiprocess.Queue模块的功能介绍</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Queue
q <span class="token operator">=</span> Queue<span class="token punctuation">(</span>n<span class="token punctuation">)</span>   <span class="token comment">## 实例化一个对象，n：代表队列的大小，能存储几个值</span>

q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 接收数据，从队列获取值，阻塞等待获取数据，如果有数据直接获取，如果没有数据，阻塞等待</span>
q<span class="token punctuation">.</span>get_nowait<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 不接收数据，从队列获取值，阻塞，如果有数据直接获取，没有数据就报错</span>

q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 存入数据，把数据存入在队列中，阻塞，如果可以继续往队列中放数据，就直接放，不能放就阻塞等待</span>
q<span class="token punctuation">.</span>put_nowait<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 存入数据，把数据存入在队列中，不阻塞，如果可以继续往队列中放数据，就直接放，不能放就报错</span>

q<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 关闭队列，防止队列中加入更多数据。调用此方法时，后台线程将继续写入那些已入队列但尚未写入的数据，但将在此方法完成时马上关闭。如果队列 被垃圾收集，将自动调用此方法。关闭队列不会在队列使用者中生成任何类型的数据结束信号或异常。例如，如果某个使用者正被阻塞在get（）操作上，关闭生产者中的队列不会导致get（）方法返回错误。</span>

q<span class="token punctuation">.</span>qsize<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 返回队列中目前项目的正确数量。此函数的结果并不可靠，因为在返回结果和在稍后程序中使用结果之间，队列中可能添加或删除了项目。在某些系统上，此方法可能引发NotImplementedError异常。</span>

q<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 如果调用此方法时 队列为空，返回True。如果其他进程或线程正在往队列中添加项目，结果是不可靠的。也就是说，在返回和使用结果之间，队列中可能已经加入新的项目。</span>

q<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 如果队列已满，返回为True. 由于线程的存在，结果也可能是不可靠的（参考q.empty（）方法）。。</span>

q<span class="token punctuation">.</span>cancel_join_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 不会再进程退出时自动连接后台线程。这可以防止join_thread()方法阻塞。</span>

q<span class="token punctuation">.</span>join_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 连接队列的后台线程。此方法用于在调用q.close()方法后，等待所有队列项被消耗。默认情况下，此方法由不是q的原始创建者的所有进程调用。调用q.cancel_join_thread()方法可以禁止这种行为。</span>
</code></pre></div><h2 id="multiprocess-queue模块的简单使用"><a href="#multiprocess-queue模块的简单使用" class="header-anchor">#</a> multiprocess.Queue模块的简单使用</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Queue

q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">## 在这里我们存储了三个数据，在实例化的时候就限制队列的大小只有三个，如果在存放，肯定会报错，我们先来个异常处理</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    q<span class="token punctuation">.</span>put_nowait<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment">## 这是不能用put,要用put_nowait，因为put是阻塞等待，如果使用put就会一直等待队列有位置了，put_nowait，就是不阻塞，如果不能写入，就报错，所以要用put_nowait</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;队列满了，如果在存储了&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">## 在这里我们取了三个数据，在实例化的时候就限制队列的大小只有三个，如果在取，肯定会报错，我们先来个异常处理</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    q<span class="token punctuation">.</span>get_nowait<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 这是不能用get,要用get_nowait，因为get是阻塞等待，如果使用get就会一直等待队列有数据了，get_nowait，就是不阻塞，如果接收到数据，就报错，所以要用put_nowait</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;队列没数据了&quot;</span><span class="token punctuation">)</span>
    
执行结果<span class="token punctuation">:</span>
队列满了，如果在存储了
<span class="token number">1</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
队列没数据了
</code></pre></div><h2 id="实验-多进程批量获取存入"><a href="#实验-多进程批量获取存入" class="header-anchor">#</a> 实验 - 多进程批量获取存入</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue<span class="token punctuation">,</span>freeze_support
<span class="token keyword">import</span> random
<span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">put_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    info <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\t:\t'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>info<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 获取到数据 ：\033[33m; %s \033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># freeze_support() 如果有windows系统开启多进程导致程序崩溃，可尝试调用此函数</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    l_put <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    l_get <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p_put <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>put_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p_put<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        l_put<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p_put<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p_get <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>get_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p_get<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        l_put<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p_get<span class="token punctuation">)</span>

    <span class="token comment"># [i.join() for i in l_put]</span>
    <span class="token comment"># [i.join() for i in l_get]</span>
</code></pre></div><p><strong>更多实验将会基于生产者消费者模型的模式来实验，就在下面</strong></p> <h1 id="基于队列实现生产者消费者模型-重点"><a href="#基于队列实现生产者消费者模型-重点" class="header-anchor">#</a> <strong>基于队列实现生产者消费者模型 - 重点</strong></h1> <p>在并发编程中使用生产者和消费者模式能够解决绝大多数并发问题。该模式通过平衡生产进程和消费进程的工作能力来提高程序的整体处理数据的速度。</p> <p>举个应用栗子：全栈开发时候，前端接收客户请求，后端处理请求逻辑。当某时刻客户请求过于多的时候，后端处理不过来，此时完全可以借助队列来辅助，将客户请求放入队列中，后端逻辑代码处理完一批客户请求后马上从队列中继续获取，这样平衡两端的效率。</p> <p><strong>为什么要使用生产者和消费者模式</strong></p> <p>在进程世界里，生产者就是生产数据的进程，消费者就是消费数据的进程。在多进程开发当中，如果生产者处理速度很快，而消费者处理速度很慢，那么生产者就必须等待消费者处理完，才能继续生产数据。同样的道理，如果消费者的处理能力大于生产者，那么消费者就必须等待生产者。为了解决这个问题于是引入了生产者和消费者模式。</p> <p><strong>什么是生产者消费者模式</strong></p> <p>生产者消费者模式是通过一个容器来解决生产者和消费者的强耦合问题。生产者和消费者彼此之间不直接通讯，而通过阻塞队列来进行通讯，所以生产者生产完数据之后不用等待消费者处理，直接扔给阻塞队列，消费者不找生产者要数据，而是直接从阻塞队列里取，阻塞队列就相当于一个缓冲区，平衡了生产者和消费者的处理能力。</p> <h2 id="实验-基于队列的生产者消费者模型"><a href="#实验-基于队列的生产者消费者模型" class="header-anchor">#</a> 实验 - 基于队列的生产者消费者模型</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Queue<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random

<span class="token keyword">def</span> <span class="token function">get_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 消费者</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 阻塞，随机阻塞时间</span>
        info <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">## 获取队列中的值</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[32m厂长拿走了%s \033[0m'</span><span class="token operator">%</span>info<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">put_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 生产者</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> <span class="token string">'娃娃%s号'</span><span class="token operator">%</span>i
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>info<span class="token punctuation">)</span>   <span class="token comment">## 把数据存入队列中</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[31m生产了%s \033[0m'</span> <span class="token operator">%</span> info<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 阻塞，随机阻塞时间</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化一个对象，设置队列最大容量为5</span>
    p_get <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>get_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化消费者对象</span>
    p_put <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>put_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化生产者对象</span>

    p_get<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 启动消费者</span>
    p_put<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 启动生产者</span>
    
<span class="token comment">## 基于队列实现的生产者消费者模型，生产者一直在生产娃娃，消费者一直在从队列中获取娃娃，但是消费者因为不知道生产者要生产多少娃娃，也不知道生产者何时就不生产了，所以消费者需要一个死循环一直尝试去从队列中获取娃娃，那么此时问题就出现了，3个进程，主进程开启了两个子进程分别为生产者和消费者，当生产者生产完数据后，生产者结束，消费者一直在尝试接收数据，那么问题就出在了消费者的get方法这里，当get不到数据时候就一直阻塞，那么主进程就一直等待，此时程序就不会结束了</span>
</code></pre></div><h2 id="实验-基于上面实验-生产者生产结束标识"><a href="#实验-基于上面实验-生产者生产结束标识" class="header-anchor">#</a> 实验 - 基于上面实验 - 生产者生产结束标识</h2> <p>解决消费者阻塞接收数据，可以尝试让生产者在生产完数据后，再往队列中放一个结束生产的信号，当消费者接受到信号后，自动的break出死循环即可</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Queue<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random

<span class="token keyword">def</span> <span class="token function">get_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 消费者</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">## 阻塞，随机阻塞时间</span>
        info <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 获取队列中的值</span>
        <span class="token keyword">if</span> info <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>	<span class="token comment">## 当获取到结束生产的标识时，消费者自动break出死循环</span>
            <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[32m厂长拿走了%s \033[0m'</span><span class="token operator">%</span>info<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">put_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">##生产者</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> <span class="token string">'娃娃%s号'</span><span class="token operator">%</span>i
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>info<span class="token punctuation">)</span>   <span class="token comment">## 向队列存入值</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[31m生产了%s \033[0m'</span> <span class="token operator">%</span> info<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 阻塞，随机阻塞时间</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token comment"># 放入一个结束生产的标识，让消费者可以识别到生产的结束</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化一个对象，设置队列最大容量为5</span>
    p_get <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>get_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化消费者对象</span>
    p_put <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>put_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化生产者对象</span>

    p_get<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 启动消费者</span>
    p_put<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 启动生产者</span>
</code></pre></div><h2 id="实验-基于上面实验-主进程生产标识"><a href="#实验-基于上面实验-主进程生产标识" class="header-anchor">#</a> 实验 - 基于上面实验 - 主进程生产标识</h2> <p>经过上一个实验，生产者放入的停止生产的标识，放入标识这件事其实交给主进程来做也可以，但是此时就需要主进程获取到生产者什么时候结束生产。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">## 第一个版本</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Queue<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random

<span class="token keyword">def</span> <span class="token function">get_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">## 消费者</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">## 阻塞，随机阻塞时间</span>
        info <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 获取队列中的值</span>
        <span class="token keyword">if</span> info <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>	<span class="token comment">## 当获取到结束生产的标识时，消费者自动break出死循环</span>
            <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[32m厂长拿走了%s \033[0m'</span><span class="token operator">%</span>info<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">put_func</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">##生产者</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> <span class="token string">'娃娃%s号'</span><span class="token operator">%</span>i
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>info<span class="token punctuation">)</span>   <span class="token comment">## 向队列存入值</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[31m生产了%s \033[0m'</span> <span class="token operator">%</span> info<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 阻塞，随机阻塞时间</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token comment"># 放入一个结束生产的标识，让消费者可以识别到生产的结束</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化一个对象，设置队列最大容量为5</span>
    p_get <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>get_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化消费者对象</span>
    p_put <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>put_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 实例化生产者对象</span>

    p_get<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 启动消费者</span>
    p_put<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 启动生产者</span>

    p_put<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 主进程等待生产者进程结束</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment">## 向队列存入结束标识，因为这一步，只有等生产者进程全部执行完毕后才能执行到</span>
    
工

<span class="token comment">## 第二个版本</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Queue<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span>name<span class="token punctuation">,</span>color<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> info<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s %s 拿走了%s \033[0m'</span><span class="token operator">%</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span>name<span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span><span class="token comment"># 当消费者获得队列中数据时，如果获得的是None，就是获得到了生产者不再生产数据的标识</span>
            <span class="token keyword">break</span><span class="token comment"># 此时消费者结束即可</span>

<span class="token comment"># 消费者如何判断，生产者是没来得及生产数据，还是生产者不再生产数据了？</span>
<span class="token comment"># 如果你尝试用get_nowait() + try 的方式去尝试获得生产者不再生产数据，此时是有问题的。</span>

<span class="token keyword">def</span> <span class="token function">producer</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span>product<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> product <span class="token operator">+</span> <span class="token string">'的娃娃%s号'</span><span class="token operator">%</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>info<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    p_pro1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>producer<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token string">'岛国米饭保你爱'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_pro2 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>producer<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token string">'苍老师版'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_pro3 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>producer<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token string">'波多多版'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_con1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token string">'alex'</span><span class="token punctuation">,</span><span class="token string">'\033[31m'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_con2 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token string">'wusir'</span><span class="token punctuation">,</span><span class="token string">'\033[32m'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_l <span class="token operator">=</span> <span class="token punctuation">[</span>p_con1<span class="token punctuation">,</span>p_con2<span class="token punctuation">,</span>p_pro1<span class="token punctuation">,</span>p_pro2<span class="token punctuation">,</span>p_pro3<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>i<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> p_l<span class="token punctuation">]</span>  <span class="token comment">##循环开启进程</span>
    <span class="token comment"># 父进程如何感知到生产者子进程不再生产数据了？</span>
    p_pro1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p_pro2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p_pro3<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 有几个消费者就要存入多少个结束标识</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>还有更好的解决方案，使用那个看个人吧，解决方案就在下一个JoinableQueue模块中</strong></p> <h1 id="multiprocess-joinablequeue队列模块-重点"><a href="#multiprocess-joinablequeue队列模块-重点" class="header-anchor">#</a> <strong>multiprocess.JoinableQueue队列模块 - 重点</strong></h1> <p>JoinableQueue模块是基于Queue队列模块的基础上，而且打开源码看，JoinableQueue模块的类是继承的Queue类，所以说，就算使用JoinableQueue模块，也是可以正常的使用Queue模块的大部分功能</p> <p>创建可连接的共享队列进程。它就好像一个Queue对象，但是它自带光环，允许消费者通知生产者是不是已经消费完所有的数据了。通知进程是使用共享的信号和条件变量来实现的</p> <h2 id="joinablequeue模块的独特方法"><a href="#joinablequeue模块的独特方法" class="header-anchor">#</a> JoinableQueue模块的独特方法</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> JoinableQueue
q <span class="token operator">=</span> JoinableQueue<span class="token punctuation">(</span>n<span class="token punctuation">)</span>  
<span class="token comment">## 实例化对象，n：代表队列的最大容量</span>
<span class="token comment">## 除了与Queue对象相同的方法之外，还具有以下方法：</span>

q<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">## 阻塞等待，等待消费者消费了所有数据，才会接着执行，用于生产者</span>
<span class="token comment">## 用于生产者。等待 q.task_done的返回结果，通过返回结果，生产者就能获得消费者当前消费了多少个数据</span>
<span class="token comment">## 生产者将使用此方法进行阻塞，直到队列中所有项目均被处理。阻塞将持续到消费者为队列中的每个数据均调用q.task_done()方法为止。 </span>

q<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">## 每获取一个队列的值，task_done就会给join返回一个标识，说我以消费了一个值，方便join记录</span>
<span class="token comment">## 用于消费者，是指每消费队列中一个数据，就给join返回一个标识。</span>
<span class="token comment">## 消费者使用此方法发出信号，表示队列中放入的数据已经被处理。如果调用此方法的次数大于从队列中获取的数据数量，将引发ValueError异常。</span>

<span class="token comment"># 假设生产者生产了100个数据，join就能记录下100这个数字。每次消费者消费一个数据，就必须要task_done返回一个标识，当生产者（join）接收到100个消费者返回来的标识的时候，生产者就能知道消费者已经把所有数据都消费完了。</span>
</code></pre></div><h2 id="实验-基于joinablequeue队列的生产者消费者模型"><a href="#实验-基于joinablequeue队列的生产者消费者模型" class="header-anchor">#</a> 实验 - 基于JoinableQueue队列的生产者消费者模型</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">## 单进程</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> JoinableQueue<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">b</span><span class="token punctuation">(</span>jq<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">##消费者</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;消费了%s元&quot;</span><span class="token operator">%</span>jq<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        jq<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 每获取一个值，就向join发送一个消费一个值的标识</span>

<span class="token keyword">def</span> <span class="token function">a</span><span class="token punctuation">(</span>jq<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">##生产者</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        jq<span class="token punctuation">.</span>put<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    jq<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 记录进程存入队列的数量，等待消费者消费，只有完全消费完毕才会结束阻塞</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    jq <span class="token operator">=</span> JoinableQueue<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    p_a <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>a<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>jq<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_b <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>b<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>jq<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_b<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment">## 把消费者设为守护进程，主进程结束，消费者进程也结束</span>
    p <span class="token operator">=</span> <span class="token punctuation">[</span>p_a<span class="token punctuation">,</span>p_b<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>i<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> p <span class="token punctuation">]</span>
    p_a<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 主进程阻塞等待生产者进程结束</span>
    
<span class="token comment"># 程序有3个进程，主进程和生产者进程和消费者进程。  当主进程执行到join()时，主进程会等待生产进程结束</span>
<span class="token comment"># 而生产进程中join()会等待消费者进程把所有数据消费完，生产者进程才结束。</span>
<span class="token comment"># 现在的状态就是主进程等待生产者进程结束，生产者进程等待消费者消费完所有数据</span>
<span class="token comment"># 所以把消费者设置为守护进程。当主进程执行完，就代表生产进程已经结束，也就代表消费者进程已经把队列中数据消费完</span>
<span class="token comment"># 此时，主进程一旦结束，守护进程也就是消费者进程也就跟着结束。整个程序也就能正常结束了。</span>


<span class="token comment">## 多进程</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> JoinableQueue<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">b</span><span class="token punctuation">(</span>jq<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">##消费者</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;消费了%s元&quot;</span><span class="token operator">%</span>jq<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        jq<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 每获取一个值，就向join发送一个消费一个值的标识</span>

<span class="token keyword">def</span> <span class="token function">a</span><span class="token punctuation">(</span>jq<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">##生产者</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        jq<span class="token punctuation">.</span>put<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    jq<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 记录进程存入队列的数量，等待消费者消费，只有完全消费完毕才会结束阻塞</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    jq <span class="token operator">=</span> JoinableQueue<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    pa <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    pb <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p_a <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>a<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>jq<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pa<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p_a<span class="token punctuation">)</span>
        p_b <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>b<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>jq<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pb<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p_b<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> pb<span class="token punctuation">:</span>  <span class="token comment">## 把消费者设为守护进程，主进程结束，消费者进程也结束</span>
        i<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token punctuation">[</span>i<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> pa<span class="token operator">+</span>pb <span class="token punctuation">]</span>
    <span class="token punctuation">[</span>i<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> pa<span class="token punctuation">]</span>  <span class="token comment">## 主进程阻塞等待生产者进程结束</span>
</code></pre></div><h1 id="multiprocessing-pipe管道模块-了解"><a href="#multiprocessing-pipe管道模块-了解" class="header-anchor">#</a> multiprocessing.Pipe管道模块 - 了解</h1> <p>管道是不安全的，管道是用于多进程之间通信的一种方式</p> <h2 id="pipe模块的方法介绍"><a href="#pipe模块的方法介绍" class="header-anchor">#</a> Pipe模块的方法介绍</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pipe

conn1<span class="token punctuation">,</span>conn2 <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 在进程之间创建一条管道，并返回元组（conn1,conn2）,其中conn1，conn2表示管道两端的连接对象，强调一点：必须在产生Process对象之前产生管道</span>

<span class="token comment"># 如果在单进程中使用管道，</span>
	<span class="token comment"># 那么就是conn1收数据，就是conn2发数据。</span>
	<span class="token comment"># 如果是conn1发数据，就是conn2收数据</span>

<span class="token comment"># 如果在多进程中使用管道，那么就必须是父进程使用conn1收，子进程就必须使用conn2发</span>
	<span class="token comment"># 父进程使用conn1发，子进程就必须使用conn2收</span>
	<span class="token comment"># 父进程使用conn2收，子进程就必须使用conn1发</span>
	<span class="token comment"># 父进程使用conn2发，子进程就必须使用conn1收</span>

<span class="token comment"># 在管道中有一个著名的错误叫做EOFError。是指，父进程中如果关闭了发送端，子进程还继续接收数据，那么就会引发EOFError。</span>

dumplex  <span class="token comment"># 默认管道是全双工的，即conn1和conn2都是既能收数据也能发数据的，如果将duplex设成False，conn1只能用于接收，conn2只能用于发送。</span>

<span class="token comment">#主要方法：</span>
conn1<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 接收conn2.send(obj)发送的对象。如果没有消息可接收，recv方法会一直阻塞。如果连接的另外一端已经关闭，那么recv方法会抛出EOFError。</span>
conn1<span class="token punctuation">.</span>send<span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment"># 通过连接发送对象。obj是与序列化兼容的任意对象</span>

<span class="token comment">#其他方法：</span>
conn1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#关闭连接。如果conn1被垃圾回收，将自动调用此方法</span>
conn1<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#返回连接使用的整数文件描述符</span>
conn1<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">[</span>timeout<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#如果连接上的数据可用，返回True。timeout指定等待的最长时限。如果省略此参数，方法将立即返回结果。如果将timeout设成None，操作将无限期地等待数据到达。</span>
 
conn1<span class="token punctuation">.</span>recv_bytes<span class="token punctuation">(</span><span class="token punctuation">[</span>maxlength<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#接收c.send_bytes()方法发送的一条完整的字节消息。maxlength指定要接收的最大字节数。如果进入的消息，超过了这个最大值，将引发IOError异常，并且在连接上无法进行进一步读取。如果连接的另外一端已经关闭，再也不存在任何数据，将引发EOFError异常。</span>

conn<span class="token punctuation">.</span>send_bytes<span class="token punctuation">(</span><span class="token builtin">buffer</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> offset <span class="token punctuation">[</span><span class="token punctuation">,</span> size<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#通过连接发送字节数据缓冲区，buffer是支持缓冲区接口的任意对象，offset是缓冲区中的字节偏移量，而size是要发送字节数。结果数据以单条消息的形式发出，然后调用c.recv_bytes()函数进行接收    </span>
 
conn1<span class="token punctuation">.</span>recv_bytes_into<span class="token punctuation">(</span><span class="token builtin">buffer</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> offset<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#接收一条完整的字节消息，并把它保存在buffer对象中，该对象支持可写入的缓冲区接口（即bytearray对象或类似的对象）。offset指定缓冲区中放置消息处的字节位移。返回值是收到的字节数。如果消息长度大于可用的缓冲区空间，将引发BufferTooShort异常。</span>
</code></pre></div><h2 id="pipe模块的简单使用"><a href="#pipe模块的简单使用" class="header-anchor">#</a> Pipe模块的简单使用</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Pipe
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">son</span><span class="token punctuation">(</span>conn2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">## 阻塞暂停1秒</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 接收来自conn1发送的数据</span>
    conn2<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'我是你爷爷'</span><span class="token punctuation">)</span>  <span class="token comment">## 发送给conn1的数据</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    conn1<span class="token punctuation">,</span> conn2 <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>son<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>conn2<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn1<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'我是你爸爸!'</span><span class="token punctuation">)</span>  <span class="token comment"># 发送给conn2的数据</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>conn1<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 接收来自conn2的数据</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="实例-多进程-无限接收数据异常"><a href="#实例-多进程-无限接收数据异常" class="header-anchor">#</a> 实例 - 多进程，无限接收数据异常</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pipe<span class="token punctuation">,</span>Process

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">:</span>
    con1<span class="token punctuation">,</span>con2 <span class="token operator">=</span> con
    con1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 子进程使用con2和父进程通信</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>con2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#当主进程的con1发数据时，子进程要死循环的去接收。</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span><span class="token comment"># 如果主进程的con1发完数据并关闭con1，子进程的con2继续接收时，就会报错，使用try的方式，获取错误</span>
            con2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 获取到错误，就是指子进程已经把管道中所有数据都接收完了，所以用这种方式去关闭管道</span>
            <span class="token keyword">break</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    con1<span class="token punctuation">,</span>con2 <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>con1<span class="token punctuation">,</span>con2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    con2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 在父进程中，使用con1去和子进程通信，所以不需要con2，就提前关闭</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment"># 生产数据</span>
        con1<span class="token punctuation">.</span>send<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment"># 给子进程的con2发送数据</span>
    con1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 生产完数据，关闭父进程这一端的管道</span>
    
<span class="token comment">## 如果发送端发送完了数据，关闭了通道，那么接收端，还在接收就会报EOFError错误，所以，要做一个异常处理，让程序可以不停止的运行</span>
</code></pre></div><h2 id="实验-基于pipe管道的生产者消费者模型"><a href="#实验-基于pipe管道的生产者消费者模型" class="header-anchor">#</a> 实验 - 基于Pipe管道的生产者消费者模型</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pipe<span class="token punctuation">,</span> Process
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random


<span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> man<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn1<span class="token punctuation">,</span> conn2 <span class="token operator">=</span> conn
    conn1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 关闭当前进程conn1的管道通道</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            info <span class="token operator">=</span> conn2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 接收来自conn1的数据</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 随机暂停</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[31m%s 取走了%s\033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>man<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>  <span class="token comment">## 如果conn1发送端发送了所有的数据，关闭了管道，就会报EOFError错误，所以要做一个异常处理</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[32m没有娃娃了，等下一期吧\033[0m'</span><span class="token punctuation">)</span>
            conn2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>  <span class="token comment"># 借助肯定产生的EOFError异常来让程序结束</span>


<span class="token keyword">def</span> <span class="token function">producer</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> pro<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn1<span class="token punctuation">,</span> conn2 <span class="token operator">=</span> conn
    conn2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 关闭当前进程的conn2的管道通道</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> <span class="token string">'%s 的娃娃%s号'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pro<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        conn1<span class="token punctuation">.</span>send<span class="token punctuation">(</span>info<span class="token punctuation">)</span>  <span class="token comment">## 向conn2发送数据</span>
    conn1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 所有数据发送完毕后，关闭管道</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    conn1<span class="token punctuation">,</span> conn2 <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cons1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'alex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 实例化一个对象</span>
    prod1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>producer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'苍老师版'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## 实例化一个对象</span>
    cons1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    prod1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    conn1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 关闭当前进程conn1的管道通道</span>
    conn2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 关闭当前进程conn2的管道通道</span>
    <span class="token comment"># 不写的话，消费者进程结束不了。 一定要记住，多进程中内核会对每个进程的管道进行计数，必须在所有进程中都关闭管道才会引发EOFError异常</span>
</code></pre></div><h2 id="实验-多消费者竞争数据带来数据不安全问题"><a href="#实验-多消费者竞争数据带来数据不安全问题" class="header-anchor">#</a> 实验 - 多消费者竞争数据带来数据不安全问题</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pipe<span class="token punctuation">,</span> Process<span class="token punctuation">,</span> Lock

<span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> man<span class="token punctuation">,</span>color<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn1<span class="token punctuation">,</span> conn2 <span class="token operator">=</span> conn
    conn1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        l<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        info <span class="token operator">=</span> conn2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        l<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> info<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[%s %s 取走了%s\033[0m'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>color<span class="token punctuation">,</span>man<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            conn2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

<span class="token keyword">def</span> <span class="token function">producer</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> pro<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn1<span class="token punctuation">,</span> conn2 <span class="token operator">=</span> conn
    conn2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        info <span class="token operator">=</span> <span class="token string">'%s 的娃娃%s号'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pro<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        conn1<span class="token punctuation">.</span>send<span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    conn1<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    conn1<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    conn1<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    conn1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    conn1<span class="token punctuation">,</span> conn2 <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    l <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cons1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'alex'</span><span class="token punctuation">,</span><span class="token string">'31m'</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cons2 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Wusir'</span><span class="token punctuation">,</span><span class="token string">'33m'</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cons3 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'太白'</span><span class="token punctuation">,</span><span class="token string">'34m'</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cons4 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'彦涛'</span><span class="token punctuation">,</span><span class="token string">'35m'</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cons5 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'AAA'</span><span class="token punctuation">,</span><span class="token string">'36m'</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cons6 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>consumer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'BBB'</span><span class="token punctuation">,</span><span class="token string">'37m'</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
    prod1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>producer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'苍老师版'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    prod2 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>producer<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> conn2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'韩红版'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    l_p <span class="token operator">=</span> <span class="token punctuation">[</span>cons1<span class="token punctuation">,</span>
           cons2<span class="token punctuation">,</span>
           cons3<span class="token punctuation">,</span>
           cons4<span class="token punctuation">,</span>
           cons5<span class="token punctuation">,</span>
           cons6<span class="token punctuation">,</span>
           prod1<span class="token punctuation">,</span>
           prod2<span class="token punctuation">,</span>
           <span class="token punctuation">]</span>
    <span class="token punctuation">[</span>i<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> l_p<span class="token punctuation">]</span>

    conn1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token punctuation">[</span>i<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> l_p<span class="token punctuation">]</span>
</code></pre></div><h1 id="multiprocessing-manager进程共享内存模块"><a href="#multiprocessing-manager进程共享内存模块" class="header-anchor">#</a> multiprocessing.Manager进程共享内存模块</h1> <p>基于消息传递的并发编程是大势所趋</p> <p>即便是使用线程，推荐做法也是将程序设计为大量独立的线程集合，通过消息队列交换数据。</p> <p>这样极大地减少了对使用锁定和其他同步手段的需求，还可以扩展到分布式系统中。</p> <p>但进程间应该尽量避免通信，即便需要通信，也应该选择进程安全的工具来避免加锁带来的问题。</p> <p>以后我们会尝试使用数据库来解决现在进程之间的数据共享问题。</p> <p>进程间数据是独立的，可以借助于队列或管道实现通信，二者都是基于消息传递的</p> <p>虽然进程间数据独立，但可以通过Manager实现数据共享，事实上Manager的功能远不止于此</p> <h2 id="manager模块的方法介绍"><a href="#manager模块的方法介绍" class="header-anchor">#</a> Manager模块的方法介绍</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span>Manager

m <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
num <span class="token operator">=</span> m<span class="token punctuation">.</span>类型<span class="token punctuation">(</span>数据<span class="token punctuation">)</span>

<span class="token comment">## 常用类型</span>
num <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">{</span>键 <span class="token punctuation">:</span> 值<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">## 以元组类型传输</span>
num <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment">## 以列表类型传输</span>

<span class="token comment">## 类型有：list,dict,Namespace,Lock,RLock,Semaphore,BoundedSemaphore,Condition,Event,Queue,Value和Array</span>
</code></pre></div><h2 id="manager模块的简单使用"><a href="#manager模块的简单使用" class="header-anchor">#</a> Manager模块的简单使用</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span>Manager

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    num<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'子进程中的num的值是'</span><span class="token punctuation">,</span>num<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'父进程中的num的值是'</span><span class="token punctuation">,</span>num<span class="token punctuation">)</span>
</code></pre></div><h2 id="实验-多进程的变量共享"><a href="#实验-多进程的变量共享" class="header-anchor">#</a> 实验 - 多进程的变量共享</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Manager<span class="token punctuation">,</span>Process<span class="token punctuation">,</span>Lock

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>dic<span class="token punctuation">,</span>lock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># lock.acquire() # 使用manager模块，多进程共享数据时，如果不加锁，必然会造成数据混乱</span>
    dic<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span>
    <span class="token comment"># lock.release()</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> l<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="multiprocessing-pool进程池模块-重点"><a href="#multiprocessing-pool进程池模块-重点" class="header-anchor">#</a> <strong>multiprocessing.Pool进程池模块 - 重点</strong></h1> <p><strong>进程池：</strong></p> <ol><li>一个池子，里边有固定数量的进程。这些进程一直处于待命状态，一旦有任务来，马上就有进程去处理。</li> <li>因为在实际业务中，任务量是有多有少的，如果任务量特别的多，不可能要开对应那么多的进程数</li> <li>开启那么多进程首先就需要消耗大量的时间让操作系统来为你管理它。其次还需要消耗大量时间让,cpu帮你调度它。</li> <li>进程池还会帮程序员去管理池中的进程。</li></ol> <p>为什么要有进程池?进程池的概念。</p> <p>在程序实际处理问题过程中，忙时会有成千上万的任务需要被执行，闲时可能只有零星任务。那么在成千上万个任务需要被执行的时候，我们就需要去创建成千上万个进程么？首先，创建进程需要消耗时间，销毁进程也需要消耗时间。第二即便开启了成千上万的进程，操作系统也不能让他们同时执行，这样反而会影响程序的效率。因此我们不能无限制的根据任务开启或者结束进程。那么我们要怎么做呢？</p> <p>在这里，要给大家介绍一个进程池的概念，定义一个池子，在里面放上固定数量的进程，有需求来了，就拿这个池中的进程来处理任务，等到处理完毕，进程并不结束，而是将进程再放回进程池中继续等待任务。如果有很多任务需要执行，池中的进程数量不够，任务就要等待之前的进程执行任务完毕归来，拿到空闲进程才能继续执行。也就是说，池中进程的数量是固定的，那么同一时间最多有固定数量的进程在运行。这样不会增加操作系统的调度难度，还节省了开闭进程的时间，也一定程度上能够实现并发效果。</p> <h2 id="pool模块的方法介绍"><a href="#pool模块的方法介绍" class="header-anchor">#</a> Pool模块的方法介绍</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
p <span class="token operator">=</span> Pool<span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token comment">## 实例化一个对象，n：代表进程池中有多少进程，一般是电脑内核+1，可以用os模块的cpu_count()，来计算电脑有多少内核，os.cpu_count() + 1</span>

进程池有三个启动模式：
<span class="token builtin">map</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span>iterable<span class="token punctuation">)</span> <span class="token comment"># 可迭代对象模式</span>
    func：进程池中的进程执行的任务函数
    iterable<span class="token punctuation">:</span> 可迭代对象，是把可迭代对象中的每个元素依次传给任务函数当参数，可以使用列表表达式
        
<span class="token builtin">apply</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>： <span class="token comment"># 同步模式，同步的效率：也就是说池中的进程一个一个的去执行任务</span>
    func：进程池中的进程执行的任务函数
    args<span class="token punctuation">:</span> 可迭代对象型的参数，是传给任务函数的参数
        同步处理任务时，不需要close和join
        同步处理任务时，进程池中的所有进程是普通进程（主进程需要等待其执行结束）
        
apply_async<span class="token punctuation">(</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>callback<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>： 异步的效率，也就是说池中的进程一次性都去执行任务
    func：进程池中的进程执行的任务函数
    args<span class="token punctuation">:</span> 可迭代对象型的参数，是传给任务函数的参数
         异步处理任务时，进程池中的所有进程是守护进程（主进程代码执行完毕守护进程就结束）
         异步处理任务时，必须要加上close和join
        
    callback<span class="token punctuation">:</span> 回调函数，就是说每当进程池中有进程处理完任务了，返回的结果可以交给回调函数，由回调函数进行进一步的处理<span class="token punctuation">,</span>回调函数只有异步才有，同步是没有的
	回调函数的使用：
             进程的任务函数的返回值，被当成回调函数的形参接收到，以此进行进一步的处理操作
             回调函数是由主进程调用的，而不是子进程，子进程只负责把结果传递给回调函数
            
            
其他方法：

p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 关闭进程池，防止进一步操作。如果所有操作持续挂起，它们将在工作进程终止前完成</span>
P<span class="token punctuation">.</span>jion<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 等待所有工作进程退出。此方法只能在close（）或teminate()之后调用</span>
<span class="token comment">## 一般这二个同时使用，要先关闭进程池，在等待所有进程退出，后退出</span>


obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 返回结果，如果有必要则等待结果到达。timeout是可选的。如果在指定时间内还没有到达，将引发一场。如果远程操作中引发了异常，它将在调用此方法时再次被引发。</span>

obj<span class="token punctuation">.</span>ready<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 如果调用完成，返回True</span>

obj<span class="token punctuation">.</span>successful<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 如果调用完成且没有引发异常，返回True，如果在结果就绪之前调用此方法，引发异常</span>

obj<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">[</span>timeout<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">## 等待结果变为可用。</span>

obj<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 立即终止所有工作进程，同时不执行任何清理或结束任何挂起工作。如果p被垃圾回收，将自动调用此函数</span>
</code></pre></div><h2 id="实验-进程池和多进程效率对比"><a href="#实验-进程池和多进程效率对比" class="header-anchor">#</a> 实验 - 进程池和多进程效率对比</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    i <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment"># 创建进程池，池中有4个进程待命</span>
    
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">## 使用列表表达式迭代值供给对象使用</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">## 关闭进程池，不让外部任务进入进程池</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment"># 等待进程池中所有进程都执行完所有任务。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token comment"># 打印进程池做任务的时间</span>
    
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>i<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> l<span class="token punctuation">]</span><span class="token comment"># 等待所有进程工作结束</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token comment"># 打印开启100个进程做任务的时间</span>

执行结果：
<span class="token number">0.5006439685821533</span>
<span class="token number">13.25691270828247</span>
</code></pre></div><h2 id="实验-进程池的同步调用模式"><a href="#实验-进程池的同步调用模式" class="header-anchor">#</a> 实验 - 进程池的同步调用模式</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    i<span class="token operator">+=</span> <span class="token number">1</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## os.getpid()：查看当前进程的PID</span>
    <span class="token keyword">return</span> i  <span class="token comment">## 返回值，返回给调用者</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment"># 创建进程池，池中有5个进程待命</span>
    res_l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 有10个任务来，交给进程池中5个进程，5个进程同步执行任务直到拿到res</span>
        res_l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>res<span class="token punctuation">)</span>  <span class="token comment">## 把获取到的返回值，增加到列表中</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>res_l<span class="token punctuation">)</span>
</code></pre></div><h2 id="实验-进程池的异步调用模式"><a href="#实验-进程池的异步调用模式" class="header-anchor">#</a> 实验 - 进程池的异步调用模式</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">import</span> time<span class="token punctuation">,</span>os

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    i<span class="token operator">+=</span> <span class="token number">1</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">## os.getpid()：查看当前进程的PID</span>
    <span class="token keyword">return</span> i <span class="token comment">## 返回值，返回给调用者</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment"># 创建进程池，池中有5个进程待命</span>
    res_l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> p<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>func<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 异步执行10个任务，每次最多5个进程同时运行</span>
        res_l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">## 把获取到的返回值，增加到列表中</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 异步执行需要join，也就是让主进程等待进程池中所有进程执行完所有任务，否则可能进程池中的进程还没来得及执行任务，主进程就结束了。</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> res_l<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">## 异步要查看返回值，需要加上.get()方法</span>
        
<span class="token comment"># 异步机制，从res的实例obj中get到实际结果，同步机制没有此方法</span>
<span class="token comment"># 因为同步机制能直接拿到实际结果</span>
<span class="token comment"># 其实get是阻塞等待的，也就是说，如果没有上边的close和join ：</span>
<span class="token comment"># 主进程一样会阻塞在get等待进程池中给返回结果，进程池异步执行任务获取结果</span>
<span class="token comment"># 每次有一个进程返回结果后，就能get到一个结果，然后for循环到下一次继续阻塞等待拿结果</span>
</code></pre></div><h2 id="实验-同步跟异步模式效率的对比"><a href="#实验-同步跟异步模式效率的对比" class="header-anchor">#</a> 实验 - 同步跟异步模式效率的对比</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">num</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    i <span class="token operator">+=</span> <span class="token number">10</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token comment">## 同步模式</span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rse <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span>

    <span class="token comment">## 异步模式</span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rse <span class="token operator">=</span> p<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>num<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span>
    
执行结果：
<span class="token number">28.188576459884644</span>
<span class="token number">14.340880870819092</span>
</code></pre></div><h2 id="实验-进程池的异步模式的回调函数"><a href="#实验-进程池的异步模式的回调函数" class="header-anchor">#</a> 实验 - 进程池的异步模式的回调函数</h2> <p>回调函数的使用：</p> <ol><li><p>进程的任务函数的返回值，被当成回调函数的形参接收到，以此进行进一步的处理操作</p></li> <li><p>回调函数是由主进程调用的，而不是子进程，子进程只负责把结果传递给回调函数</p></li></ol> <p><strong>注意：</strong> 回调函数只能在异步模式的时候使用</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">num</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ia <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">10</span>
    <span class="token keyword">return</span> i<span class="token punctuation">,</span>ia  <span class="token comment">##返回</span>

<span class="token keyword">def</span> <span class="token function">dock</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    i<span class="token punctuation">,</span>ia <span class="token operator">=</span> num
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s波，回调函数输出，回调函数的PID：%s&quot;</span> <span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rse <span class="token operator">=</span> p<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>num<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>callback<span class="token operator">=</span>dock<span class="token punctuation">)</span>  <span class="token comment">## 实例化一个对象，如果有回调函数，默认把进程的返回值，当做参数发送给回调函数指定的函数的参数中，并执行这函数</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主进程的PID：&quot;</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    
执行结果：
<span class="token comment">## 只显示几行结果内容</span>
第<span class="token number">99999</span>波，回调函数输出，回调函数的PID：<span class="token number">15464</span>
主进程的PID： <span class="token number">15464</span>

<span class="token comment">## 注意，回调函数不是子进程调用的，是主进程调用的</span>
</code></pre></div><h2 id="实验-进程池实现socket并发聊天"><a href="#实验-进程池实现socket并发聊天" class="header-anchor">#</a> 实验 - 进程池实现socket并发聊天</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">## 服务端文件</span>
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">import</span> socket

SOURCE_ADDR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">8090</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">communication</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            msg_r <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> msg_r<span class="token punctuation">:</span> <span class="token keyword">break</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>msg_r<span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg_r<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>  <span class="token comment"># 可能接收比如客户端直接强制断开连接等错误。</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>SOURCE_ADDR<span class="token punctuation">)</span>
    sk<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> sk<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>communication<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        

<span class="token comment">## 客户端文件</span>
<span class="token keyword">import</span> socket

sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
SOURCE_ADDR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8090</span><span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>SOURCE_ADDR<span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    msg_s <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt;'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> msg_s<span class="token punctuation">:</span><span class="token keyword">continue</span>
    sk<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg_s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sk<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token comment">## 并发开启多个客户端，服务端同一时间只能接收4个客端的请求，当再有客户端请求时，需要等待，只能结束一个客户端，另外一个客户端才会进来</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/4. Python-network/49. 进程 - 理论知识.html" class="prev">
        49. 进程 - 理论知识
      </a></span> <span class="next"><a href="/Python/4. Python-network/51. 线程 - 理念知识.html">
        51. 线程 - 理念知识
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d65bef42.js" defer></script><script src="/assets/js/2.2249178e.js" defer></script><script src="/assets/js/116.ea3cfdfb.js" defer></script>
  </body>
</html>
