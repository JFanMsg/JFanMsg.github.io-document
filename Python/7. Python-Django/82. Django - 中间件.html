<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>82. Django - 中间件 | MSG</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="在追寻技术的同时享受生活">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.d65bef42.js" as="script"><link rel="preload" href="/assets/js/2.2249178e.js" as="script"><link rel="preload" href="/assets/js/155.5a9840ea.js" as="script"><link rel="prefetch" href="/assets/js/10.4785e2e5.js"><link rel="prefetch" href="/assets/js/100.33fceff2.js"><link rel="prefetch" href="/assets/js/101.62e1e5d4.js"><link rel="prefetch" href="/assets/js/102.8551fe71.js"><link rel="prefetch" href="/assets/js/103.47754d79.js"><link rel="prefetch" href="/assets/js/104.4adf114f.js"><link rel="prefetch" href="/assets/js/105.6206a08a.js"><link rel="prefetch" href="/assets/js/106.1c4561f3.js"><link rel="prefetch" href="/assets/js/107.e1531a5a.js"><link rel="prefetch" href="/assets/js/108.c637743a.js"><link rel="prefetch" href="/assets/js/109.3f150913.js"><link rel="prefetch" href="/assets/js/11.bd8ec7a6.js"><link rel="prefetch" href="/assets/js/110.088c1ac3.js"><link rel="prefetch" href="/assets/js/111.66d8d491.js"><link rel="prefetch" href="/assets/js/112.231663ee.js"><link rel="prefetch" href="/assets/js/113.a38bc531.js"><link rel="prefetch" href="/assets/js/114.e165daea.js"><link rel="prefetch" href="/assets/js/115.994b087a.js"><link rel="prefetch" href="/assets/js/116.ea3cfdfb.js"><link rel="prefetch" href="/assets/js/117.7be5e4f3.js"><link rel="prefetch" href="/assets/js/118.ebb58ddb.js"><link rel="prefetch" href="/assets/js/119.90018646.js"><link rel="prefetch" href="/assets/js/12.0d8f43df.js"><link rel="prefetch" href="/assets/js/120.bb5be863.js"><link rel="prefetch" href="/assets/js/121.3d1db670.js"><link rel="prefetch" href="/assets/js/122.d29ed1b2.js"><link rel="prefetch" href="/assets/js/123.38cc4704.js"><link rel="prefetch" href="/assets/js/124.cc8549d4.js"><link rel="prefetch" href="/assets/js/125.6ee3e9c8.js"><link rel="prefetch" href="/assets/js/126.48710eba.js"><link rel="prefetch" href="/assets/js/127.d7a1fd83.js"><link rel="prefetch" href="/assets/js/128.e5017f6b.js"><link rel="prefetch" href="/assets/js/129.4c33e121.js"><link rel="prefetch" href="/assets/js/13.2dbde7aa.js"><link rel="prefetch" href="/assets/js/130.cda66247.js"><link rel="prefetch" href="/assets/js/131.ad76f669.js"><link rel="prefetch" href="/assets/js/132.aca88758.js"><link rel="prefetch" href="/assets/js/133.a1cf5903.js"><link rel="prefetch" href="/assets/js/134.b1386377.js"><link rel="prefetch" href="/assets/js/135.94edcf53.js"><link rel="prefetch" href="/assets/js/136.24be4170.js"><link rel="prefetch" href="/assets/js/137.db57772e.js"><link rel="prefetch" href="/assets/js/138.dc67bcaa.js"><link rel="prefetch" href="/assets/js/139.5453d1f6.js"><link rel="prefetch" href="/assets/js/14.2187dbf4.js"><link rel="prefetch" href="/assets/js/140.938e5c07.js"><link rel="prefetch" href="/assets/js/141.99c7cf2c.js"><link rel="prefetch" href="/assets/js/142.428e3958.js"><link rel="prefetch" href="/assets/js/143.68b01530.js"><link rel="prefetch" href="/assets/js/144.f67389cc.js"><link rel="prefetch" href="/assets/js/145.d952a130.js"><link rel="prefetch" href="/assets/js/146.b933dcad.js"><link rel="prefetch" href="/assets/js/147.2d8e4c0a.js"><link rel="prefetch" href="/assets/js/148.6d76ac94.js"><link rel="prefetch" href="/assets/js/149.6b4d6378.js"><link rel="prefetch" href="/assets/js/15.a53b356c.js"><link rel="prefetch" href="/assets/js/150.5bf39cb4.js"><link rel="prefetch" href="/assets/js/151.17af677c.js"><link rel="prefetch" href="/assets/js/152.7f1c2792.js"><link rel="prefetch" href="/assets/js/153.98dd0727.js"><link rel="prefetch" href="/assets/js/154.eb44bf23.js"><link rel="prefetch" href="/assets/js/156.7ba01fd0.js"><link rel="prefetch" href="/assets/js/157.2296a048.js"><link rel="prefetch" href="/assets/js/158.6bb1f699.js"><link rel="prefetch" href="/assets/js/159.073bb8df.js"><link rel="prefetch" href="/assets/js/16.cef7bf44.js"><link rel="prefetch" href="/assets/js/160.25a837f9.js"><link rel="prefetch" href="/assets/js/161.93d886a1.js"><link rel="prefetch" href="/assets/js/162.5d2714b2.js"><link rel="prefetch" href="/assets/js/17.96f36904.js"><link rel="prefetch" href="/assets/js/18.fd04b310.js"><link rel="prefetch" href="/assets/js/19.3e1377d1.js"><link rel="prefetch" href="/assets/js/20.ac195ac8.js"><link rel="prefetch" href="/assets/js/21.c2d7729c.js"><link rel="prefetch" href="/assets/js/22.dd8c621b.js"><link rel="prefetch" href="/assets/js/23.ad7d0350.js"><link rel="prefetch" href="/assets/js/24.8559c4c3.js"><link rel="prefetch" href="/assets/js/25.783a8116.js"><link rel="prefetch" href="/assets/js/26.25e0e459.js"><link rel="prefetch" href="/assets/js/27.c0616e2a.js"><link rel="prefetch" href="/assets/js/28.30656c2e.js"><link rel="prefetch" href="/assets/js/29.2be5114c.js"><link rel="prefetch" href="/assets/js/3.be8c8f3b.js"><link rel="prefetch" href="/assets/js/30.230a74a7.js"><link rel="prefetch" href="/assets/js/31.760f46ad.js"><link rel="prefetch" href="/assets/js/32.c9533fef.js"><link rel="prefetch" href="/assets/js/33.dcacfb38.js"><link rel="prefetch" href="/assets/js/34.4370a466.js"><link rel="prefetch" href="/assets/js/35.bf299eea.js"><link rel="prefetch" href="/assets/js/36.336e435a.js"><link rel="prefetch" href="/assets/js/37.1d1d2eea.js"><link rel="prefetch" href="/assets/js/38.0d58b7d0.js"><link rel="prefetch" href="/assets/js/39.d43564ba.js"><link rel="prefetch" href="/assets/js/4.4a6cb970.js"><link rel="prefetch" href="/assets/js/40.bc4e4bde.js"><link rel="prefetch" href="/assets/js/41.b71231a5.js"><link rel="prefetch" href="/assets/js/42.9d46f400.js"><link rel="prefetch" href="/assets/js/43.50c5be69.js"><link rel="prefetch" href="/assets/js/44.60406e7f.js"><link rel="prefetch" href="/assets/js/45.ec3569ae.js"><link rel="prefetch" href="/assets/js/46.1bd3ce7b.js"><link rel="prefetch" href="/assets/js/47.1e1b5326.js"><link rel="prefetch" href="/assets/js/48.64c631ea.js"><link rel="prefetch" href="/assets/js/49.b4abacd8.js"><link rel="prefetch" href="/assets/js/5.e6d0b165.js"><link rel="prefetch" href="/assets/js/50.c3e320c0.js"><link rel="prefetch" href="/assets/js/51.5ec7fb8c.js"><link rel="prefetch" href="/assets/js/52.2d234f86.js"><link rel="prefetch" href="/assets/js/53.f3b69623.js"><link rel="prefetch" href="/assets/js/54.c85ff450.js"><link rel="prefetch" href="/assets/js/55.b07597b5.js"><link rel="prefetch" href="/assets/js/56.444129cf.js"><link rel="prefetch" href="/assets/js/57.df1329ba.js"><link rel="prefetch" href="/assets/js/58.5afb51cf.js"><link rel="prefetch" href="/assets/js/59.d98936d9.js"><link rel="prefetch" href="/assets/js/6.809376cd.js"><link rel="prefetch" href="/assets/js/60.02813ecf.js"><link rel="prefetch" href="/assets/js/61.37a4812d.js"><link rel="prefetch" href="/assets/js/62.5da94048.js"><link rel="prefetch" href="/assets/js/63.8e2c2bca.js"><link rel="prefetch" href="/assets/js/64.d290398f.js"><link rel="prefetch" href="/assets/js/65.44e28313.js"><link rel="prefetch" href="/assets/js/66.9acf0206.js"><link rel="prefetch" href="/assets/js/67.85688aa2.js"><link rel="prefetch" href="/assets/js/68.45bda7fc.js"><link rel="prefetch" href="/assets/js/69.9074feb0.js"><link rel="prefetch" href="/assets/js/7.5d7bce6e.js"><link rel="prefetch" href="/assets/js/70.b4cd2ddc.js"><link rel="prefetch" href="/assets/js/71.53219b13.js"><link rel="prefetch" href="/assets/js/72.af2a7290.js"><link rel="prefetch" href="/assets/js/73.c28fc506.js"><link rel="prefetch" href="/assets/js/74.64c81a90.js"><link rel="prefetch" href="/assets/js/75.05191ece.js"><link rel="prefetch" href="/assets/js/76.f516d464.js"><link rel="prefetch" href="/assets/js/77.c345180b.js"><link rel="prefetch" href="/assets/js/78.4a09d0ba.js"><link rel="prefetch" href="/assets/js/79.65f41bcf.js"><link rel="prefetch" href="/assets/js/8.f6cfdc07.js"><link rel="prefetch" href="/assets/js/80.b77151f3.js"><link rel="prefetch" href="/assets/js/81.824fa371.js"><link rel="prefetch" href="/assets/js/82.3f91c09b.js"><link rel="prefetch" href="/assets/js/83.9539f074.js"><link rel="prefetch" href="/assets/js/84.dd89f1de.js"><link rel="prefetch" href="/assets/js/85.15210b99.js"><link rel="prefetch" href="/assets/js/86.e14553e1.js"><link rel="prefetch" href="/assets/js/87.6dc95177.js"><link rel="prefetch" href="/assets/js/88.09c5e890.js"><link rel="prefetch" href="/assets/js/89.0d61f4d0.js"><link rel="prefetch" href="/assets/js/9.759f1986.js"><link rel="prefetch" href="/assets/js/90.a9b14d80.js"><link rel="prefetch" href="/assets/js/91.1a4aabe2.js"><link rel="prefetch" href="/assets/js/92.12070bdb.js"><link rel="prefetch" href="/assets/js/93.b5dc76d0.js"><link rel="prefetch" href="/assets/js/94.690498a6.js"><link rel="prefetch" href="/assets/js/95.b17961e6.js"><link rel="prefetch" href="/assets/js/96.a2f06f3e.js"><link rel="prefetch" href="/assets/js/97.64ef6721.js"><link rel="prefetch" href="/assets/js/98.443eba26.js"><link rel="prefetch" href="/assets/js/99.b6ba7c3a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">MSG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python文档" class="dropdown-title"><span class="title">Python文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python文档" class="mobile-dropdown-title"><span class="title">Python文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/1.Python-Basics/" class="nav-link">
  Python-基础
</a></li><li class="dropdown-item"><!----> <a href="/Python/2. Python-object/" class="nav-link">
  Python-面向对象
</a></li><li class="dropdown-item"><!----> <a href="/Python/3. Python-module/" class="nav-link">
  Python-模块与包
</a></li><li class="dropdown-item"><!----> <a href="/Python/4. Python-network/" class="nav-link">
  Python-网络
</a></li><li class="dropdown-item"><!----> <a href="/Python/5. Python-frontend/" class="nav-link">
  Python-前端
</a></li><li class="dropdown-item"><!----> <a href="/Python/6. Python-MySQL/" class="nav-link">
  Python-数据库
</a></li><li class="dropdown-item"><!----> <a href="/Python/7. Python-Django/" class="nav-link">
  Python-Django
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器文档" class="dropdown-title"><span class="title">容器文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器文档" class="mobile-dropdown-title"><span class="title">容器文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Container/docker/" class="nav-link">
  docker文檔
</a></li><li class="dropdown-item"><!----> <a href="/Container/Kubernetes/" class="nav-link">
  Kubernetes文檔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GO文档" class="dropdown-title"><span class="title">GO文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="GO文档" class="mobile-dropdown-title"><span class="title">GO文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GO/basics/" class="nav-link">
  GO快速入门
</a></li><li class="dropdown-item"><!----> <a href="/GO/module/" class="nav-link">
  GO标准库/GO模块
</a></li></ul></div></div><div class="nav-item"><a href="https://www.linux91.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python文档" class="dropdown-title"><span class="title">Python文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python文档" class="mobile-dropdown-title"><span class="title">Python文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/1.Python-Basics/" class="nav-link">
  Python-基础
</a></li><li class="dropdown-item"><!----> <a href="/Python/2. Python-object/" class="nav-link">
  Python-面向对象
</a></li><li class="dropdown-item"><!----> <a href="/Python/3. Python-module/" class="nav-link">
  Python-模块与包
</a></li><li class="dropdown-item"><!----> <a href="/Python/4. Python-network/" class="nav-link">
  Python-网络
</a></li><li class="dropdown-item"><!----> <a href="/Python/5. Python-frontend/" class="nav-link">
  Python-前端
</a></li><li class="dropdown-item"><!----> <a href="/Python/6. Python-MySQL/" class="nav-link">
  Python-数据库
</a></li><li class="dropdown-item"><!----> <a href="/Python/7. Python-Django/" class="nav-link">
  Python-Django
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器文档" class="dropdown-title"><span class="title">容器文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器文档" class="mobile-dropdown-title"><span class="title">容器文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Container/docker/" class="nav-link">
  docker文檔
</a></li><li class="dropdown-item"><!----> <a href="/Container/Kubernetes/" class="nav-link">
  Kubernetes文檔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GO文档" class="dropdown-title"><span class="title">GO文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="GO文档" class="mobile-dropdown-title"><span class="title">GO文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GO/basics/" class="nav-link">
  GO快速入门
</a></li><li class="dropdown-item"><!----> <a href="/GO/module/" class="nav-link">
  GO标准库/GO模块
</a></li></ul></div></div><div class="nav-item"><a href="https://www.linux91.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Python-Django</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/7.%20Python-Django/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/Python/7. Python-Django/68. request相关的属性.html" class="sidebar-link">68. request相关的属性</a></li><li><a href="/Python/7. Python-Django/69. WEB框架的本质.html" class="sidebar-link">69. WEB框架的本质</a></li><li><a href="/Python/7. Python-Django/70. Django框架、基础.html" class="sidebar-link">70. Django框架、基础</a></li><li><a href="/Python/7. Python-Django/71. Django图书馆之出版社的增删改查 - 单表.html" class="sidebar-link">71. Django图书馆之出版社的增删改查 - 单表</a></li><li><a href="/Python/7. Python-Django/72. Django图书馆之书籍的增删改查 - 多表(外键).html" class="sidebar-link">72. Django图书馆之书籍的增删改查 - 多表(外键)</a></li><li><a href="/Python/7. Python-Django/73. Django图书馆之作者的增删改查 - 多对多关系表.html" class="sidebar-link">73. Django图书馆之作者的增删改查 - 多对多关系表</a></li><li><a href="/Python/7. Python-Django/74. Django简单上传文件.html" class="sidebar-link">74. Django简单上传文件</a></li><li><a href="/Python/7. Python-Django/75. Django模板语言之变量.html" class="sidebar-link">75. Django模板语言之变量</a></li><li><a href="/Python/7. Python-Django/76. Django模板语言之逻辑.html" class="sidebar-link">76. Django模板语言之逻辑</a></li><li><a href="/Python/7. Python-Django/77. Django视图、request方法大全.html" class="sidebar-link">77. Django视图、request方法大全</a></li><li><a href="/Python/7. Python-Django/78. Django路由系统(url).html" class="sidebar-link">78. Django路由系统(url)</a></li><li><a href="/Python/7. Python-Django/79. Django模型(ORM) 认识、字段.html" class="sidebar-link">79. Django模型(ORM) 认识、字段</a></li><li><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html" class="sidebar-link">80. Django模型(ORM) 操作、进阶</a></li><li><a href="/Python/7. Python-Django/81. Django - Cookie、Session、自定义分页.html" class="sidebar-link">81. Django - Cookie、Session、自定义分页</a></li><li><a href="/Python/7. Python-Django/82. Django - 中间件.html" class="active sidebar-link">82. Django - 中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#什么是中间件" class="sidebar-link">什么是中间件？</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#自定义一个中间件示例" class="sidebar-link">自定义一个中间件示例</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#process-request-请求进时触发" class="sidebar-link">process_request - 请求进时触发</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#process-response-视图函数执行完触发" class="sidebar-link">process_response - 视图函数执行完触发</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#process-view-请求经过url路由后触发" class="sidebar-link">process_view - 请求经过url路由后触发</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#process-exception-请求执行过程报错后触发" class="sidebar-link">process_exception - 请求执行过程报错后触发</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#process-template-response-用的比较少" class="sidebar-link">processtemplateresponse（用的比较少）</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#作品-博主自写" class="sidebar-link">作品 - 博主自写</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#作品-交流者" class="sidebar-link">作品 - 交流者</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#作品-前进者" class="sidebar-link">作品 - 前进者</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#urls-py-路由文件" class="sidebar-link">urls.py - 路由文件</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#views-py-视图函数" class="sidebar-link">views.py - 视图函数</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#login-html-登录前端页面" class="sidebar-link">login.html - 登录前端页面</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#middlewares-py-登录校验中间件" class="sidebar-link">middlewares.py -  登录校验中间件</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/82. Django - 中间件.html#在settings-py中注册中间件" class="sidebar-link">在settings.py中注册中间件</a></li></ul></li><li><a href="/Python/7. Python-Django/83. Django - ajax、csrf中间件补充.html" class="sidebar-link">83. Django - ajax、csrf中间件补充</a></li><li><a href="/Python/7. Python-Django/84. Django - Form、ModelForm.html" class="sidebar-link">84. Django - Form、ModelForm</a></li><li><a href="/Python/7. Python-Django/85. Django - auth认证组件.html" class="sidebar-link">85. Django - auth认证组件</a></li><li><a href="/Python/7. Python-Django/86. 权限控制.html" class="sidebar-link">86. 权限控制</a></li><li><a href="/Python/7. Python-Django/87. django小技巧.html" class="sidebar-link">87. django小技巧</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_82-django-中间件"><a href="#_82-django-中间件" class="header-anchor">#</a> 82. Django - 中间件</h1> <h1 id="中间件介绍"><a href="#中间件介绍" class="header-anchor">#</a> <strong>中间件介绍</strong></h1> <h2 id="什么是中间件"><a href="#什么是中间件" class="header-anchor">#</a> 什么是中间件？</h2> <p>官方的说法：中间件是一个用来处理Django的请求和响应的框架级别的钩子。</p> <p>它是一个轻量、低级别的插件系统，用于在全局范围内改变Django的输入和输出。每个中间件组件都负责做一些特定的功能。</p> <p>但是由于其影响的是全局，所以需要谨慎使用，使用不当会影响性能。</p> <p>说的直白一点中间件是帮助我们在视图函数执行之前和执行之后都可以做一些额外的操作，它本质上就是一个自定义类，类中定义了几个方法，Django框架会在请求的特定的时间去执行这些方法。</p> <p>我们一直都在使用中间件，只是没有注意到而已，打开Django项目的Settings.py文件，看到下图的MIDDLEWARE配置项。</p> <div class="language-python extra-class"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><p>MIDDLEWARE配置项是一个列表，列表中是一个个字符串，这些字符串其实是一个个类，也就是一个个中间件。</p> <p>我们之前已经接触过一个csrf相关的中间件了？我们一开始让大家把他注释掉，再提交post请求的时候，就不会被forbidden了，后来学会使用csrf_token之后就不再注释这个中间件了。</p> <p>那接下来就学习中间件中的方法以及这些方法什么时候被执行。</p> <h1 id="自定义中间件"><a href="#自定义中间件" class="header-anchor">#</a> <strong>自定义中间件</strong></h1> <p>中间件可以定义五个方法，分别是：（主要的是process_request和process_response）</p> <ul><li>process_request(self,request)</li> <li>process_view(self, request, view_func, view_args, view_kwargs)</li> <li>process_template_response(self,request,response)</li> <li>process_exception(self, request, exception)</li> <li>process_response(self, request, response)</li></ul> <p>以上方法的返回值可以是None或一个HttpResponse对象，如果是None，则继续按照django定义的规则向后继续执行，如果是HttpResponse对象，则直接将该对象返回给用户。</p> <h2 id="自定义一个中间件示例"><a href="#自定义一个中间件示例" class="header-anchor">#</a> 自定义一个中间件示例</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>deprecation <span class="token keyword">import</span> MiddlewareMixin


<span class="token keyword">class</span> <span class="token class-name">MD1</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_request&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
</code></pre></div><h2 id="process-request-请求进时触发"><a href="#process-request-请求进时触发" class="header-anchor">#</a> process_request - 请求进时触发</h2> <p>process_request有一个参数，就是request，这个request和视图函数中的request是一样的。</p> <p>它的返回值可以是None也可以是HttpResponse对象。返回值是None的话，按正常流程继续走，交给下一个中间件处理，如果是HttpResponse对象，Django将不执行视图函数，而将相应对象返回给浏览器。</p> <p>我们来看看多个中间件时，Django是如何执行其中的process_request方法的。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>deprecation <span class="token keyword">import</span> MiddlewareMixin


<span class="token keyword">class</span> <span class="token class-name">MD1</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_request&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MD2</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_request&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">pass</span>
</code></pre></div><p><strong>在settings.py的MIDDLEWARE配置项中注册上述两个自定义中间件：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'middlewares.MD1'</span><span class="token punctuation">,</span>  <span class="token comment"># 自定义中间件MD1</span>
    <span class="token string">'middlewares.MD2'</span>  <span class="token comment"># 自定义中间件MD2</span>
<span class="token punctuation">]</span>
<span class="token comment">## 写文件的路径跟中的类</span>
</code></pre></div><p><strong>此时，我们访问一个视图，会发现终端中打印如下内容：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>MD1里面的 process_request
MD2里面的 process_requestapp01 中的 index视图
</code></pre></div><p><strong>把MD1和MD2的位置调换一下，再访问一个视图，会发现终端中打印的内容如下：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>MD2里面的 process_request
MD1里面的 process_requestapp01 中的 index视图
</code></pre></div><p>看结果我们知道：视图函数还是最后执行的，MD2比MD1先执行自己的process_request方法。</p> <p>在打印一下两个自定义中间件中process_request方法中的request参数，会发现它们是同一个对象。</p> <p>由此总结一下：</p> <ol><li>中间件的process_request方法是在执行视图函数之前执行的。</li> <li>当配置多个中间件时，会按照MIDDLEWARE中的注册顺序，也就是列表的索引值，从前到后依次执行的。</li> <li>不同中间件之间传递的request都是同一个对象</li></ol> <h2 id="process-response-视图函数执行完触发"><a href="#process-response-视图函数执行完触发" class="header-anchor">#</a> process_response - 视图函数执行完触发</h2> <p>多个中间件中的process_response方法是按照MIDDLEWARE中的注册顺序<strong>倒序</strong>执行的，也就是说第一个中间件的process_request方法首先执行，而它的process_response方法最后执行，最后一个中间件的process_reques t方法最后一个执行，它的process_response方法是最先执行。</p> <p>它有两个参数，一个是request，一个是response，request就是上述例子中一样的对象，response是视图函数返回的HttpResponse对象。该方法的返回值也必须是HttpResponse对象。</p> <p><strong>给上述的M1和M2加上process_response方法：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>deprecation <span class="token keyword">import</span> MiddlewareMixin


<span class="token keyword">class</span> <span class="token class-name">MD1</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_request&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response


<span class="token keyword">class</span> <span class="token class-name">MD2</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_request&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
</code></pre></div><p><strong>访问一个视图，看一下终端的输出：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>MD2里面的 process_request
MD1里面的 process_request
app01 中的 index视图
MD1里面的 process_response
MD2里面的 process_response
</code></pre></div><p><strong>看结果可知：</strong></p> <p>process_response方法是在视图函数之后执行的，并且顺序是MD1比MD2先执行。(此时settings.py中 MD2比MD1先注册)</p> <p>多个中间件中的process_response方法是按照MIDDLEWARE中的注册顺序<strong>倒序</strong>执行的，也就是说第一个中间件的process_request方法首先执行，而它的process_response方法最后执行，最后一个中间件的process_request方法最后一个执行，它的process_response方法是最先执行。</p> <p>就是说process_response方法在视图函数执行完成之后执行</p> <h2 id="process-view-请求经过url路由后触发"><a href="#process-view-请求经过url路由后触发" class="header-anchor">#</a> process_view - 请求经过url路由后触发</h2> <p>process_view(self, request, view_func, view_args, view_kwargs)</p> <p>该方法有四个参数</p> <ol><li>request是HttpRequest对象。</li> <li>view_func是Django即将使用的视图函数。 （它是实际的函数对象，而不是函数的名称作为字符串。）</li> <li>view_args是将传递给视图的位置参数的列表，分组命名</li> <li>view_kwargs是将传递给视图的关键字参数的字典。 view_args和view_kwargs都不包含第一个视图参数（request）分组命名。</li></ol> <p>Django会在process_request之后，以及路由匹配之后，在视图函数执行之前调用process_view方法。</p> <p>它应该返回None或一个HttpResponse对象。 如果返回None，Django将继续处理这个请求，执行任何其他中间件的process_view方法，然后在执行相应的视图。 <strong>如果它返回一个HttpResponse对象，Django不会调用适当的视图函数</strong>。 它将执行中间件的process_response方法并将应用到该HttpResponse并返回结果。</p> <p><strong>给MD1和MD2添加process_view方法:</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>deprecation <span class="token keyword">import</span> MiddlewareMixin


<span class="token keyword">class</span> <span class="token class-name">MD1</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_request&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_view&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>view_func<span class="token punctuation">,</span> view_func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MD2</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_request&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2 中的process_view&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>view_func<span class="token punctuation">,</span> view_func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
</code></pre></div><p>访问index视图函数，看一下输出结果：</p> <div class="language-python extra-class"><pre class="language-python"><code>MD2里面的 process_request
MD1里面的 process_request
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
MD2 中的process_view
<span class="token operator">&lt;</span>function index at <span class="token number">0x000001DE68317488</span><span class="token operator">&gt;</span> index
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
MD1 中的process_view
<span class="token operator">&lt;</span>function index at <span class="token number">0x000001DE68317488</span><span class="token operator">&gt;</span> index
app01 中的 index视图
MD1里面的 process_response
MD2里面的 process_response
</code></pre></div><p>process_view方法是在process_request之后，视图函数之前执行的，执行顺序按照MIDDLEWARE中的注册顺序<strong>从前到后顺序</strong>执行的</p> <h2 id="process-exception-请求执行过程报错后触发"><a href="#process-exception-请求执行过程报错后触发" class="header-anchor">#</a> process_exception - 请求执行过程报错后触发</h2> <p>process_exception(self, request, exception)</p> <p>该方法两个参数:</p> <ol><li>request：HttpRequest对象</li> <li>exception：exception是视图函数异常产生的Exception对象。</li></ol> <p>这个方法只有在视图函数中出现异常了才执行，它返回的值可以是一个None也可以是一个HttpResponse对象。如果是HttpResponse对象，Django将调用模板和中间件中的process_response方法，并返回给浏览器，否则将默认处理异常。如果返回一个None，则交给下一个中间件的process_exception方法来处理异常。它的执行顺序也是按照中间件注册顺序的倒序执行。</p> <p>给MD1和MD2添加上这个方法：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>deprecation <span class="token keyword">import</span> MiddlewareMixin


<span class="token keyword">class</span> <span class="token class-name">MD1</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_request&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_view&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>view_func<span class="token punctuation">,</span> view_func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_exception&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MD2</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_request&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2 中的process_view&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>view_func<span class="token punctuation">,</span> view_func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2 中的process_exception&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>如果视图函数中无异常，process_exception方法不执行</strong></p> <p><strong>想办法，在视图函数中抛出一个异常：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;app01 中的 index视图&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;呵呵&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">&quot;O98K&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>在MD1的process_exception中返回一个响应对象：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MD1</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_request&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_view&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>view_func<span class="token punctuation">,</span> view_func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_exception&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回一个响应对象</span>
</code></pre></div><p>看输出结果：</p> <div class="language-python extra-class"><pre class="language-python"><code>MD2里面的 process_request
MD1里面的 process_request
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
MD2 中的process_view
<span class="token operator">&lt;</span>function index at <span class="token number">0x0000022C09727488</span><span class="token operator">&gt;</span> index
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
MD1 中的process_view
<span class="token operator">&lt;</span>function index at <span class="token number">0x0000022C09727488</span><span class="token operator">&gt;</span> index
app01 中的 index视图
呵呵
MD1 中的process_exception
MD1里面的 process_response
MD2里面的 process_response
</code></pre></div><p>注意，这里并没有执行MD2的process_exception方法，因为MD1中的process_exception方法直接返回了一个响应对象。</p> <h2 id="process-template-response-用的比较少"><a href="#process-template-response-用的比较少" class="header-anchor">#</a> process_template_response（用的比较少）</h2> <p>process_template_response(self, request, response)</p> <p>它的参数，一个HttpRequest对象，response是TemplateResponse对象（由视图函数或者中间件产生）。</p> <p>process_template_response是在视图函数执行完成后立即执行，但是它有一个前提条件，那就是视图函数返回的对象有一个render()方法（或者表明该对象是一个TemplateResponse对象或等价方法）。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MD1</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_request&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_view&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>view_func<span class="token punctuation">,</span> view_func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_exception&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_template_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD1 中的process_template_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response


<span class="token keyword">class</span> <span class="token class-name">MD2</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_request&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2里面的 process_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

    <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2 中的process_view&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>view_func<span class="token punctuation">,</span> view_func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_exception</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2 中的process_exception&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_template_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;MD2 中的process_template_response&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
</code></pre></div><p><strong>views.py中：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;app01 中的 index视图&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;in index/render&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">&quot;O98K&quot;</span><span class="token punctuation">)</span>
    rep <span class="token operator">=</span> HttpResponse<span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span>
    rep<span class="token punctuation">.</span>render <span class="token operator">=</span> render
    <span class="token keyword">return</span> rep
</code></pre></div><p><strong>访问index视图，终端输出的结果：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>MD2里面的 process_request
MD1里面的 process_request
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
MD2 中的process_view
<span class="token operator">&lt;</span>function index at <span class="token number">0x000001C111B97488</span><span class="token operator">&gt;</span> index
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
MD1 中的process_view
<span class="token operator">&lt;</span>function index at <span class="token number">0x000001C111B97488</span><span class="token operator">&gt;</span> index
app01 中的 index视图
MD1 中的process_template_response
MD2 中的process_template_response
<span class="token keyword">in</span> index<span class="token operator">/</span>render
MD1里面的 process_response
MD2里面的 process_response
</code></pre></div><p>从结果看出：</p> <p>视图函数执行完之后，立即执行了中间件的process_template_response方法，顺序是倒序，先执行MD1的，在执行MD2的，接着执行了视图函数返回的HttpResponse对象的render方法，返回了一个新的HttpResponse对象，接着执行中间件的process_response方法。</p> <h1 id="中间件的执行流程"><a href="#中间件的执行流程" class="header-anchor">#</a> <strong>中间件的执行流程</strong></h1> <p>了解了中间件中的5个方法，它们的参数、返回值以及什么时候执行，现在总结一下中间件的执行流程。</p> <p>请求到达中间件之后:</p> <ol><li>先按照正序执行每个注册中间件的process_reques方法，
<ol><li>process_request方法返回的值是None，就依次执行，</li> <li>如果返回的值是HttpResponse对象，不再执行后面的process_request方法，而是执行当前对应中间件的process_response方法，将HttpResponse对象返回给浏览器。</li></ol></li> <li>也就是说：如果MIDDLEWARE中注册了6个中间件，执行过程中，第3个中间件返回了一个HttpResponse对象，
<ol><li>那么第4,5,6中间件的process_request和process_response方法都不执行，</li> <li>顺序执行3,2,1中间件的process_response方法</li></ol></li></ol> <p><img src="https://s2.ax1x.com/2019/12/18/Q7r7qK.png" alt="Q7r7qK.png"></p> <p>process_request方法都执行完后，匹配路由，找到要执行的视图函数，先不执行视图函数，先执行中间件中的process_view方法，process_view方法返回None，继续按顺序执行，所有process_view方法执行完后执行视图函数。</p> <p>加入中间件3 的process_view方法返回了HttpResponse对象，则4,5,6的process_view以及视图函数都不执行，直接从最后一个中间件，也就是中间件6的process_response方法开始倒序执行。</p> <p><img src="https://s2.ax1x.com/2019/12/18/Q7smMq.png" alt="Q7smMq.png"></p> <p>process_template_response和process_exception两个方法的触发是有条件的，执行顺序也是倒序。</p> <p><img src="C:%5CUsers%5CJC%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20191218155727063.png" alt="image-20191218155727063"></p> <p>总结所有的执行流程如下：</p> <p><img src="C:%5CUsers%5CJC%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20191218155746049.png" alt="image-20191218155746049"></p> <h1 id="使用中间件进行访问限制"><a href="#使用中间件进行访问限制" class="header-anchor">#</a> <strong>使用中间件进行访问限制</strong></h1> <p>要求：根据IP，让每个IP一分钟内只能访问3次，超过三次返回“您点击的频率太快了，请稍后在试”</p> <h2 id="作品-博主自写"><a href="#作品-博主自写" class="header-anchor">#</a> 作品 - 博主自写</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Current_limiting</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cl_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pr_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取当前时间</span>
        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">)</span>  <span class="token comment"># 获取当前访问IP</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>cl_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断ip是否在cl_dict变量中存在，如果不存在就执行以下代码</span>
            self<span class="token punctuation">.</span>cl_dict<span class="token punctuation">[</span>ip<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 如果ip不在cl_dict变量中存在，就会加入这个ip</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cl_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>  <span class="token comment"># 判断这ip的时间列表是否大于3，如果大于3就执行以下代码</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> pr_time <span class="token operator">-</span> self<span class="token punctuation">.</span>cl_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">:</span> <span class="token comment"># 判断时间列表第一个时间值跟当前时间相减，是否已过去60秒了，使用了ont，结果就是：判断不大于60秒的执行以下代码</span>
                <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'您点击的频率太快了，请稍后在试'</span><span class="token punctuation">)</span>  <span class="token comment"># 返回执行对象</span>
            self<span class="token punctuation">.</span>cl_dict<span class="token punctuation">[</span>ip<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 如果大于60秒的，就把时间列表清空</span>

        self<span class="token punctuation">.</span>cl_dict<span class="token punctuation">[</span>ip<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>pr_time<span class="token punctuation">)</span>  <span class="token comment"># 加入当前访问时间</span>
</code></pre></div><h2 id="作品-交流者"><a href="#作品-交流者" class="header-anchor">#</a> 作品 - 交流者</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">IpCount</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 设置访问IP池</span>
    IP_DICT <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    数据结构：
    IP_DICT  = 
     {'127.0.0.1':
             {'count': 0,
               'time': datetime.datetime.now() + datetime.timedelta(minutes=1) }
     }
    
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 记录每次访问的IP</span>
        ip_name <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果该IP在IP池内则执行以下代码</span>
        <span class="token keyword">if</span> ip_name <span class="token keyword">in</span> self<span class="token punctuation">.</span>IP_DICT<span class="token punctuation">:</span>
            <span class="token comment"># 获取该IP的超时时间点</span>
            setted_time <span class="token operator">=</span> self<span class="token punctuation">.</span>IP_DICT<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ip_name<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
            <span class="token comment"># 获取当前的访问时间点</span>
            now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 获取已经访问的次数</span>
            visit_count <span class="token operator">=</span> self<span class="token punctuation">.</span>IP_DICT<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ip_name<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span>
            <span class="token comment"># 当前访问次数是在已经访问的次数+1</span>
            new_count <span class="token operator">=</span> visit_count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token comment"># 如果当前访问次数小于3次并且当前访问时间点小于超时时间点，可以继续访问并记录访问次数</span>
            <span class="token keyword">if</span> new_count <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token keyword">and</span> now <span class="token operator">&lt;=</span> setted_time<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>IP_DICT<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ip_name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_count
                <span class="token keyword">return</span>
            <span class="token comment"># 如果当前访问时间点超过超时时间点，将该访问IP从IP池删除并可以继续访问</span>
            <span class="token keyword">elif</span> now <span class="token operator">&gt;</span> setted_time<span class="token punctuation">:</span>
                <span class="token keyword">del</span> self<span class="token punctuation">.</span>IP_DICT<span class="token punctuation">[</span>ip_name<span class="token punctuation">]</span>
                <span class="token keyword">return</span>
            <span class="token comment"># 如果当前访问次数大于3次并且当前访问时间点小于超时时间点，将剩余时间返回给请求者</span>
            <span class="token keyword">elif</span> new_count <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token keyword">and</span> now <span class="token operator">&lt;=</span> setted_time<span class="token punctuation">:</span>
                delta <span class="token operator">=</span> setted_time <span class="token operator">-</span> now
                msg <span class="token operator">=</span> <span class="token string">'&lt;h1 style=&quot;text-align:center;color:red;&quot;&gt;您的访问过于频繁,请于{}秒后访问&lt;/h1&gt;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>delta<span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>
                <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token comment"># 将新IP添加进IP池，并记录当前的第一次访问和一分钟后的时间即超时时间点</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>IP_DICT<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>ip_name<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'count'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                              <span class="token string">'time'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                                      datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
</code></pre></div><h2 id="作品-前进者"><a href="#作品-前进者" class="header-anchor">#</a> 作品 - 前进者</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Throttle</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
visit_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. 获取IP</span>
        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">)</span>
        <span class="token comment"># 2. 有访问记录</span>

        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> visit_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
            visit_dict<span class="token punctuation">[</span>ip<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        history <span class="token operator">=</span> visit_dict<span class="token punctuation">[</span>ip<span class="token punctuation">]</span>

        <span class="token keyword">while</span> history <span class="token keyword">and</span> now <span class="token operator">-</span> history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">5</span><span class="token punctuation">:</span>
            history<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'你的频率太快了'</span><span class="token punctuation">)</span>

        history<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span>
</code></pre></div><h1 id="中间件版登录验证"><a href="#中间件版登录验证" class="header-anchor">#</a> 中间件版登录验证</h1> <p>中间件版的登录验证需要依靠session，所以数据库中要有django_session表。</p> <h2 id="urls-py-路由文件"><a href="#urls-py-路由文件" class="header-anchor">#</a> urls.py - 路由文件</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url
<span class="token keyword">from</span> app01 <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^index/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
    url<span class="token punctuation">(</span><span class="token string">r'^login/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>login<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="views-py-视图函数"><a href="#views-py-视图函数" class="header-anchor">#</a> views.py - 视图函数</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> HttpResponse<span class="token punctuation">,</span> redirect


<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'this is index'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'this is home'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">:</span>
        user <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
        pwd <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;pwd&quot;</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> user <span class="token operator">==</span> <span class="token string">&quot;Q1mi&quot;</span> <span class="token keyword">and</span> pwd <span class="token operator">==</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">:</span>
            <span class="token comment"># 设置session</span>
            request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> user
            <span class="token comment"># 获取跳到登陆页面之前的URL</span>
            next_url <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;next&quot;</span><span class="token punctuation">)</span>
            <span class="token comment"># 如果有，就跳转回登陆之前的URL</span>
            <span class="token keyword">if</span> next_url<span class="token punctuation">:</span>
                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>next_url<span class="token punctuation">)</span>
            <span class="token comment"># 否则默认跳转到index页面</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">&quot;/index/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">&quot;login.html&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="login-html-登录前端页面"><a href="#login-html-登录前端页面" class="header-anchor">#</a> login.html - 登录前端页面</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;x-ua-compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>登录页面<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">&quot;{% url 'login' %}&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token operator">&gt;</span>用户名：<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;user&quot;</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;pwd&quot;</span><span class="token operator">&gt;</span>密码：<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;pwd&quot;</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">&quot;pwd&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;登录&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre></div><h2 id="middlewares-py-登录校验中间件"><a href="#middlewares-py-登录校验中间件" class="header-anchor">#</a> middlewares.py -  登录校验中间件</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">AuthMD</span><span class="token punctuation">(</span>MiddlewareMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    white_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/login/'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>  <span class="token comment"># 白名单</span>
    balck_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/black/'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>  <span class="token comment"># 黑名单</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> redirect<span class="token punctuation">,</span> HttpResponse

        next_url <span class="token operator">=</span> request<span class="token punctuation">.</span>path_info
        <span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>path_info<span class="token punctuation">,</span> request<span class="token punctuation">.</span>get_full_path<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> next_url <span class="token keyword">in</span> self<span class="token punctuation">.</span>white_list <span class="token keyword">or</span> request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">elif</span> next_url <span class="token keyword">in</span> self<span class="token punctuation">.</span>balck_list<span class="token punctuation">:</span>
            <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'This is an illegal URL'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">&quot;/login/?next={}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>next_url<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="在settings-py中注册中间件"><a href="#在settings-py中注册中间件" class="header-anchor">#</a> 在settings.py中注册中间件</h2> <div class="language-python extra-class"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'middlewares.AuthMD'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><p>AuthMD中间件注册后，所有的请求都要走AuthMD的process_request方法。</p> <p>访问的URL在白名单内或者session中有user用户名，则不做阻拦走正常流程；</p> <p>如果URL在黑名单中，则返回This is an illegal URL的字符串；</p> <p>正常的URL但是需要登录后访问，让浏览器跳转到登录页面。</p> <p>注：AuthMD中间件中需要session，所以AuthMD注册的位置要在session中间的下方</p> <h1 id="django请求流程图"><a href="#django请求流程图" class="header-anchor">#</a> Django请求流程图</h1> <p><img src="https://s2.ax1x.com/2019/12/18/Q76Yb6.png" alt="Q76Yb6.png"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/7. Python-Django/81. Django - Cookie、Session、自定义分页.html" class="prev">
        81. Django - Cookie、Session、自定义分页
      </a></span> <span class="next"><a href="/Python/7. Python-Django/83. Django - ajax、csrf中间件补充.html">
        83. Django - ajax、csrf中间件补充
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d65bef42.js" defer></script><script src="/assets/js/2.2249178e.js" defer></script><script src="/assets/js/155.5a9840ea.js" defer></script>
  </body>
</html>
