<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>80. Django模型(ORM) 操作、进阶 | MSG</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="在追寻技术的同时享受生活">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.d65bef42.js" as="script"><link rel="preload" href="/assets/js/2.2249178e.js" as="script"><link rel="preload" href="/assets/js/153.98dd0727.js" as="script"><link rel="prefetch" href="/assets/js/10.4785e2e5.js"><link rel="prefetch" href="/assets/js/100.33fceff2.js"><link rel="prefetch" href="/assets/js/101.62e1e5d4.js"><link rel="prefetch" href="/assets/js/102.8551fe71.js"><link rel="prefetch" href="/assets/js/103.47754d79.js"><link rel="prefetch" href="/assets/js/104.4adf114f.js"><link rel="prefetch" href="/assets/js/105.6206a08a.js"><link rel="prefetch" href="/assets/js/106.1c4561f3.js"><link rel="prefetch" href="/assets/js/107.e1531a5a.js"><link rel="prefetch" href="/assets/js/108.c637743a.js"><link rel="prefetch" href="/assets/js/109.3f150913.js"><link rel="prefetch" href="/assets/js/11.bd8ec7a6.js"><link rel="prefetch" href="/assets/js/110.088c1ac3.js"><link rel="prefetch" href="/assets/js/111.66d8d491.js"><link rel="prefetch" href="/assets/js/112.231663ee.js"><link rel="prefetch" href="/assets/js/113.a38bc531.js"><link rel="prefetch" href="/assets/js/114.e165daea.js"><link rel="prefetch" href="/assets/js/115.994b087a.js"><link rel="prefetch" href="/assets/js/116.ea3cfdfb.js"><link rel="prefetch" href="/assets/js/117.7be5e4f3.js"><link rel="prefetch" href="/assets/js/118.ebb58ddb.js"><link rel="prefetch" href="/assets/js/119.90018646.js"><link rel="prefetch" href="/assets/js/12.0d8f43df.js"><link rel="prefetch" href="/assets/js/120.bb5be863.js"><link rel="prefetch" href="/assets/js/121.3d1db670.js"><link rel="prefetch" href="/assets/js/122.d29ed1b2.js"><link rel="prefetch" href="/assets/js/123.38cc4704.js"><link rel="prefetch" href="/assets/js/124.cc8549d4.js"><link rel="prefetch" href="/assets/js/125.6ee3e9c8.js"><link rel="prefetch" href="/assets/js/126.48710eba.js"><link rel="prefetch" href="/assets/js/127.d7a1fd83.js"><link rel="prefetch" href="/assets/js/128.e5017f6b.js"><link rel="prefetch" href="/assets/js/129.4c33e121.js"><link rel="prefetch" href="/assets/js/13.2dbde7aa.js"><link rel="prefetch" href="/assets/js/130.cda66247.js"><link rel="prefetch" href="/assets/js/131.ad76f669.js"><link rel="prefetch" href="/assets/js/132.aca88758.js"><link rel="prefetch" href="/assets/js/133.a1cf5903.js"><link rel="prefetch" href="/assets/js/134.b1386377.js"><link rel="prefetch" href="/assets/js/135.94edcf53.js"><link rel="prefetch" href="/assets/js/136.24be4170.js"><link rel="prefetch" href="/assets/js/137.db57772e.js"><link rel="prefetch" href="/assets/js/138.dc67bcaa.js"><link rel="prefetch" href="/assets/js/139.5453d1f6.js"><link rel="prefetch" href="/assets/js/14.2187dbf4.js"><link rel="prefetch" href="/assets/js/140.938e5c07.js"><link rel="prefetch" href="/assets/js/141.99c7cf2c.js"><link rel="prefetch" href="/assets/js/142.428e3958.js"><link rel="prefetch" href="/assets/js/143.68b01530.js"><link rel="prefetch" href="/assets/js/144.f67389cc.js"><link rel="prefetch" href="/assets/js/145.d952a130.js"><link rel="prefetch" href="/assets/js/146.b933dcad.js"><link rel="prefetch" href="/assets/js/147.2d8e4c0a.js"><link rel="prefetch" href="/assets/js/148.6d76ac94.js"><link rel="prefetch" href="/assets/js/149.6b4d6378.js"><link rel="prefetch" href="/assets/js/15.a53b356c.js"><link rel="prefetch" href="/assets/js/150.5bf39cb4.js"><link rel="prefetch" href="/assets/js/151.17af677c.js"><link rel="prefetch" href="/assets/js/152.7f1c2792.js"><link rel="prefetch" href="/assets/js/154.eb44bf23.js"><link rel="prefetch" href="/assets/js/155.5a9840ea.js"><link rel="prefetch" href="/assets/js/156.7ba01fd0.js"><link rel="prefetch" href="/assets/js/157.2296a048.js"><link rel="prefetch" href="/assets/js/158.6bb1f699.js"><link rel="prefetch" href="/assets/js/159.073bb8df.js"><link rel="prefetch" href="/assets/js/16.cef7bf44.js"><link rel="prefetch" href="/assets/js/160.25a837f9.js"><link rel="prefetch" href="/assets/js/161.93d886a1.js"><link rel="prefetch" href="/assets/js/162.5d2714b2.js"><link rel="prefetch" href="/assets/js/17.96f36904.js"><link rel="prefetch" href="/assets/js/18.fd04b310.js"><link rel="prefetch" href="/assets/js/19.3e1377d1.js"><link rel="prefetch" href="/assets/js/20.ac195ac8.js"><link rel="prefetch" href="/assets/js/21.c2d7729c.js"><link rel="prefetch" href="/assets/js/22.dd8c621b.js"><link rel="prefetch" href="/assets/js/23.ad7d0350.js"><link rel="prefetch" href="/assets/js/24.8559c4c3.js"><link rel="prefetch" href="/assets/js/25.783a8116.js"><link rel="prefetch" href="/assets/js/26.25e0e459.js"><link rel="prefetch" href="/assets/js/27.c0616e2a.js"><link rel="prefetch" href="/assets/js/28.30656c2e.js"><link rel="prefetch" href="/assets/js/29.2be5114c.js"><link rel="prefetch" href="/assets/js/3.be8c8f3b.js"><link rel="prefetch" href="/assets/js/30.230a74a7.js"><link rel="prefetch" href="/assets/js/31.760f46ad.js"><link rel="prefetch" href="/assets/js/32.c9533fef.js"><link rel="prefetch" href="/assets/js/33.dcacfb38.js"><link rel="prefetch" href="/assets/js/34.4370a466.js"><link rel="prefetch" href="/assets/js/35.bf299eea.js"><link rel="prefetch" href="/assets/js/36.336e435a.js"><link rel="prefetch" href="/assets/js/37.1d1d2eea.js"><link rel="prefetch" href="/assets/js/38.0d58b7d0.js"><link rel="prefetch" href="/assets/js/39.d43564ba.js"><link rel="prefetch" href="/assets/js/4.4a6cb970.js"><link rel="prefetch" href="/assets/js/40.bc4e4bde.js"><link rel="prefetch" href="/assets/js/41.b71231a5.js"><link rel="prefetch" href="/assets/js/42.9d46f400.js"><link rel="prefetch" href="/assets/js/43.50c5be69.js"><link rel="prefetch" href="/assets/js/44.60406e7f.js"><link rel="prefetch" href="/assets/js/45.ec3569ae.js"><link rel="prefetch" href="/assets/js/46.1bd3ce7b.js"><link rel="prefetch" href="/assets/js/47.1e1b5326.js"><link rel="prefetch" href="/assets/js/48.64c631ea.js"><link rel="prefetch" href="/assets/js/49.b4abacd8.js"><link rel="prefetch" href="/assets/js/5.e6d0b165.js"><link rel="prefetch" href="/assets/js/50.c3e320c0.js"><link rel="prefetch" href="/assets/js/51.5ec7fb8c.js"><link rel="prefetch" href="/assets/js/52.2d234f86.js"><link rel="prefetch" href="/assets/js/53.f3b69623.js"><link rel="prefetch" href="/assets/js/54.c85ff450.js"><link rel="prefetch" href="/assets/js/55.b07597b5.js"><link rel="prefetch" href="/assets/js/56.444129cf.js"><link rel="prefetch" href="/assets/js/57.df1329ba.js"><link rel="prefetch" href="/assets/js/58.5afb51cf.js"><link rel="prefetch" href="/assets/js/59.d98936d9.js"><link rel="prefetch" href="/assets/js/6.809376cd.js"><link rel="prefetch" href="/assets/js/60.02813ecf.js"><link rel="prefetch" href="/assets/js/61.37a4812d.js"><link rel="prefetch" href="/assets/js/62.5da94048.js"><link rel="prefetch" href="/assets/js/63.8e2c2bca.js"><link rel="prefetch" href="/assets/js/64.d290398f.js"><link rel="prefetch" href="/assets/js/65.44e28313.js"><link rel="prefetch" href="/assets/js/66.9acf0206.js"><link rel="prefetch" href="/assets/js/67.85688aa2.js"><link rel="prefetch" href="/assets/js/68.45bda7fc.js"><link rel="prefetch" href="/assets/js/69.9074feb0.js"><link rel="prefetch" href="/assets/js/7.5d7bce6e.js"><link rel="prefetch" href="/assets/js/70.b4cd2ddc.js"><link rel="prefetch" href="/assets/js/71.53219b13.js"><link rel="prefetch" href="/assets/js/72.af2a7290.js"><link rel="prefetch" href="/assets/js/73.c28fc506.js"><link rel="prefetch" href="/assets/js/74.64c81a90.js"><link rel="prefetch" href="/assets/js/75.05191ece.js"><link rel="prefetch" href="/assets/js/76.f516d464.js"><link rel="prefetch" href="/assets/js/77.c345180b.js"><link rel="prefetch" href="/assets/js/78.4a09d0ba.js"><link rel="prefetch" href="/assets/js/79.65f41bcf.js"><link rel="prefetch" href="/assets/js/8.f6cfdc07.js"><link rel="prefetch" href="/assets/js/80.b77151f3.js"><link rel="prefetch" href="/assets/js/81.824fa371.js"><link rel="prefetch" href="/assets/js/82.3f91c09b.js"><link rel="prefetch" href="/assets/js/83.9539f074.js"><link rel="prefetch" href="/assets/js/84.dd89f1de.js"><link rel="prefetch" href="/assets/js/85.15210b99.js"><link rel="prefetch" href="/assets/js/86.e14553e1.js"><link rel="prefetch" href="/assets/js/87.6dc95177.js"><link rel="prefetch" href="/assets/js/88.09c5e890.js"><link rel="prefetch" href="/assets/js/89.0d61f4d0.js"><link rel="prefetch" href="/assets/js/9.759f1986.js"><link rel="prefetch" href="/assets/js/90.a9b14d80.js"><link rel="prefetch" href="/assets/js/91.1a4aabe2.js"><link rel="prefetch" href="/assets/js/92.12070bdb.js"><link rel="prefetch" href="/assets/js/93.b5dc76d0.js"><link rel="prefetch" href="/assets/js/94.690498a6.js"><link rel="prefetch" href="/assets/js/95.b17961e6.js"><link rel="prefetch" href="/assets/js/96.a2f06f3e.js"><link rel="prefetch" href="/assets/js/97.64ef6721.js"><link rel="prefetch" href="/assets/js/98.443eba26.js"><link rel="prefetch" href="/assets/js/99.b6ba7c3a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">MSG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python文档" class="dropdown-title"><span class="title">Python文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python文档" class="mobile-dropdown-title"><span class="title">Python文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/1.Python-Basics/" class="nav-link">
  Python-基础
</a></li><li class="dropdown-item"><!----> <a href="/Python/2. Python-object/" class="nav-link">
  Python-面向对象
</a></li><li class="dropdown-item"><!----> <a href="/Python/3. Python-module/" class="nav-link">
  Python-模块与包
</a></li><li class="dropdown-item"><!----> <a href="/Python/4. Python-network/" class="nav-link">
  Python-网络
</a></li><li class="dropdown-item"><!----> <a href="/Python/5. Python-frontend/" class="nav-link">
  Python-前端
</a></li><li class="dropdown-item"><!----> <a href="/Python/6. Python-MySQL/" class="nav-link">
  Python-数据库
</a></li><li class="dropdown-item"><!----> <a href="/Python/7. Python-Django/" class="nav-link">
  Python-Django
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器文档" class="dropdown-title"><span class="title">容器文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器文档" class="mobile-dropdown-title"><span class="title">容器文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Container/docker/" class="nav-link">
  docker文檔
</a></li><li class="dropdown-item"><!----> <a href="/Container/Kubernetes/" class="nav-link">
  Kubernetes文檔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GO文档" class="dropdown-title"><span class="title">GO文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="GO文档" class="mobile-dropdown-title"><span class="title">GO文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GO/basics/" class="nav-link">
  GO快速入门
</a></li><li class="dropdown-item"><!----> <a href="/GO/module/" class="nav-link">
  GO标准库/GO模块
</a></li></ul></div></div><div class="nav-item"><a href="https://www.linux91.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python文档" class="dropdown-title"><span class="title">Python文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python文档" class="mobile-dropdown-title"><span class="title">Python文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/1.Python-Basics/" class="nav-link">
  Python-基础
</a></li><li class="dropdown-item"><!----> <a href="/Python/2. Python-object/" class="nav-link">
  Python-面向对象
</a></li><li class="dropdown-item"><!----> <a href="/Python/3. Python-module/" class="nav-link">
  Python-模块与包
</a></li><li class="dropdown-item"><!----> <a href="/Python/4. Python-network/" class="nav-link">
  Python-网络
</a></li><li class="dropdown-item"><!----> <a href="/Python/5. Python-frontend/" class="nav-link">
  Python-前端
</a></li><li class="dropdown-item"><!----> <a href="/Python/6. Python-MySQL/" class="nav-link">
  Python-数据库
</a></li><li class="dropdown-item"><!----> <a href="/Python/7. Python-Django/" class="nav-link">
  Python-Django
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器文档" class="dropdown-title"><span class="title">容器文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器文档" class="mobile-dropdown-title"><span class="title">容器文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Container/docker/" class="nav-link">
  docker文檔
</a></li><li class="dropdown-item"><!----> <a href="/Container/Kubernetes/" class="nav-link">
  Kubernetes文檔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GO文档" class="dropdown-title"><span class="title">GO文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="GO文档" class="mobile-dropdown-title"><span class="title">GO文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/GO/basics/" class="nav-link">
  GO快速入门
</a></li><li class="dropdown-item"><!----> <a href="/GO/module/" class="nav-link">
  GO标准库/GO模块
</a></li></ul></div></div><div class="nav-item"><a href="https://www.linux91.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Python-Django</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/7.%20Python-Django/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/Python/7. Python-Django/68. request相关的属性.html" class="sidebar-link">68. request相关的属性</a></li><li><a href="/Python/7. Python-Django/69. WEB框架的本质.html" class="sidebar-link">69. WEB框架的本质</a></li><li><a href="/Python/7. Python-Django/70. Django框架、基础.html" class="sidebar-link">70. Django框架、基础</a></li><li><a href="/Python/7. Python-Django/71. Django图书馆之出版社的增删改查 - 单表.html" class="sidebar-link">71. Django图书馆之出版社的增删改查 - 单表</a></li><li><a href="/Python/7. Python-Django/72. Django图书馆之书籍的增删改查 - 多表(外键).html" class="sidebar-link">72. Django图书馆之书籍的增删改查 - 多表(外键)</a></li><li><a href="/Python/7. Python-Django/73. Django图书馆之作者的增删改查 - 多对多关系表.html" class="sidebar-link">73. Django图书馆之作者的增删改查 - 多对多关系表</a></li><li><a href="/Python/7. Python-Django/74. Django简单上传文件.html" class="sidebar-link">74. Django简单上传文件</a></li><li><a href="/Python/7. Python-Django/75. Django模板语言之变量.html" class="sidebar-link">75. Django模板语言之变量</a></li><li><a href="/Python/7. Python-Django/76. Django模板语言之逻辑.html" class="sidebar-link">76. Django模板语言之逻辑</a></li><li><a href="/Python/7. Python-Django/77. Django视图、request方法大全.html" class="sidebar-link">77. Django视图、request方法大全</a></li><li><a href="/Python/7. Python-Django/78. Django路由系统(url).html" class="sidebar-link">78. Django路由系统(url)</a></li><li><a href="/Python/7. Python-Django/79. Django模型(ORM) 认识、字段.html" class="sidebar-link">79. Django模型(ORM) 认识、字段</a></li><li><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html" class="active sidebar-link">80. Django模型(ORM) 操作、进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#必知必会13条操作" class="sidebar-link">必知必会13条操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#返回queryset对象的方法有" class="sidebar-link">返回QuerySet对象的方法有</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#特殊的queryset" class="sidebar-link">特殊的QuerySet</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#返回具体对象的" class="sidebar-link">返回具体对象的</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#返回布尔值的方法有" class="sidebar-link">返回布尔值的方法有：</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#返回数字的方法有" class="sidebar-link">返回数字的方法有</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#其他queryset操作" class="sidebar-link">其他QuerySet操作</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#单表查询之神奇的双下划线" class="sidebar-link">单表查询之神奇的双下划线</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#统计" class="sidebar-link">统计</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#大于、大于等于、小于、小于等于" class="sidebar-link">大于、大于等于、小于、小于等于</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#成员判断-in" class="sidebar-link">成员判断 - in</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#是否为空-isnull" class="sidebar-link">是否为空 isnull</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#查询是否有包含指定的值" class="sidebar-link">查询是否有包含指定的值</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#查询指定范围的行数" class="sidebar-link">查询指定范围的行数</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#分组group-by" class="sidebar-link">分组group by</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#排序-倒序" class="sidebar-link">排序 - 倒序</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#其他" class="sidebar-link">其他</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#正向查找" class="sidebar-link">正向查找</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#对象查找-跨表" class="sidebar-link">对象查找（跨表）</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#字段查找-跨表" class="sidebar-link">字段查找（跨表）</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#反向操作" class="sidebar-link">反向操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#对象查找" class="sidebar-link">对象查找</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#字段查找" class="sidebar-link">字段查找</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#使用方法" class="sidebar-link">使用方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#create-创建一个新的对象" class="sidebar-link">create() - 创建一个新的对象</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#add-添加对象" class="sidebar-link">add() - 添加对象</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#set-更新model对象的关联对象" class="sidebar-link">set() - 更新model对象的关联对象</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#remove-关联对象集中移除" class="sidebar-link">remove() - 关联对象集中移除</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#clear-关联对象集中移除一切对象" class="sidebar-link">clear() - 关联对象集中移除一切对象</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#注意事项" class="sidebar-link">注意事项</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#聚合" class="sidebar-link">聚合</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#分组" class="sidebar-link">分组</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#更多示例" class="sidebar-link">更多示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#f查询" class="sidebar-link">F查询</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#q查询" class="sidebar-link">Q查询</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#锁" class="sidebar-link">锁</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#django-orm执行原生sql" class="sidebar-link">Django ORM执行原生SQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#执行原生查询" class="sidebar-link">执行原生查询</a></li><li class="sidebar-sub-header"><a href="/Python/7. Python-Django/80. Django模型(ORM) 操作、进阶.html#直接执行自定义sql" class="sidebar-link">直接执行自定义SQL</a></li></ul></li></ul></li><li><a href="/Python/7. Python-Django/81. Django - Cookie、Session、自定义分页.html" class="sidebar-link">81. Django - Cookie、Session、自定义分页</a></li><li><a href="/Python/7. Python-Django/82. Django - 中间件.html" class="sidebar-link">82. Django - 中间件</a></li><li><a href="/Python/7. Python-Django/83. Django - ajax、csrf中间件补充.html" class="sidebar-link">83. Django - ajax、csrf中间件补充</a></li><li><a href="/Python/7. Python-Django/84. Django - Form、ModelForm.html" class="sidebar-link">84. Django - Form、ModelForm</a></li><li><a href="/Python/7. Python-Django/85. Django - auth认证组件.html" class="sidebar-link">85. Django - auth认证组件</a></li><li><a href="/Python/7. Python-Django/86. 权限控制.html" class="sidebar-link">86. 权限控制</a></li><li><a href="/Python/7. Python-Django/87. django小技巧.html" class="sidebar-link">87. django小技巧</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content__default"><h1 id="_80-django模型-orm-操作、进阶"><a href="#_80-django模型-orm-操作、进阶" class="header-anchor">#</a> 80. Django模型(ORM) 操作、进阶</h1> <h1 id="测试环境"><a href="#测试环境" class="header-anchor">#</a> 测试环境</h1> <p>练习或实验的时候，可能只为了试试一个语法的效果，就要把整个项目启动，这样不止浪费系统资源，还消耗时间，所以在项目中，创建一个.py文件，放置以下的配置就可以直接在这文件写代码，按普通.py文件启动方式启动就可以</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">## 以下代码由django项目中的manage.py文件的一部分配置由来</span>

<span class="token keyword">import</span> os

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Book_Management.settings&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> django
    django<span class="token punctuation">.</span>setup<span class="token punctuation">(</span><span class="token punctuation">)</span>

    
    <span class="token comment">## 以下就是代码测试编写区</span>
    <span class="token keyword">from</span> Press <span class="token keyword">import</span> models

    books <span class="token operator">=</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>books<span class="token punctuation">)</span>
</code></pre></div><h1 id="django终端打印sql语句"><a href="#django终端打印sql语句" class="header-anchor">#</a> Django终端打印SQL语句</h1> <p>就是执行orm语句会打印出原生的SQL语句</p> <p>在Django项目的settings.py文件中，在最后复制粘贴如下代码：</p> <div class="language-python extra-class"><pre class="language-python"><code>LOGGING <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'version'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">'disable_existing_loggers'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'console'</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
            <span class="token string">'level'</span><span class="token punctuation">:</span><span class="token string">'DEBUG'</span><span class="token punctuation">,</span>
            <span class="token string">'class'</span><span class="token punctuation">:</span><span class="token string">'logging.StreamHandler'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'loggers'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'django.db.backends'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'handlers'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'console'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'propagate'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'level'</span><span class="token punctuation">:</span><span class="token string">'DEBUG'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="orm常用操作"><a href="#orm常用操作" class="header-anchor">#</a> ORM常用操作</h1> <p><a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/" target="_blank" rel="noopener noreferrer">看专业的官网文档，做专业的程序员！<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 增</span>
models<span class="token punctuation">.</span>Tb1<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>c1<span class="token operator">=</span><span class="token string">'xx'</span><span class="token punctuation">,</span> c2<span class="token operator">=</span><span class="token string">'oo'</span><span class="token punctuation">)</span>   <span class="token comment"># 增加一条数据，可以接受字典类型数据 **kwargs</span>
obj <span class="token operator">=</span> models<span class="token punctuation">.</span>Tb1<span class="token punctuation">(</span>c1<span class="token operator">=</span><span class="token string">'xx'</span><span class="token punctuation">,</span> c2<span class="token operator">=</span><span class="token string">'oo'</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
 
<span class="token comment"># 查</span>
models<span class="token punctuation">.</span>Tb1<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">)</span>  <span class="token comment"># 获取单条数据，不存在则报错（不建议）</span>
models<span class="token punctuation">.</span>Tb1<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取全部</span>
models<span class="token punctuation">.</span>Tb1<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'seven'</span><span class="token punctuation">)</span>  <span class="token comment"># 获取指定条件的数据</span>
models<span class="token punctuation">.</span>Tb1<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'seven'</span><span class="token punctuation">)</span>  <span class="token comment"># 去除指定条件的数据</span>
 
 
<span class="token comment"># 删</span>
<span class="token comment"># models.Tb1.objects.filter(name='seven').delete()  # 删除指定条件的数据</span>
 
 
<span class="token comment"># 改</span>
models<span class="token punctuation">.</span>Tb1<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'seven'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>gender<span class="token operator">=</span><span class="token string">'0'</span><span class="token punctuation">)</span>   <span class="token comment"># 将指定条件的数据更新，均支持 **kwargs</span>
obj <span class="token operator">=</span> models<span class="token punctuation">.</span>Tb1<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>c1 <span class="token operator">=</span> <span class="token string">'111'</span>
obj<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 修改单条数据</span>
</code></pre></div><h2 id="必知必会13条操作"><a href="#必知必会13条操作" class="header-anchor">#</a> <strong>必知必会13条操作</strong></h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                 查询所有结果
 
<span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>      它包含了与所给筛选条件相匹配的对象
 
<span class="token operator">&lt;</span><span class="token number">3</span><span class="token operator">&gt;</span> get<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>         返回与所给筛选条件相匹配的对象，返回结果有且只有一个，如果符合筛选条件的对象超过一个或者没有都会抛出错误。
 
<span class="token operator">&lt;</span><span class="token number">4</span><span class="token operator">&gt;</span> exclude<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>     它包含了与所给筛选条件不匹配的对象
 
<span class="token operator">&lt;</span><span class="token number">5</span><span class="token operator">&gt;</span> values<span class="token punctuation">(</span><span class="token operator">*</span>field<span class="token punctuation">)</span><span class="token punctuation">:</span>        返回一个ValueQuerySet——一个特殊的QuerySet，运行后得到的并不是一系列model的实例化对象，而是一个可迭代的字典序列
 
<span class="token operator">&lt;</span><span class="token number">6</span><span class="token operator">&gt;</span> values_list<span class="token punctuation">(</span><span class="token operator">*</span>field<span class="token punctuation">)</span><span class="token punctuation">:</span>   它与values<span class="token punctuation">(</span><span class="token punctuation">)</span>非常相似，它返回的是一个元组序列，values返回的是一个字典序列
 
<span class="token operator">&lt;</span><span class="token number">7</span><span class="token operator">&gt;</span> order_by<span class="token punctuation">(</span><span class="token operator">*</span>field<span class="token punctuation">)</span><span class="token punctuation">:</span>      对查询结果排序
 
<span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span> reverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             对查询结果反向排序，请注意reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>通常只能在具有已定义顺序的QuerySet上调用<span class="token punctuation">(</span>在model类的Meta中指定ordering或调用order_by<span class="token punctuation">(</span><span class="token punctuation">)</span>方法<span class="token punctuation">)</span>。
 
<span class="token operator">&lt;</span><span class="token number">9</span><span class="token operator">&gt;</span> distinct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            从返回结果中剔除重复纪录<span class="token punctuation">(</span>如果你查询跨越多个表，可能在计算QuerySet时得到重复的结果。此时可以使用distinct<span class="token punctuation">(</span><span class="token punctuation">)</span>，注意只有在PostgreSQL中支持按字段去重。<span class="token punctuation">)</span>
 
<span class="token operator">&lt;</span><span class="token number">10</span><span class="token operator">&gt;</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>              返回数据库中匹配查询<span class="token punctuation">(</span>QuerySet<span class="token punctuation">)</span>的对象数量。
 
<span class="token operator">&lt;</span><span class="token number">11</span><span class="token operator">&gt;</span> first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>              返回第一条记录
 
<span class="token operator">&lt;</span><span class="token number">12</span><span class="token operator">&gt;</span> last<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>               返回最后一条记录
 
<span class="token operator">&lt;</span><span class="token number">13</span><span class="token operator">&gt;</span> exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             如果QuerySet包含数据，就返回<span class="token boolean">True</span>，否则返回<span class="token boolean">False</span>
</code></pre></div><h3 id="返回queryset对象的方法有"><a href="#返回queryset对象的方法有" class="header-anchor">#</a> 返回QuerySet对象的方法有</h3> <ol><li>all()</li> <li>filter()</li> <li>exclude()</li> <li>order_by()</li> <li>reverse()</li> <li>distinct()</li></ol> <h3 id="特殊的queryset"><a href="#特殊的queryset" class="header-anchor">#</a> 特殊的QuerySet</h3> <ol><li>values()    返回一个可迭代的字典序列</li> <li>values_list() 返回一个可迭代的元祖序列</li></ol> <h3 id="返回具体对象的"><a href="#返回具体对象的" class="header-anchor">#</a> 返回具体对象的</h3> <ol><li>get()</li> <li>first()</li> <li>last()</li></ol> <h3 id="返回布尔值的方法有"><a href="#返回布尔值的方法有" class="header-anchor">#</a> 返回布尔值的方法有：</h3> <p>exists()</p> <h3 id="返回数字的方法有"><a href="#返回数字的方法有" class="header-anchor">#</a> 返回数字的方法有</h3> <p>count()</p> <h2 id="其他queryset操作"><a href="#其他queryset操作" class="header-anchor">#</a> 其他QuerySet操作</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">##################################################################</span>
<span class="token comment"># PUBLIC METHODS THAT ALTER ATTRIBUTES AND RETURN A NEW QUERYSET #</span>
<span class="token comment">##################################################################</span>

<span class="token keyword">def</span> <span class="token function">all</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    <span class="token comment"># 获取所有的数据对象</span>

<span class="token keyword">def</span> <span class="token function">filter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token comment"># 条件查询</span>
    <span class="token comment"># 条件可以是：参数，字典，Q</span>

<span class="token keyword">def</span> <span class="token function">exclude</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token comment"># 条件查询</span>
    <span class="token comment"># 条件可以是：参数，字典，Q</span>

<span class="token keyword">def</span> <span class="token function">select_related</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>fields<span class="token punctuation">)</span>
    性能相关：表之间进行join连表操作，一次性获取关联的数据。

    总结：
    <span class="token number">1</span><span class="token punctuation">.</span> select_related主要针一对一和多对一关系进行优化。
    <span class="token number">2</span><span class="token punctuation">.</span> select_related使用SQL的JOIN语句进行优化，通过减少SQL查询的次数来进行优化、提高性能。

<span class="token keyword">def</span> <span class="token function">prefetch_related</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>lookups<span class="token punctuation">)</span>
    性能相关：多表连表操作时速度会慢，使用其执行多次SQL查询在Python代码中实现连表操作。

    总结：
    <span class="token number">1</span><span class="token punctuation">.</span> 对于多对多字段（ManyToManyField）和一对多字段，可以使用prefetch_related<span class="token punctuation">(</span><span class="token punctuation">)</span>来进行优化。
    <span class="token number">2</span><span class="token punctuation">.</span> prefetch_related<span class="token punctuation">(</span><span class="token punctuation">)</span>的优化方式是分别查询每个表，然后用Python处理他们之间的关系。

<span class="token keyword">def</span> <span class="token function">annotate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token comment"># 用于实现聚合group by查询</span>

    <span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Count<span class="token punctuation">,</span> Avg<span class="token punctuation">,</span> Max<span class="token punctuation">,</span> Min<span class="token punctuation">,</span> Sum

    v <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">'u_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>uid<span class="token operator">=</span>Count<span class="token punctuation">(</span><span class="token string">'u_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># SELECT u_id, COUNT(ui) AS `uid` FROM UserInfo GROUP BY u_id</span>

    v <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">'u_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>uid<span class="token operator">=</span>Count<span class="token punctuation">(</span><span class="token string">'u_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>uid__gt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># SELECT u_id, COUNT(ui_id) AS `uid` FROM UserInfo GROUP BY u_id having count(u_id) &gt; 1</span>

    v <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">'u_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>uid<span class="token operator">=</span>Count<span class="token punctuation">(</span><span class="token string">'u_id'</span><span class="token punctuation">,</span>distinct<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>uid__gt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># SELECT u_id, COUNT( DISTINCT ui_id) AS `uid` FROM UserInfo GROUP BY u_id having count(u_id) &gt; 1</span>

<span class="token keyword">def</span> <span class="token function">distinct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>field_names<span class="token punctuation">)</span>
    <span class="token comment"># 用于distinct去重</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">'nid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># select distinct nid from userinfo</span>

    注：只有在PostgreSQL中才能使用distinct进行去重

<span class="token keyword">def</span> <span class="token function">order_by</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>field_names<span class="token punctuation">)</span>
    <span class="token comment"># 用于排序</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-id'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">extra</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> select<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> where<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> tables<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> order_by<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> select_params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token comment"># 构造额外的查询条件或者映射，如：子查询</span>

    Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'new_id'</span><span class="token punctuation">:</span> <span class="token string">&quot;select col from sometable where othercol &gt; %s&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> select_params<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>where<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'headline=%s'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Lennon'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>where<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;foo='a' OR bar = 'a'&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;baz = 'a'&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>extra<span class="token punctuation">(</span>select<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'new_id'</span><span class="token punctuation">:</span> <span class="token string">&quot;select id from tb where id &gt; %s&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> select_params<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order_by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'-nid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

 <span class="token keyword">def</span> <span class="token function">reverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 倒序</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-nid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 注：如果存在order_by，reverse则是倒序，如果多个排序则一一倒序</span>


 <span class="token keyword">def</span> <span class="token function">defer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>fields<span class="token punctuation">)</span><span class="token punctuation">:</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>defer<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span><span class="token string">'id'</span><span class="token punctuation">)</span>
    或
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>defer<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span><span class="token string">'id'</span><span class="token punctuation">)</span>
    <span class="token comment">#映射中排除某列数据</span>

 <span class="token keyword">def</span> <span class="token function">only</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>fields<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#仅取某个表中的数据</span>
     models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>only<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span><span class="token string">'id'</span><span class="token punctuation">)</span>
     或
     models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>only<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span><span class="token string">'id'</span><span class="token punctuation">)</span>

 <span class="token keyword">def</span> <span class="token function">using</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">:</span>
     指定使用的数据库，参数为别名（setting中的设置）


<span class="token comment">##################################################</span>
<span class="token comment"># PUBLIC METHODS THAT RETURN A QUERYSET SUBCLASS #</span>
<span class="token comment">##################################################</span>

<span class="token keyword">def</span> <span class="token function">raw</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_query<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> translations<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> using<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 执行原生SQL</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'select * from userinfo'</span><span class="token punctuation">)</span>

    <span class="token comment"># 如果SQL是其他表时，必须将名字设置为当前UserInfo对象的主键列名</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'select id as nid from 其他表'</span><span class="token punctuation">)</span>

    <span class="token comment"># 为原生SQL设置参数</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'select id as nid from userinfo where nid&gt;%s'</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 将获取的到列名转换为指定列名</span>
    name_map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'first'</span><span class="token punctuation">:</span> <span class="token string">'first_name'</span><span class="token punctuation">,</span> <span class="token string">'last'</span><span class="token punctuation">:</span> <span class="token string">'last_name'</span><span class="token punctuation">,</span> <span class="token string">'bd'</span><span class="token punctuation">:</span> <span class="token string">'birth_date'</span><span class="token punctuation">,</span> <span class="token string">'pk'</span><span class="token punctuation">:</span> <span class="token string">'id'</span><span class="token punctuation">}</span>
    Person<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'SELECT * FROM some_other_table'</span><span class="token punctuation">,</span> translations<span class="token operator">=</span>name_map<span class="token punctuation">)</span>

    <span class="token comment"># 指定数据库</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'select * from userinfo'</span><span class="token punctuation">,</span> using<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">################### 原生SQL ###################</span>
    <span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> connection<span class="token punctuation">,</span> connections
    cursor <span class="token operator">=</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># cursor = connections['default'].cursor()</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;SELECT * from auth_user where id = %s&quot;&quot;&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    row <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># fetchall()/fetchmany(..)</span>


<span class="token keyword">def</span> <span class="token function">values</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>fields<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取每行数据为字典格式</span>

<span class="token keyword">def</span> <span class="token function">values_list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>fields<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取每行数据为元祖</span>

<span class="token keyword">def</span> <span class="token function">dates</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> field_name<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> order<span class="token operator">=</span><span class="token string">'ASC'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据时间进行某一部分进行去重查找并截取指定内容</span>
    <span class="token comment"># kind只能是：&quot;year&quot;（年）, &quot;month&quot;（年-月）, &quot;day&quot;（年-月-日）</span>
    <span class="token comment"># order只能是：&quot;ASC&quot;  &quot;DESC&quot;</span>
    <span class="token comment"># 并获取转换后的时间</span>
        <span class="token operator">-</span> year <span class="token punctuation">:</span> 年<span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>
        <span class="token operator">-</span> month<span class="token punctuation">:</span> 年<span class="token operator">-</span>月<span class="token operator">-</span><span class="token number">01</span>
        <span class="token operator">-</span> day  <span class="token punctuation">:</span> 年<span class="token operator">-</span>月<span class="token operator">-</span>日

    models<span class="token punctuation">.</span>DatePlus<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>dates<span class="token punctuation">(</span><span class="token string">'ctime'</span><span class="token punctuation">,</span><span class="token string">'day'</span><span class="token punctuation">,</span><span class="token string">'DESC'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">datetimes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> field_name<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> order<span class="token operator">=</span><span class="token string">'ASC'</span><span class="token punctuation">,</span> tzinfo<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据时间进行某一部分进行去重查找并截取指定内容，将时间转换为指定时区时间</span>
    <span class="token comment"># kind只能是 &quot;year&quot;, &quot;month&quot;, &quot;day&quot;, &quot;hour&quot;, &quot;minute&quot;, &quot;second&quot;</span>
    <span class="token comment"># order只能是：&quot;ASC&quot;  &quot;DESC&quot;</span>
    <span class="token comment"># tzinfo时区对象</span>
    models<span class="token punctuation">.</span>DDD<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>datetimes<span class="token punctuation">(</span><span class="token string">'ctime'</span><span class="token punctuation">,</span><span class="token string">'hour'</span><span class="token punctuation">,</span>tzinfo<span class="token operator">=</span>pytz<span class="token punctuation">.</span>UTC<span class="token punctuation">)</span>
    models<span class="token punctuation">.</span>DDD<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>datetimes<span class="token punctuation">(</span><span class="token string">'ctime'</span><span class="token punctuation">,</span><span class="token string">'hour'</span><span class="token punctuation">,</span>tzinfo<span class="token operator">=</span>pytz<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span><span class="token string">'Asia/Shanghai'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    pip3 install pytz
    import pytz
    pytz.all_timezones
    pytz.timezone(‘Asia/Shanghai’)
    &quot;&quot;&quot;</span>

<span class="token keyword">def</span> <span class="token function">none</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 空QuerySet对象</span>


<span class="token comment">####################################</span>
<span class="token comment"># METHODS THAT DO DATABASE QUERIES #</span>
<span class="token comment">####################################</span>

<span class="token keyword">def</span> <span class="token function">aggregate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 聚合函数，获取字典类型聚合结果</span>
   <span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Count<span class="token punctuation">,</span> Avg<span class="token punctuation">,</span> Max<span class="token punctuation">,</span> Min<span class="token punctuation">,</span> Sum
   result <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>k<span class="token operator">=</span>Count<span class="token punctuation">(</span><span class="token string">'u_id'</span><span class="token punctuation">,</span> distinct<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token operator">=</span>Count<span class="token punctuation">(</span><span class="token string">'nid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token string">'k'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 获取个数</span>

<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 获取单个对象</span>

<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 创建对象</span>

<span class="token keyword">def</span> <span class="token function">bulk_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> objs<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 批量插入</span>
    <span class="token comment"># batch_size表示一次插入的个数</span>
    objs <span class="token operator">=</span> <span class="token punctuation">[</span>
        models<span class="token punctuation">.</span>DDD<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'r11'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        models<span class="token punctuation">.</span>DDD<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'r22'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    models<span class="token punctuation">.</span>DDD<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>bulk_create<span class="token punctuation">(</span>objs<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_or_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 如果存在，则获取，否则，创建</span>
    <span class="token comment"># defaults 指定创建时，其他字段的值</span>
    obj<span class="token punctuation">,</span> created <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_or_create<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'root1'</span><span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'1111111'</span><span class="token punctuation">,</span><span class="token string">'u_id'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'t_id'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">update_or_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 如果存在，则更新，否则，创建</span>
    <span class="token comment"># defaults 指定创建时或更新时的其他字段</span>
    obj<span class="token punctuation">,</span> created <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>update_or_create<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'root1'</span><span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'1111111'</span><span class="token punctuation">,</span><span class="token string">'u_id'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'t_id'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">first</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 获取第一个</span>

<span class="token keyword">def</span> <span class="token function">last</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 获取最后一个</span>

<span class="token keyword">def</span> <span class="token function">in_bulk</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> id_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 根据主键ID进行查找</span>
   id_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">]</span>
   models<span class="token punctuation">.</span>DDD<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>in_bulk<span class="token punctuation">(</span>id_list<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 删除</span>

<span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 更新</span>

<span class="token keyword">def</span> <span class="token function">exists</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 是否有结果</span>
</code></pre></div><h2 id="单表查询之神奇的双下划线"><a href="#单表查询之神奇的双下划线" class="header-anchor">#</a> 单表查询之神奇的双下划线</h2> <h3 id="统计"><a href="#统计" class="header-anchor">#</a> 统计</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 统计</span>
<span class="token comment">#</span>
<span class="token comment"># models.Tb1.objects.filter(name='seven').count()</span>
</code></pre></div><h3 id="大于、大于等于、小于、小于等于"><a href="#大于、大于等于、小于、小于等于" class="header-anchor">#</a> 大于、大于等于、小于、小于等于</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 大于，小于</span>
<span class="token comment">#</span>
<span class="token comment"># models.Tb1.objects.filter(id__gt=1)              # 获取id大于1的值</span>
<span class="token comment"># models.Tb1.objects.filter(id__gte=1)              # 获取id大于等于1的值</span>
<span class="token comment"># models.Tb1.objects.filter(id__lt=10)             # 获取id小于10的值</span>
<span class="token comment"># models.Tb1.objects.filter(id__lte=10)             # 获取id小于10的值</span>
<span class="token comment"># models.Tb1.objects.filter(id__lt=10, id__gt=1)   # 获取id大于1 且 小于10的值</span>
</code></pre></div><h3 id="成员判断-in"><a href="#成员判断-in" class="header-anchor">#</a> 成员判断 - in</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 成员判断in</span>
<span class="token comment">#</span>
<span class="token comment"># models.Tb1.objects.filter(id__in=[11, 22, 33])   # 获取id等于11、22、33的数据</span>
<span class="token comment"># models.Tb1.objects.exclude(id__in=[11, 22, 33])  # not in</span>
</code></pre></div><h3 id="是否为空-isnull"><a href="#是否为空-isnull" class="header-anchor">#</a> 是否为空 isnull</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 是否为空 isnull</span>
<span class="token comment"># Entry.objects.filter(pub_date__isnull=True)  ## 查看字段为空的行，如果是false，就查看数据不为空的行</span>
</code></pre></div><h3 id="查询是否有包含指定的值"><a href="#查询是否有包含指定的值" class="header-anchor">#</a> 查询是否有包含指定的值</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 包括contains</span>
<span class="token comment">#</span>
<span class="token comment"># models.Tb1.objects.filter(name__contains=&quot;ven&quot;)</span>
<span class="token comment"># models.Tb1.objects.filter(name__icontains=&quot;ven&quot;) # icontains大小写不敏感</span>
<span class="token comment"># models.Tb1.objects.exclude(name__icontains=&quot;ven&quot;)</span>

<span class="token comment"># 其他类似</span>
<span class="token comment"># startswith， ## 什么什么开头</span>
<span class="token comment"># istartswith,  ## 什么什么开头，大小写不敏感</span>
<span class="token comment"># endswith, ## 什么什么结尾</span>
<span class="token comment"># iendswith, ## 什么什么结尾，大小写不敏感</span>
</code></pre></div><h3 id="查询指定范围的行数"><a href="#查询指定范围的行数" class="header-anchor">#</a> 查询指定范围的行数</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 范围range</span>
<span class="token comment">#</span>
<span class="token comment"># models.Tb1.objects.filter(id__range=[1, 2])   # 范围bettwen and</span>
</code></pre></div><h3 id="分组group-by"><a href="#分组group-by" class="header-anchor">#</a> 分组group by</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 分组group by</span>
<span class="token comment">#</span>
<span class="token comment"># from django.db.models import Count, Min, Max, Sum</span>
<span class="token comment"># models.Tb1.objects.filter(c1=1).values('id').annotate(c=Count('num'))</span>
<span class="token comment"># SELECT &quot;app01_tb1&quot;.&quot;id&quot;, COUNT(&quot;app01_tb1&quot;.&quot;num&quot;) AS &quot;c&quot; FROM &quot;app01_tb1&quot; WHERE &quot;app01_tb1&quot;.&quot;c1&quot; = 1 GROUP BY &quot;app01_tb1&quot;.&quot;id&quot;</span>
</code></pre></div><h3 id="排序-倒序"><a href="#排序-倒序" class="header-anchor">#</a> 排序 - 倒序</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 排序order by</span>
<span class="token comment">#</span>
<span class="token comment"># models.Tb1.objects.filter(name='seven').order_by('id')    # asc 排序</span>
<span class="token comment"># models.Tb1.objects.filter(name='seven').order_by('-id')   # desc 倒序</span>
</code></pre></div><h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># limit 、offset</span>
<span class="token comment">#</span>
<span class="token comment"># models.Tb1.objects.all()[10:20]</span>

<span class="token comment"># regex正则匹配，iregex 不区分大小写</span>
<span class="token comment">#</span>
<span class="token comment"># Entry.objects.get(title__regex=r'^(An?|The) +')</span>
<span class="token comment"># Entry.objects.get(title__iregex=r'^(an?|the) +')</span>

<span class="token comment"># date</span>
<span class="token comment">#</span>
<span class="token comment"># Entry.objects.filter(pub_date__date=datetime.date(2005, 1, 1))</span>
<span class="token comment"># Entry.objects.filter(pub_date__date__gt=datetime.date(2005, 1, 1))</span>

<span class="token comment"># year</span>
<span class="token comment">#</span>
<span class="token comment"># Entry.objects.filter(pub_date__year=2005)</span>
<span class="token comment"># Entry.objects.filter(pub_date__year__gte=2005)</span>

<span class="token comment"># month</span>
<span class="token comment">#</span>
<span class="token comment"># Entry.objects.filter(pub_date__month=12)</span>
<span class="token comment"># Entry.objects.filter(pub_date__month__gte=6)</span>

<span class="token comment"># day</span>
<span class="token comment">#</span>
<span class="token comment"># Entry.objects.filter(pub_date__day=3)</span>
<span class="token comment"># Entry.objects.filter(pub_date__day__gte=3)</span>

<span class="token comment"># week_day</span>
<span class="token comment">#</span>
<span class="token comment"># Entry.objects.filter(pub_date__week_day=2)</span>
<span class="token comment"># Entry.objects.filter(pub_date__week_day__gte=2)</span>

<span class="token comment"># hour</span>
<span class="token comment">#</span>
<span class="token comment"># Event.objects.filter(timestamp__hour=23)</span>
<span class="token comment"># Event.objects.filter(time__hour=5)</span>
<span class="token comment"># Event.objects.filter(timestamp__hour__gte=12)</span>

<span class="token comment"># minute</span>
<span class="token comment">#</span>
<span class="token comment"># Event.objects.filter(timestamp__minute=29)</span>
<span class="token comment"># Event.objects.filter(time__minute=46)</span>
<span class="token comment"># Event.objects.filter(timestamp__minute__gte=29)</span>

<span class="token comment"># second</span>
<span class="token comment">#</span>
<span class="token comment"># Event.objects.filter(timestamp__second=31)</span>
<span class="token comment"># Event.objects.filter(time__second=2)</span>
<span class="token comment"># Event.objects.filter(timestamp__second__gte=31)</span>
</code></pre></div><h1 id="foreignkey-操作-一对多或多对一-外键"><a href="#foreignkey-操作-一对多或多对一-外键" class="header-anchor">#</a> ForeignKey 操作 - 一对多或多对一 (外键)</h1> <h2 id="正向查找"><a href="#正向查找" class="header-anchor">#</a> <strong>正向查找</strong></h2> <h3 id="对象查找-跨表"><a href="#对象查找-跨表" class="header-anchor">#</a> 对象查找（跨表）</h3> <p>语法：对象.关联字段.字段</p> <div class="language-python extra-class"><pre class="language-python"><code>book_obj <span class="token operator">=</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 第一本书对象</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>book_obj<span class="token punctuation">.</span>publisher<span class="token punctuation">)</span>  <span class="token comment"># 得到这本书关联的出版社对象 </span>
<span class="token keyword">print</span><span class="token punctuation">(</span>book_obj<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># 得到出版社对象的名称</span>
</code></pre></div><h3 id="字段查找-跨表"><a href="#字段查找-跨表" class="header-anchor">#</a> 字段查找（跨表）</h3> <p>语法：关联字段__字段</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">&quot;publisher__name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>publisher__name<span class="token operator">=</span><span class="token string">'出版社'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">## 查询出版社表中的name字段中是否为出版社值</span>
</code></pre></div><h2 id="反向操作"><a href="#反向操作" class="header-anchor">#</a> <strong>反向操作</strong></h2> <h3 id="对象查找"><a href="#对象查找" class="header-anchor">#</a> 对象查找</h3> <p>语法：obj.表名_set</p> <div class="language-python extra-class"><pre class="language-python"><code>publisher_obj <span class="token operator">=</span> models<span class="token punctuation">.</span>Publisher<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 找到第一个出版社对象</span>
books <span class="token operator">=</span> publisher_obj<span class="token punctuation">.</span>book_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 找到第一个出版社出版的所有书</span>
titles <span class="token operator">=</span> books<span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 找到第一个出版社出版的所有书的书名</span>
</code></pre></div><h3 id="字段查找"><a href="#字段查找" class="header-anchor">#</a> 字段查找</h3> <p>语法：表名__字段</p> <div class="language-python extra-class"><pre class="language-python"><code>titles <span class="token operator">=</span> models<span class="token punctuation">.</span>Publisher<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">&quot;book__title&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="manytomanyfield操作-多对多"><a href="#manytomanyfield操作-多对多" class="header-anchor">#</a> ManyToManyField操作 - 多对多</h1> <p>&quot;关联管理器&quot;是在一对多或者多对多的关联上下文中使用的管理器。</p> <p>它存在于下面两种情况：</p> <ol><li>外键关系的反向查询</li> <li>多对多关联关系</li></ol> <p>简单来说就是当 点后面的对象 可能存在多个的时候就可以使用以下的方法。</p> <h2 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> <strong>使用方法</strong></h2> <h3 id="create-创建一个新的对象"><a href="#create-创建一个新的对象" class="header-anchor">#</a> create() - 创建一个新的对象</h3> <p>创建一个新的对象，保存对象，并将它添加到关联对象集之中，返回新创建的对象。</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; import datetime
&gt;&gt;&gt; models.Author.objects.first().book_set.create(title=&quot;番茄物语&quot;, publish_date=datetime.date.today())
</code></pre></div><h3 id="add-添加对象"><a href="#add-添加对象" class="header-anchor">#</a> add() - 添加对象</h3> <p>把指定的model对象添加到关联对象集中。</p> <p><strong>添加对象</strong></p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; author_objs = models.Author.objects.filter(id__lt=3)
&gt;&gt;&gt; models.Book.objects.first().authors.add(*author_objs)
</code></pre></div><p><strong>添加id</strong></p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; models.Book.objects.first().authors.add(*[1, 2])
</code></pre></div><h3 id="set-更新model对象的关联对象"><a href="#set-更新model对象的关联对象" class="header-anchor">#</a> set() - 更新model对象的关联对象</h3> <p>更新model对象的关联对象。</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; book_obj = models.Book.objects.first()
&gt;&gt;&gt; book_obj.authors.set([2, 3])
</code></pre></div><h3 id="remove-关联对象集中移除"><a href="#remove-关联对象集中移除" class="header-anchor">#</a> remove() - 关联对象集中移除</h3> <p>从关联对象集中移除执行的model对象</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; book_obj = models.Book.objects.first()
&gt;&gt;&gt; book_obj.authors.remove(3)
</code></pre></div><h3 id="clear-关联对象集中移除一切对象"><a href="#clear-关联对象集中移除一切对象" class="header-anchor">#</a> clear() - 关联对象集中移除一切对象</h3> <p>从关联对象集中移除一切对象。</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; book_obj = models.Book.objects.first()
&gt;&gt;&gt; book_obj.authors.clear()
</code></pre></div><h4 id="clear-注意事项"><a href="#clear-注意事项" class="header-anchor">#</a> clear() - 注意事项</h4> <p>对于ForeignKey对象，clear()和remove()方法仅在null=True时存在。</p> <p><strong>举个例子：</strong></p> <p>ForeignKey字段没设置null=True时，</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
    publisher <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span>Publisher<span class="token punctuation">)</span>
</code></pre></div><p>没有clear()和remove()方法：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Publisher<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>book_set<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">&quot;&lt;input&gt;&quot;</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
AttributeError<span class="token punctuation">:</span> <span class="token string">'RelatedManager'</span> <span class="token builtin">object</span> has no attribute <span class="token string">'clear'</span>
</code></pre></div><p>当ForeignKey字段设置null=True时，</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
    publisher <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span>Class<span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><p>此时就有clear()和remove()方法：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Publisher<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>book_set<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <p>对于所有类型的关联字段，add()、create()、remove()和clear(),set()都会马上更新数据库。换句话说，在关联的任何一端，都不需要再调用save()方法。</p> <h1 id="聚合查询和分组查询"><a href="#聚合查询和分组查询" class="header-anchor">#</a> 聚合查询和分组查询</h1> <h2 id="聚合"><a href="#聚合" class="header-anchor">#</a> 聚合</h2> <p><code>aggregate()</code>是<code>QuerySet</code> 的一个终止子句，所以<code>aggregate()</code>方法只能放在ORM语句的最后，返回一个包含一些键值对的字典。</p> <p>键的名称是聚合值的标识符，值是计算出来的聚合值。键的名称是按照字段和聚合函数的名称自动生成出来的。</p> <p>用到的内置函数：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Avg<span class="token punctuation">,</span> Sum<span class="token punctuation">,</span> Max<span class="token punctuation">,</span> Min<span class="token punctuation">,</span> Count
</code></pre></div><p>示例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Avg<span class="token punctuation">,</span> Sum<span class="token punctuation">,</span> Max<span class="token punctuation">,</span> Min<span class="token punctuation">,</span> Count<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>Avg<span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'price__avg'</span><span class="token punctuation">:</span> <span class="token number">13.233333</span><span class="token punctuation">}</span>
</code></pre></div><p>如果你想要为聚合值指定一个名称，可以向聚合子句提供它。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>average_price<span class="token operator">=</span>Avg<span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'average_price'</span><span class="token punctuation">:</span> <span class="token number">13.233333</span><span class="token punctuation">}</span>
</code></pre></div><p>如果你希望生成不止一个聚合，你可以向<code>aggregate()</code>子句中添加另一个参数。所以，如果你也想知道所有图书价格的最大值和最小值，可以这样查询：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>Avg<span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Max<span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Min<span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'price__avg'</span><span class="token punctuation">:</span> <span class="token number">13.233333</span><span class="token punctuation">,</span> <span class="token string">'price__max'</span><span class="token punctuation">:</span> Decimal<span class="token punctuation">(</span><span class="token string">'19.90'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'price__min'</span><span class="token punctuation">:</span> Decimal<span class="token punctuation">(</span><span class="token string">'9.90'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="分组"><a href="#分组" class="header-anchor">#</a> 分组</h2> <p>我们在这里先复习一下SQL语句的分组。</p> <p>假设现在有一张公司职员表：</p> <p><img src="https://s2.ax1x.com/2019/12/16/Q4DF3T.png" alt="Q4DF3T.png"></p> <p>我们使用原生<strong>SQL语句</strong>，按照部分分组求平均工资：</p> <div class="language-python extra-class"><pre class="language-python"><code>select dept<span class="token punctuation">,</span>AVG<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">from</span> employee group by dept<span class="token punctuation">;</span>
</code></pre></div><p><strong>ORM查询:</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Avg
Employee<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">&quot;dept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>avg<span class="token operator">=</span>Avg<span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span>dept<span class="token punctuation">,</span> <span class="token string">&quot;avg&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>连表查询的分组：</strong></p> <p><img src="https://s2.ax1x.com/2019/12/16/Q4DYbd.png" alt="Q4DYbd.png"></p> <p><strong>SQL查询：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>select dept.name,AVG(salary) from employee inner join dept on (employee.dept_id=dept.id) group by dept_id;
</code></pre></div><p><strong>ORM查询：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>from django.db.models import Avg
models.Dept.objects.annotate(avg=Avg(&quot;employee__salary&quot;)).values(&quot;name&quot;, &quot;avg&quot;)
</code></pre></div><h3 id="更多示例"><a href="#更多示例" class="header-anchor">#</a> 更多示例</h3> <p><strong>示例1：统计每一本书的作者个数</strong></p> <div class="language- extra-class"><pre class="language-text"><code>&gt;&gt;&gt; book_list = models.Book.objects.all().annotate(author_num=Count(&quot;author&quot;))
&gt;&gt;&gt; for obj in book_list:
...     print(obj.author_num)
...
2
1
1
</code></pre></div><p><strong>示例2：统计出每个出版社买的最便宜的书的价格</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> publisher_list <span class="token operator">=</span> models<span class="token punctuation">.</span>Publisher<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>min_price<span class="token operator">=</span>Min<span class="token punctuation">(</span><span class="token string">&quot;book__price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> obj <span class="token keyword">in</span> publisher_list<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>min_price<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     
<span class="token number">9.90</span>
<span class="token number">19.90</span>
</code></pre></div><p>方法二：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">&quot;publisher__name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>min_price<span class="token operator">=</span>Min<span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'publisher__name'</span><span class="token punctuation">:</span> <span class="token string">'沙河出版社'</span><span class="token punctuation">,</span> <span class="token string">'min_price'</span><span class="token punctuation">:</span> Decimal<span class="token punctuation">(</span><span class="token string">'9.90'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'publisher__name'</span><span class="token punctuation">:</span> <span class="token string">'人民出版社'</span><span class="token punctuation">,</span> <span class="token string">'min_price'</span><span class="token punctuation">:</span> Decimal<span class="token punctuation">(</span><span class="token string">'19.90'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre></div><p><strong>示例3：统计不止一个作者的图书</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>author_num<span class="token operator">=</span>Count<span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>author_num__gt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Book<span class="token punctuation">:</span> 番茄物语<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre></div><p><strong>示例4：根据一本图书作者数量的多少对查询集 <code>QuerySet</code>进行排序</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>author_num<span class="token operator">=</span>Count<span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&quot;author_num&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Book<span class="token punctuation">:</span> 香蕉物语<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Book<span class="token punctuation">:</span> 橘子物语<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Book<span class="token punctuation">:</span> 番茄物语<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre></div><p><strong>示例5：查询各个作者出的书的总价格</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Author<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>sum_price<span class="token operator">=</span>Sum<span class="token punctuation">(</span><span class="token string">&quot;book__price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sum_price&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'小精灵'</span><span class="token punctuation">,</span> <span class="token string">'sum_price'</span><span class="token punctuation">:</span> Decimal<span class="token punctuation">(</span><span class="token string">'9.90'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'小仙女'</span><span class="token punctuation">,</span> <span class="token string">'sum_price'</span><span class="token punctuation">:</span> Decimal<span class="token punctuation">(</span><span class="token string">'29.80'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'小魔女'</span><span class="token punctuation">,</span> <span class="token string">'sum_price'</span><span class="token punctuation">:</span> Decimal<span class="token punctuation">(</span><span class="token string">'9.90'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre></div><h1 id="f查询和q查询"><a href="#f查询和q查询" class="header-anchor">#</a> F查询和Q查询</h1> <h2 id="f查询"><a href="#f查询" class="header-anchor">#</a> F查询</h2> <p>在上面所有的例子中，我们构造的过滤器都只是将字段值与某个常量做比较。如果我们要对两个字段的值做比较，那该怎么做呢？</p> <p>Django 提供 F() 来做这样的比较。F() 的实例可以在查询中引用字段，来比较同一个 model 实例中两个不同字段的值。</p> <p><strong>查询评论数大于收藏数的书籍</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> F
models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>commnet_num__gt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'keep_num'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>Django 支持 F() 对象之间以及 F() 对象和常数之间的加减乘除和取模的操作。</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>commnet_num__lt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'keep_num'</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>修改操作也可以使用F函数,比如将每一本书的价格提高30元</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>price<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>引申：</strong></p> <p>如果要修改char字段咋办？</p> <p>如：把所有书名后面加上(第一版)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models<span class="token punctuation">.</span>functions <span class="token keyword">import</span> Concat
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Value
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>title<span class="token operator">=</span>Concat<span class="token punctuation">(</span>F<span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Value<span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Value<span class="token punctuation">(</span><span class="token string">&quot;第一版&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Value<span class="token punctuation">(</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="q查询"><a href="#q查询" class="header-anchor">#</a> Q查询</h2> <p><code>filter()</code> 等方法中的关键字参数查询都是一起进行“AND” 的。 如果你需要执行更复杂的查询（例如<code>OR</code>语句），你可以使用<code>Q对象</code>。</p> <p><strong>查询作者名是小仙女或小魔女的</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>authors__name<span class="token operator">=</span><span class="token string">&quot;小仙女&quot;</span><span class="token punctuation">)</span><span class="token operator">|</span>Q<span class="token punctuation">(</span>authors__name<span class="token operator">=</span><span class="token string">&quot;小魔女&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>你可以组合<code>&amp;</code> 和<code>|</code> 操作符以及使用括号进行分组来编写任意复杂的<code>Q</code> 对象。同时，<code>Q</code> 对象可以使用<code>~</code> 操作符取反，这允许组合正常的查询和取反(<code>NOT</code>) 查询。</p> <p><strong>示例：查询作者名字是小仙女并且不是2018年出版的书的书名。</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>author__name<span class="token operator">=</span><span class="token string">&quot;小仙女&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>Q<span class="token punctuation">(</span>publish_date__year<span class="token operator">=</span><span class="token number">2018</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'番茄物语'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre></div><p>查询函数可以混合使用<code>Q 对象</code>和关键字参数。所有提供给查询函数的参数（关键字参数或<code>Q</code> 对象）都将&quot;AND”在一起。但是，如果出现<code>Q</code> 对象，它必须位于所有关键字参数的前面。</p> <p><strong>例如：查询出版年份是2017或2018，书名中带物语的所有书。</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>publish_date__year<span class="token operator">=</span><span class="token number">2018</span><span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>publish_date__year<span class="token operator">=</span><span class="token number">2017</span><span class="token punctuation">)</span><span class="token punctuation">,</span> title__icontains<span class="token operator">=</span><span class="token string">&quot;物语&quot;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Book<span class="token punctuation">:</span> 番茄物语<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Book<span class="token punctuation">:</span> 香蕉物语<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Book<span class="token punctuation">:</span> 橘子物语<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre></div><h1 id="锁和事务"><a href="#锁和事务" class="header-anchor">#</a> 锁和事务</h1> <h2 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h2> <p>select_for_update(nowait=False, skip_locked=False)</p> <p>返回一个锁住行直到事务结束的查询集，如果数据库支持，它将生成一个 SELECT ... FOR UPDATE 语句。</p> <div class="language-python extra-class"><pre class="language-python"><code>entries <span class="token operator">=</span> Entry<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_for_update<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>author<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
</code></pre></div><p>所有匹配的行将被锁定，直到事务结束。这意味着可以通过锁防止数据被其它事务修改。</p> <p>一般情况下如果其他事务锁定了相关行，那么本查询将被阻塞，直到锁被释放。 如果这不想要使查询阻塞的话，使用select_for_update(nowait=True)。</p> <p>如果其它事务持有冲突的锁, 那么查询将引发 DatabaseError 异常。</p> <p>你也可以使用select_for_update(skip_locked=True)忽略锁定的行。</p> <p>nowait和skip_locked是互斥的，同时设置会导致ValueError。</p> <p>目前，postgresql，oracle和mysql数据库后端支持select_for_update()。</p> <p>但是，MySQL不支持nowait和skip_locked参数。</p> <p>使用不支持这些选项的数据库后端（如MySQL）将nowait=True或skip_locked=True转换为select_for_update()将导致抛出DatabaseError异常，这可以防止代码意外终止。</p> <h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BMS.settings&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> django
    django<span class="token punctuation">.</span>setup<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">import</span> datetime
    <span class="token keyword">from</span> pusn <span class="token keyword">import</span> models

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment">## 这里写事务代码逻辑</span>
        <span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> transaction
        <span class="token keyword">with</span> transaction<span class="token punctuation">.</span>atomic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            new_publisher <span class="token operator">=</span> models<span class="token punctuation">.</span>Publisher<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;火星出版社&quot;</span><span class="token punctuation">)</span>
            models<span class="token punctuation">.</span>Book<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">&quot;橘子物语&quot;</span><span class="token punctuation">,</span> publish_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publisher_id<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 指定一个不存在的出版社id</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="其他鲜为人知的操作-有个印象即可"><a href="#其他鲜为人知的操作-有个印象即可" class="header-anchor">#</a> 其他鲜为人知的操作（有个印象即可）</h1> <h2 id="django-orm执行原生sql"><a href="#django-orm执行原生sql" class="header-anchor">#</a> Django ORM执行原生SQL</h2> <p>在模型查询API不够用的情况下，我们还可以使用原始的SQL语句进行查询。</p> <p>Django 提供两种方法使用原始SQL进行查询：一种是使用raw()方法，进行原始SQL查询并返回模型实例；另一种是完全避开模型层，直接执行自定义的SQL语句。</p> <h3 id="执行原生查询"><a href="#执行原生查询" class="header-anchor">#</a> 执行原生查询</h3> <p>raw()管理器方法用于原始的SQL查询，并返回模型的实例：</p> <p><em>注意：raw()语法查询必须包含主键。</em></p> <p>这个方法执行原始的SQL查询，并返回一个django.db.models.query.RawQuerySet 实例。 这个RawQuerySet 实例可以像一般的QuerySet那样，通过迭代来提供对象实例。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    first_name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    last_name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    birth_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p>可以像下面这样执行原生SQL语句</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> Person<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'SELECT * FROM myapp_person'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
</code></pre></div><p>raw()查询可以查询其他表的数据。</p> <div class="language- extra-class"><pre class="language-text"><code>ret = models.Student.objects.raw('select id, tname as hehe from app02_teacher')
    for i in ret:python
        print(i.id, i.hehe)
</code></pre></div><p>raw()方法自动将查询字段映射到模型字段。还可以通过translations参数指定一个把查询的字段名和ORM对象实例的字段名互相对应的字典</p> <div class="language-python extra-class"><pre class="language-python"><code>d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'tname'</span><span class="token punctuation">:</span> <span class="token string">'haha'</span><span class="token punctuation">}</span>
    ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'select * from app02_teacher'</span><span class="token punctuation">,</span> translations<span class="token operator">=</span>d<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> ret<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>sname<span class="token punctuation">,</span> i<span class="token punctuation">.</span>haha<span class="token punctuation">)</span>
</code></pre></div><p>原生SQL还可以使用参数，注意不要自己使用字符串格式化拼接SQL语句，防止SQL注入！</p> <div class="language-python extra-class"><pre class="language-python"><code>d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'tname'</span><span class="token punctuation">:</span> <span class="token string">'haha'</span><span class="token punctuation">}</span>
    ret <span class="token operator">=</span> models<span class="token punctuation">.</span>Student<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>raw<span class="token punctuation">(</span><span class="token string">'select * from app02_teacher where id &gt; %s'</span><span class="token punctuation">,</span> translations<span class="token operator">=</span>d<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> ret<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>sname<span class="token punctuation">,</span> i<span class="token punctuation">.</span>haha<span class="token punctuation">)</span>
</code></pre></div><h3 id="直接执行自定义sql"><a href="#直接执行自定义sql" class="header-anchor">#</a> 直接执行自定义SQL</h3> <p>有时候raw()方法并不十分好用，很多情况下我们不需要将查询结果映射成模型，或者我们需要执行DELETE、 INSERT以及UPDATE操作。在这些情况下，我们可以直接访问数据库，完全避开模型层。</p> <p>我们可以直接从django提供的接口中获取数据库连接，然后像使用pymysql模块一样操作数据库。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> connection<span class="token punctuation">,</span> connections
cursor <span class="token operator">=</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># cursor = connections['default'].cursor()</span>
cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;SELECT * from auth_user where id = %s&quot;&quot;&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ret <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/7. Python-Django/79. Django模型(ORM) 认识、字段.html" class="prev">
        79. Django模型(ORM) 认识、字段
      </a></span> <span class="next"><a href="/Python/7. Python-Django/81. Django - Cookie、Session、自定义分页.html">
        81. Django - Cookie、Session、自定义分页
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d65bef42.js" defer></script><script src="/assets/js/2.2249178e.js" defer></script><script src="/assets/js/153.98dd0727.js" defer></script>
  </body>
</html>
